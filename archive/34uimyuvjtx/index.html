<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Redux状态管理之痛点、分析与改良"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Redux状态管理之痛点、分析与改良 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/34uimyuvjtx/",
				"appid": "1613049289050283", 
				"title": "Redux状态管理之痛点、分析与改良 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-14T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/mxax4qbcjii/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/qlqfbahle1n/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&text=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&text=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&title=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&is_video=false&description=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&title=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&title=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&title=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f34uimyuvjtx%2f&title=Redux%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e4%b9%8b%e7%97%9b%e7%82%b9%e3%80%81%e5%88%86%e6%9e%90%e4%b8%8e%e6%94%b9%e8%89%af"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Redux状态管理之痛点、分析与改良</h1><div class="meta"><div class="postdate"><time datetime="2019-01-14" itemprop="datePublished">2019-01-14</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e\x3cp\x3e如何设计Redux的store？\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e这几乎是Redux在实践中被问到最多的问题，或许你有自己的方式，却总觉得哪里不太对劲。这篇文章希望从状态是什么，到Elm中的状态管理，最后与Redux分析和对比，试图找到问题，并推导可行的改良方式。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e哪些状态需要被管理？\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3eDomain data\x3c\/h3\x3e\n\x3cp\x3eDomain data非常好理解，他们直接来源于服务端对领域模型的抽象，比如user、product。它们可能被应用的多个地方用到，比如当前user包含的权限信息所有涉及鉴权的地方都需要。\x3c\/p\x3e\n\x3cp\x3e通常，前端对Domain data最大的管理需求是和服务端保持同步，不会有频繁和复杂的变更——如果有的话请考虑合并批处理和转移复杂度到服务端。\x3c\/p\x3e\n\x3cp\x3e甚至有不少页面仅在初始化时获取一次Domain data，从此就再无瓜葛，直到跳转到下一个页面。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3eUI state\x3c\/h3\x3e\n\x3cp\x3e决定当前UI如何展示的状态，比如一个弹窗的开闭，下拉菜单是否打开。\x3c\/p\x3e\n\x3cp\x3e在我看来，UI state是前端真正开始复杂的部分——如果仅仅依靠服务端拿下来的Domain data就能做好前端，backbone的\x3ca href=\x22http:\/\/backbonejs.org\/#Model\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eModel\x3c\/a\x3e早就一统江湖了，没后来者们什么事情。\x3c\/p\x3e\n\x3cp\x3e和Domain data的简单、稳定不同，UI state是多变，不稳定的——不同的页面有不同、甚至相似但又细微不同的展现和交互。\x3c\/p\x3e\n\x3cp\x3e同时，UI state之间也是互相影响的，比如选择列表中的元素(选中状态是ui state)，当选中数量低于N时禁用提交按钮(按钮是否禁用也是ui state)。这是前端工作中非常常见的需求，整个场景中没有Domain data出现。\x3c\/p\x3e\n\x3cp\x3eUI state多变、不稳定，但它仍然是需要被复用的。小到弹窗的开闭，大到表单的管理，他们的逻辑都是明显可被抽象的。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3eApp state *\x3c\/h3\x3e\n\x3cp\x3eApp级的状态，例如当前是否有请求正在加载。\x3cstrong\x3e个人倾向将它们视为另一种抽象角度下的UI state\x3c\/strong\x3e。因为本质上它们仍然是服务于UI的：一个异步下拉框会发请求，加载页面主要信息也会发请求，而我们通常希望前者加载时只disable下拉框，而后者可能要用Loading mask遮罩整个页面——场景不同，对状态的需求就不同，单纯关注\x3ccode\x3e当前是否有请求正在加载\x3c\/code\x3e没有意义，只有与UI场景结合才会产生价值，因此我倾向认为App state的本质是对UI state的再抽象。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3eRedux社区的主流实践\x3c\/h2\x3e\n\x3cp\x3e由Redux库贡献者之一维护的\x3ca href=\x22https:\/\/github.com\/markerikson\/redux\/blob\/structuring-reducers-page\/docs\/recipes\/reducers\/01-BasicReducerStructure.md\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3erecipes\x3c\/a\x3e提到了\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eBecause the store represents the core of your application, you should \x3cstrong\x3e define your state shape in terms of your domain data and app state, not your UI component tree.\x3c\/strong\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e这基本代表了如今社区的主流实践，它包含了两个主要观点：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eStore代表了\x3cstrong\x3e应用\x3c\/strong\x3e的状态(store represents the core of your application)\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e使用domain data和app state作为store的主要抽象依据\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e很少有人质疑过这两点的正确性，因为第一点和Flux社区一脉相承，第二点无论看起来还是写起代码来都显得顺理成章。\x3c\/p\x3e\n\x3cp\x3e有没有可能这两点才是Redux实践的问题所在？\x3c\/p\x3e\n\x3cp\x3e在往下讨论之前，不妨看看Redux最重要的借鉴对象——Elm是如何管理状态的。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3eElm 中的状态树\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3eElm简介\x3c\/h3\x3e\n\x3cp\x3e先用一张图表达Elm的架构：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009540498\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009540498\x22 alt=\x22elm\x22 title=\x22elm\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e图：\x3ca href=\x22https:\/\/staltz.com\/unidirectional-user-interface-architectures.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/staltz.com\/unidirecti...\x3c\/a\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e结合代码往下看，首先在Elm中定义一个组件Counter，没有Elm相关基础也没关系，可以结合注释理解大概即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\n-- 定义数据模型\ntype alias Model = Int\n\n-- 定义消息\ntype Msg = Increment | Decrement\n\n-- 定义更新函数\nupdate : Msg -\x3e Model -\x3e Model\nupdate msg model =\n  case msg of\n    Increment -\x3e\n      model \x2b 1\n    Decrement -\x3e\n      model - 1\n\n-- 定义渲染函数\nview : Model -\x3e Html Msg\nview model =\n  div []\n    [ button [onClick Decrement] [text \x26quot;-\x26quot;]\n    , text (toString model)\n    , button [onClick Increment] [text \x26quot;\x2b\x26quot;]\n  ]\n\n-- 定义初始数据\ninitModel : Model\ninitModel = 3\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22elm hljs\x22\x3e\x3ccode class=\x22elm\x22\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e-- 定义数据模型\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ealias\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e = \x3cspan class=\x22hljs-type\x22\x3eInt\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 定义消息\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e = \x3cspan class=\x22hljs-type\x22\x3eIncrement\x3c\/span\x3e | \x3cspan class=\x22hljs-type\x22\x3eDecrement\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 定义更新函数\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eupdate\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eupdate\x3c\/span\x3e msg model =\n  \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e msg \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e\n    \x3cspan class=\x22hljs-type\x22\x3eIncrement\x3c\/span\x3e -\x26gt;\n      model \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\n    \x3cspan class=\x22hljs-type\x22\x3eDecrement\x3c\/span\x3e -\x26gt;\n      model - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 定义渲染函数\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eview\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eHtml\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eview\x3c\/span\x3e model =\n  div []\n    [ button [onClick \x3cspan class=\x22hljs-type\x22\x3eDecrement\x3c\/span\x3e] [text \x3cspan class=\x22hljs-string\x22\x3e\x22-\x22\x3c\/span\x3e]\n    , text (toString model)\n    , button [onClick \x3cspan class=\x22hljs-type\x22\x3eIncrement\x3c\/span\x3e] [text \x3cspan class=\x22hljs-string\x22\x3e\x22\x2b\x22\x3c\/span\x3e]\n  ]\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 定义初始数据\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3einitModel\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3einitModel\x3c\/span\x3e = \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e有人可能要问了，\x22组件呢？在哪？这几个变量哪个是组件？\x22。答案是：加在一起就是。\x3c\/p\x3e\n\x3cp\x3e这是Elm架构的标志：\x3cstrong\x3e每个组件都被分成了Model\/View\/Update\/Msg四个部分。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e当它需要作为应用单独运行时，就将这几个部分\x22绑\x22在一起：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22main = App.beginnerProgram {model = initModel, view = view, update = update}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22elm hljs\x22\x3e\x3ccode class=\x22elm\x22\x3e\x3cspan class=\x22hljs-title\x22\x3emain\x3c\/span\x3e = \x3cspan class=\x22hljs-type\x22\x3eApp\x3c\/span\x3e.beginnerProgram {model = initModel, view = view, update = update}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而当它需要被上层组件使用时，则由上层组件使用这些分立的元件构建自己的对应部分，下面是使用Counter构建一个CounterList：\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e以下主要关注对Counter.XXX的使用\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import Counter\n\n-- 使用Counter.Model组合新的Model\ntype alias IndexedCounter = {id: Int, counter: Counter.Model}\ntype alias Model = {uid: Int, counters: List IndexedCounter}\n\n\n-- 使用Counter.Msg 组合新的Msg\ntype Msg = Insert | Remove | Modify Int Counter.Msg\n\nupdate : Msg -\x3e Model -\x3e Model\nupdate msg model =\n  case msg of\n    Modify id counterMsg -\x3e\n      let\n        counterMapper = updateCounter id counterMsg -- 调用updateCounter函数\n      in\n        {model | counters = List.map counterMapper model.counters}\n\n-- 调用Counter.update\nupdateCounter : Int -\x3e Counter.Msg -\x3e IndexedCounter -\x3e IndexedCounter\nupdateCounter id counterMsg indexedCounter =\n  if id == indexedCounter.id\n  then {indexedCounter | counter = Counter.update counterMsg indexedCounter.counter}\n  else indexedCounter\n\nview : Model -\x3e Html Msg\nview model =\n  div []\n    [ button [onClick Insert] [text \x26quot;Insert\x26quot;]\n    , button [onClick Remove] [text \x26quot;Remove\x26quot;]\n    , div [] (List.map showCounter model.counters) -- 调用showCounter\n    ]\n\n-- 调用Counter.view\nshowCounter : IndexedCounter -\x3e Html Msg\nshowCounter ({id, counter} as indexedCounter) =\n  App.map (\\counterMsg -\x3e Modify id counterMsg) (Counter.view counter)\n\n-- 调用Counter.initModel\ninitModel = {uid= 0, counters = [{id= 0, counter= Counter.initModel}]}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22elm hljs\x22\x3e\x3ccode class=\x22elm\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Counter\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 使用Counter.Model组合新的Model\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ealias\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eIndexedCounter\x3c\/span\x3e = {id: \x3cspan class=\x22hljs-type\x22\x3eInt\x3c\/span\x3e, counter: \x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.\x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e}\n\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ealias\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e = {uid: \x3cspan class=\x22hljs-type\x22\x3eInt\x3c\/span\x3e, counters: \x3cspan class=\x22hljs-type\x22\x3eList\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eIndexedCounter\x3c\/span\x3e}\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 使用Counter.Msg 组合新的Msg\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e = \x3cspan class=\x22hljs-type\x22\x3eInsert\x3c\/span\x3e | \x3cspan class=\x22hljs-type\x22\x3eRemove\x3c\/span\x3e | \x3cspan class=\x22hljs-type\x22\x3eModify\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eInt\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.\x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-title\x22\x3eupdate\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eupdate\x3c\/span\x3e msg model =\n  \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e msg \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e\n    \x3cspan class=\x22hljs-type\x22\x3eModify\x3c\/span\x3e id counterMsg -\x26gt;\n      \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e\n        counterMapper = updateCounter id counterMsg \x3cspan class=\x22hljs-comment\x22\x3e-- 调用updateCounter函数\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e\n        {model | counters = \x3cspan class=\x22hljs-type\x22\x3eList\x3c\/span\x3e.map counterMapper model.counters}\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 调用Counter.update\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eupdateCounter\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eInt\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.\x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eIndexedCounter\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eIndexedCounter\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eupdateCounter\x3c\/span\x3e id counterMsg indexedCounter =\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e id == indexedCounter.id\n  \x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e {indexedCounter | counter = \x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.update counterMsg indexedCounter.counter}\n  \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e indexedCounter\n\n\x3cspan class=\x22hljs-title\x22\x3eview\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eModel\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eHtml\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eview\x3c\/span\x3e model =\n  div []\n    [ button [onClick \x3cspan class=\x22hljs-type\x22\x3eInsert\x3c\/span\x3e] [text \x3cspan class=\x22hljs-string\x22\x3e\x22Insert\x22\x3c\/span\x3e]\n    , button [onClick \x3cspan class=\x22hljs-type\x22\x3eRemove\x3c\/span\x3e] [text \x3cspan class=\x22hljs-string\x22\x3e\x22Remove\x22\x3c\/span\x3e]\n    , div [] (\x3cspan class=\x22hljs-type\x22\x3eList\x3c\/span\x3e.map showCounter model.counters) \x3cspan class=\x22hljs-comment\x22\x3e-- 调用showCounter\x3c\/span\x3e\n    ]\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 调用Counter.view\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eshowCounter\x3c\/span\x3e : \x3cspan class=\x22hljs-type\x22\x3eIndexedCounter\x3c\/span\x3e -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eHtml\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMsg\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3eshowCounter\x3c\/span\x3e ({id, counter} \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e indexedCounter) =\n  \x3cspan class=\x22hljs-type\x22\x3eApp\x3c\/span\x3e.map (\\counterMsg -\x26gt; \x3cspan class=\x22hljs-type\x22\x3eModify\x3c\/span\x3e id counterMsg) (\x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.view counter)\n\n\x3cspan class=\x22hljs-comment\x22\x3e-- 调用Counter.initModel\x3c\/span\x3e\n\x3cspan class=\x22hljs-title\x22\x3einitModel\x3c\/span\x3e = {uid= \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, counters = [{id= \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, counter= \x3cspan class=\x22hljs-type\x22\x3eCounter\x3c\/span\x3e.initModel}]}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以看到，上层组件同样是分成了四个部分，而每个部分都分别调用了子组件的对应元素。\x3c\/p\x3e\n\x3cp\x3e整个Elm的组件树，就是这样一层层组合起来，直到最顶层，仍然是分立的四部分，需要运行时，才被粘合到一起。\x3c\/p\x3e\n\x3cp\x3e最终被运行的根节点组件，无论是Model、View还是Update，都是由整个组件树上无数个小组件组合出来的，在组合的过程中，只有\x3ccode\x3e使用A组件的Model\x3c\/code\x3e，而不会有\x3ccode\x3e使用User Model\x3c\/code\x3e——\x3cstrong\x3e整个架构从抽象、到组合，都是完全面向组件，而非面向领域模型的。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3eRedux与Elm的差异\x3c\/h3\x3e\n\x3cp\x3e在谈论Elm的\x3ccode\x3eModel\x3c\/code\x3e\/\x3ccode\x3eUpdate\x3c\/code\x3e\/\x3ccode\x3eMsg\x3c\/code\x3e时，熟悉Redux的读者应该很快就联想到了\x3ccode\x3eStore\x3c\/code\x3e\/\x3ccode\x3eReducer\x3c\/code\x3e\/\x3ccode\x3eAction\x3c\/code\x3e，然而它们间的差异也是显而易见的：Elm中\x3ccode\x3eModel\x3c\/code\x3e\/\x3ccode\x3eUpdate\x3c\/code\x3e\/\x3ccode\x3eMsg\x3c\/code\x3e\/\x3ccode\x3eView\x3c\/code\x3e是\x3cstrong\x3e创造组件时\x3c\/strong\x3e定义的，而Redux中的Reducer\/Action则是在\x3cstrong\x3e组件树之外\x3c\/strong\x3e定义的。\x3c\/p\x3e\n\x3cp\x3e脱离具体的组件与交互场景，面向组件抽象就变得非常困难，此时领域模型成了几乎唯一可靠的抽象依据。\x3c\/p\x3e\n\x3cp\x3e领域模型与组件树无关，加上之前flux社区的惯性，社区很自然就把store做成了App级的全局单例。\x3c\/p\x3e\n\x3cp\x3e然而，管理UI state的需求仍然存在，一个Web应用可以有无数个页面，相应地有无数的UI state需要管理，如果状态管理框架不能有效地解决它们，也就失去了存在的意义。\x3c\/p\x3e\n\x3cp\x3e在Elm中，应用的状态树随着组件树而变化，假设组件树的根结点是页面，那么页面A和B的状态树必然是不同的，而\x3cstrong\x3eRedux却需要用唯一一个状态树，去满足整个应用——N个组件树(页面)的需求\x3c\/strong\x3e，这显然是有问题的。\x3c\/p\x3e\n\x3cp\x3e因此在Redux中有reselect, 有normalize，有mapStateToProps，这些Elm中通通不存在的东西，它们面向的其实是同一个问题：状态树到组件树如何映射。然而它们都只能起缓冲作用，因为状态树与组件树一对N的关系并没有改变。\x3c\/p\x3e\n\x3cp\x3e举个例子：A页面有个复杂的Counter组件，我们希望它被状态管理框架管理起来——这显然比setState更清晰更易维护。于是我们设计了counterReducer，并把它放到了store中：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const rootReducer = combineReducers({\n  user: userReducer,\n  product: productReducer,\n  \/\/添加counterReducer\n  counter: counterReducer,\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e rootReducer = combineReducers({\n  \x3cspan class=\x22hljs-attr\x22\x3euser\x3c\/span\x3e: userReducer,\n  \x3cspan class=\x22hljs-attr\x22\x3eproduct\x3c\/span\x3e: productReducer,\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/添加counterReducer\x3c\/span\x3e\n  counter: counterReducer,\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e假设B页面用到了同样的组件——但是需要两个counter，现有的状态树就无法满足需要了，只能改成：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const rootReducer = combineReducers({\n  user: userReducer,\n  product: productReducer,\n  \/\/添加counterReducer\n  pageA: combineReducers({\n      counter: counterReducer,\n  }),\n  pageB: combineReducers({\n      counter1: counterReducer,\n      counter2: counterReducer,\n  })\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e rootReducer = combineReducers({\n  \x3cspan class=\x22hljs-attr\x22\x3euser\x3c\/span\x3e: userReducer,\n  \x3cspan class=\x22hljs-attr\x22\x3eproduct\x3c\/span\x3e: productReducer,\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/添加counterReducer\x3c\/span\x3e\n  pageA: combineReducers({\n      \x3cspan class=\x22hljs-attr\x22\x3ecounter\x3c\/span\x3e: counterReducer,\n  }),\n  \x3cspan class=\x22hljs-attr\x22\x3epageB\x3c\/span\x3e: combineReducers({\n      \x3cspan class=\x22hljs-attr\x22\x3ecounter1\x3c\/span\x3e: counterReducer,\n      \x3cspan class=\x22hljs-attr\x22\x3ecounter2\x3c\/span\x3e: counterReducer,\n  })\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个例子既体现了Redux相对于Flux的进步(在Flux\/Reflux中，要复用counter的逻辑非常困难)，也体现了Redux在store设计上的尴尬：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eDomain data与UI state混搭\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e理论上页面有无穷多个，未来rootReducer里还需要装下page(CDEFG)\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3erootReducer具有全局性，而页面、组件通常是局部的，修改全局去服务局部是bad smell\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e\x22如何设计Redux的store？\x22这个问题的背后，便是如上所述的，Redux在设计上相对于Elm的偏离导致的。这种偏离导致Redux仍然不能非常好地驾驭UI state，最终不得不表示\x22You might not need Redux\x22和\x22setState is OK\x22。\x3c\/p\x3e\n\x3ch4\x3eReducer的优势\x3c\/h4\x3e\n\x3cp\x3e客观地讲，脱离组件树定义的Reducer并非一无是处。它确实很难处理细碎、嵌套的UI状态。但在处理某一\x22类\x22UI状态时却显得得心应手——\x3cstrong\x3e有些UI状态是可以被脱离组件树抽象的\x3c\/strong\x3e(类似前面提到的App state)。\x3c\/p\x3e\n\x3cp\x3e一个著名的例子是\x3ca\x3eredux-form\x3c\/a\x3e，它把表单这一\x22类\x22行为进行了抽象，并且挂载在根reducer下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import { createStore, combineReducers } from \x27redux\x27\nimport { reducer as formReducer } from \x27redux-form\x27\n\nconst reducers = {\n  \/\/ ... your other reducers here ...\n  form: formReducer     \/\/ \x3c---- Mounted at \x27form\x27\n}\nconst reducer = combineReducers(reducers)\nconst store = createStore(reducer)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { createStore, combineReducers } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27redux\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { reducer \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e formReducer } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27redux-form\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reducers = {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ... your other reducers here ...\x3c\/span\x3e\n  form: formReducer     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x26lt;---- Mounted at \x27form\x27\x3c\/span\x3e\n}\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reducer = combineReducers(reducers)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e store = createStore(reducer)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e类似的例子还有全局的错误处理、loading状态管理以及模态窗的开闭管理。他们都是脱离组件树定义Reducer带来正面价值的案例——对于行为高度固定的、没有复杂嵌套关系的UI状态，脱离组件树几乎不会带来抽象上的缺失，用全局的方式进行抽象是可行的。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e题外话：WebApp场景下的隐患\x3c\/h3\x3e\n\x3cp\x3eStore对象存在于内存中，在用户没有刷新的情况下是一直存在并且可访问的，而一旦用户刷新、分享链接，Store就会重新创建。由于Store是\x22应用\x22级的，开发者使用Store中的数据时，很难知道数据在刷新、分享后是否可用。\x3c\/p\x3e\n\x3cp\x3e举个我曾经在\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000005864691\x22\x3e另一篇博客\x3c\/a\x3e中提到过的例子，一个业务流程有三个页面A\/B\/C，用户通常按顺序访问它们，每步都会提交一些信息，如果把信息存在Store中，在不刷新的情况下C页面可以直接访问A\/B页面存进Store的数据，而一旦用户刷新C页面，这些数据便不复存在，使用这些数据很可能导致程序异常。\x3c\/p\x3e\n\x3cp\x3e如果在设计Store时，是像上面提到的store.pageA这样的形式，情况会稍有缓解，因为至少开发者知道这个数据属于pageA，对数据的来源有认知，如果Store是按领域模型划分的，情况会变得非常糟：开发者在使用store.user这样的数据时不可能知道这个数据是否可靠，最终要么花费额外的精力去确认，要么给应用留下隐患——显然后者会是更常见的情况。\x3c\/p\x3e\n\x3cp\x3eStore这个名字给人以\x22Storage\x22的错觉，面向领域模型的设计使得这种错觉被进一步巩固。\x3c\/p\x3e\n\x3cp\x3e从辩护的角度，这个问题不是Redux独有，它是App级Store在Web场景下的通病，从Flux\/Reflux开始就已经存在。另外也可以把问题推给开发者：你不确认数据的可靠性，出了问题怪谁？\x3c\/p\x3e\n\x3cp\x3e然而，好的框架、范式应该具备足够的\x22防御性\x22，当前Redux的主流实践在这个问题上并没有给出让人满意的答案。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e例：React-Redux的\x3ca href=\x22https:\/\/github.com\/gothinkster\/react-redux-realworld-example-app\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReal-World example\x3c\/a\x3e就把分页信息存进了store导致刷新后页码丢失\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e改良版的实践\x3c\/h3\x3e\n\x3cp\x3e尽管Redux有上面提到的问题，但它在单向数据流、提倡纯函数、解耦输入与响应等方面仍然有非常大的价值。对上面提到的问题，我试图通过改良实践去缓解：\x3cstrong\x3ePage独立声明reducers并创建store\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e这个过程可以使用高阶组件封装起来，代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const defaultConfig = {\n  pageReducers: {},\n  reducers: commonReducers, \/\/ import from other files\n  middlewares: commonMiddlewares, \/\/ import from other files\n};\n\nconst withRedux = config =\x3e (Comp) =\x3e {\n  const finalConfig = {\n    ...defaultConfig,\n    ...config,\n  };\n\n  const { middlewares, reducers } = finalConfig;\n\n  return class WithRedux extends Component {\n    constructor(props) {\n      super(props);\n\n      const reducerFn = combineReducers({\n        ...finalConfig.pageReducers,\n        ...reducers,\n      });\n\n      this.store = applyMiddleware(\n        ...middlewares,\n      )(createStore)(reducerFn);\n    }\n    render() {\n      return (\n        \x3cProvider store={this.store}\x3e\n          \x3cComp {...this.props} \/\x3e\n        \x3c\/Provider\x3e\n      );\n    }\n  };\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e defaultConfig = {\n  \x3cspan class=\x22hljs-attr\x22\x3epageReducers\x3c\/span\x3e: {},\n  \x3cspan class=\x22hljs-attr\x22\x3ereducers\x3c\/span\x3e: commonReducers, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ import from other files\x3c\/span\x3e\n  middlewares: commonMiddlewares, \x3cspan class=\x22hljs-comment\x22\x3e\/\/ import from other files\x3c\/span\x3e\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e withRedux = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3econfig\x3c\/span\x3e =\x26gt;\x3c\/span\x3e (Comp) =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e finalConfig = {\n    ...defaultConfig,\n    ...config,\n  };\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { middlewares, reducers } = finalConfig;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eWithRedux\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(props) {\n      \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e(props);\n\n      \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reducerFn = combineReducers({\n        ...finalConfig.pageReducers,\n        ...reducers,\n      });\n\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.store = applyMiddleware(\n        ...middlewares,\n      )(createStore)(reducerFn);\n    }\n    render() {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n        \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3estore\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{this.store}\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n          \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eComp\x3c\/span\x3e {\x3cspan class=\x22hljs-attr\x22\x3e...this.props\x3c\/span\x3e} \/\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      );\n    }\n  };\n};\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e接下来，只需要在\x3cstrong\x3e依赖Redux的页面\x3c\/strong\x3e使用withRedux即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const PageA = ()=\x3e \x3cdiv\x3eA\x3c\/div\x3e;\n\nexport default withRedux({\n  pageReducers: {\n    foo, \/\/ 和commonReducers合并成最终页面的reducer\n  },\n\/\/  reducers: {}, \/\/ 直接替换commonReducers\n})(PageA)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PageA = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e \x26lt;div\x26gt;A\x26lt;\x3cspan class=\x22hljs-regexp\x22\x3e\/div\x26gt;;\n\nexport default withRedux({\n  pageReducers: {\n    foo, \/\x3c\/span\x3e\x3cspan class=\x22hljs-regexp\x22\x3e\/ 和commonReducers合并成最终页面的reducer\n  },\n\/\x3c\/span\x3e\x3cspan class=\x22hljs-regexp\x22\x3e\/  reducers: {}, \/\x3c\/span\x3e\x3cspan class=\x22hljs-regexp\x22\x3e\/ 直接替换commonReducers\n})(PageA)\n\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e它可以从两方面缓解上述问题：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e抽象问题：每个Page独立创建store，解决状态树的一对多问题，一个状态树(store)对应一个组件树(page)，page在设计store时\x3cstrong\x3e不用考虑其它页面，仅服务当前页\x3c\/strong\x3e。当然，由于Reducer仍然需要独立于组件树声明，抽象问题并没有根治，面向领域数据和App state的抽象仍然比UI state更自然。它仅仅带给你更大的自由度：不再担心有限的状态树如何设计才能满足近乎无限的UI state。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e刷新、分享隐患：每个Page创建的Store都是完全不同的对象，且只存在于当前Page生命周期内，其它Page不可能访问到，从根本上杜绝跨页面的store访问。这意味着\x3cem\x3e能够从store中访问到的数据，一定是可靠的\x3c\/em\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e通过commonReducers\/commonMiddleware可以方便复用一些全局性的解决方案，比如redux-thunk\/redux-form。页面默认使用commonReducers\/commonMiddlewares，也可以完全不用，\x3cstrong\x3e甚至页面可以不使用redux\x3c\/strong\x3e。\x3ccode\x3e复用行为，而不是共用状态\x3c\/code\x3e，这是Redux相对于Flux最大的进步，现在我们将这个理念继续推进。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e问题\x3c\/h3\x3e\n\x3cp\x3e\x3cstrong\x3eQ：是否违反了Redux三大核心原则之一——single source of truth？\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eA:\x3c\/strong\x3e 没有，它只是明确了组件树和状态树一一对应的关系，一个应用会有N个页面，但不会同时显示两个页面，因此，任何时刻当前页面对应的状态树都是single source of truth。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eQ：和社区主流库集成是否会有问题\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eA:\x3c\/strong\x3e 是的，由于和社区主流实践有差异，遇到问题是难以避免的。\x3c\/p\x3e\n\x3cp\x3e假设你正在使用ReactRouter，采用上述方案后组件树的结构将会变成 \x3ccode\x3eRouter \x26gt; Route \x26gt; Provider \x26gt; PageA\x3c\/code\x3e，而\x3ccode\x3ereact-router-redux\x3c\/code\x3e则需要 \x3ccode\x3eProvider \x26gt; ConnectedRouter \x26gt; Route \x26gt; PageA\x3c\/code\x3e 这样的组件结构：ConnectedRouter是\x3ccode\x3ereact-router-redux\x3c\/code\x3e引入的，依赖Provider向context中注入store，这意味着Redux的Provider必须是路由的父元素，和我们将Redux下放到页面的思路相冲突。\x3c\/p\x3e\n\x3cp\x3e对此，我们的选择是：放弃\x3ccode\x3ereact-router-redux\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e我强烈建议你回顾当初引入 \x3ccode\x3ereact-router-redux\x3c\/code\x3e的原因：如果是希望通过action操作history，那么一个独立的中间件可以轻易做到；如果是希望通过store访问location\/history，在页面初始化时把location\/history放进store也非常简单；如果不知道为什么，仅仅因为它是全家桶的一部分——何不干掉他试试？\x3c\/p\x3e\n\x3cp\x3e在移除\x3ccode\x3ereact-router-redux\x3c\/code\x3e后，我们不仅没有受到任何功能性的影响，反而使得架构层面的耦合更低了：路由与状态管理方案不再有耦合关系。\x3c\/p\x3e\n\x3cp\x3e这种从耦合中解放的感觉就像水里穿着衣服游泳的人终于脱掉了外套，之前是视图(react)-路由(router)-状态管理(redux)相互耦合，却并没有带来明显的收益，而现在我们已经开始考虑换掉react-router了。\x3c\/p\x3e\n\x3cp\x3e甚至，既然是由页面决定是否引入Redux、使用哪些reducers\/middlewares，那么一个项目中不同的页面采用不同技术栈是完全可行的，这允许你在某些页面上大胆尝试新的方案而不用担心影响全局：架构上的低耦合使我们拥有更多的选择余地。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eQ: 谈到UI state，社区有以\x3ca href=\x22https:\/\/github.com\/tonyhb\/redux-ui\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eredux-ui\x3c\/a\x3e为代表的方案，怎么看？\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eA:\x3c\/strong\x3e 它们恰恰呼应了本文提到的另一个侧面：Reducer的抽象问题。redux-ui让组件状态、行为与组件定义重新回到了一起，从而使\x22让redux管理UI state\x22变得更自然。当然它也带来了一些代码结构上的限制，是否采用取决于具体场景下的考量。它和本文最后提倡的改良实践并不冲突，甚至，改良版实践能更容易地在部分页面先行尝试这些新方案。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader11\x22\x3e小结\x3c\/h2\x3e\n\x3cp\x3e本文从Elm的角度剖析了Redux存在的问题，也分享了我目前采用的实践方式，这个实践方式不是神奇药水，仅仅是权衡问题和现状后的小步改良。\x3c\/p\x3e\n\x3cp\x3e回顾和对比主流实践的两个重点：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e改良前\x3c\/th\x3e\n\x3cth\x3e改良后\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd\x3eStore代表了\x3cstrong\x3e应用\x3c\/strong\x3e的状态\x3c\/td\x3e\n\x3ctd\x3eStore代表了页面(根组件)状态\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3eDomain data和App state作为store的主要抽象依据\x3c\/td\x3e\n\x3ctd\x3e没有本质改变，但加入UI state的影响更低\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e从程序设计的角度，我相信改良后的实践又进步了一点点：更低的耦合、更准确的对应关系、更可靠的数据依赖，与Elm也更加接近。\x3c\/p\x3e\n\x3cp\x3e同时我也深知这还远远不够，期待能有更好的实践方式和更好的轮子出现。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3e更新\x3c\/h2\x3e\n\x3cp\x3e======================= 2017.08.27 更新 =======================\x3c\/p\x3e\n\x3cp\x3e这个方案在实践中，仍然遇到了一些问题，其中最最重要的，则是\x3cstrong\x3e替换store后，跨页面action的问题\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e举个例子，通过thunk在a页面触发一个异步action：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const asyncAction = ()=\x3e (dispatch)=\x3e {\n  setTimeout(()=\x3e {\n    dispatch({type: \x27SYNC_ACT\x27}); \/\/ dispatch 为a页面的store.dispatch\n  }, 5000)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e asyncAction = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e (dispatch)=\x26gt; {\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e {\n    dispatch({\x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27SYNC_ACT\x27\x3c\/span\x3e}); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ dispatch 为a页面的store.dispatch\x3c\/span\x3e\n  }, \x3cspan class=\x22hljs-number\x22\x3e5000\x3c\/span\x3e)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果在这5秒内，用户跳转到了另一个页面，则会重新create一个store，而回调函数中的dispatch函数仍然指向上一个页面的store。\x3c\/p\x3e\n\x3cp\x3e如果我们把页面看成完全独立的\x22小应用\x22，这样的行为是说得通的，但作为一个网站有时候我们也希望有\x22连续\x22的用户体验和交互。在实际项目中我们遇到的情况是我们使用了redux管理模态窗的开闭状态，而需求方希望在上一个页面离开时打开一个模态窗，同时保持打开状态并跳到下一个页面，两秒后模态窗消失。\x3c\/p\x3e\n\x3cp\x3e同理，如果有类似websocket的需求，相关的thunk action也会不定时地触发dispatch，无论当前在哪个页面。\x3c\/p\x3e\n\x3cp\x3e我反思了一下Elm中的情况，得到的答案是Elm中随着组件树变化的\x22状态\x22是\x3cem\x3e纯数据\x3c\/em\x3e，而store并非如此，它既包含了\x22状态\x22数据，也持有了reducer\/action之间的监听关系。这一点确实是我最初没有考虑到的。\x3c\/p\x3e\n\x3cp\x3e为了应对这个问题，我考虑了几种方案：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e回到应用单一store：pageReducer的特性通过store.replaceReducer完成。当初为每个页面创建store是想让状态彻底隔离，而在replaceReducer后页面之间如果有相同的reducer则状态不会被重置，这是一个担心点。同时一个副作用是牺牲掉每个page定制化middleware的能力\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e为这类跨页面的action建立一个队列，在上个页面将action推进队列，下个页面取出再执行。此方案属于头痛医头，只能解决当前的case，对于websocket等类似问题比较无力。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e定制thunk middleware，通过闭包获取最新的store\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e在权衡方案的通用性、理解难度等方面后，目前选择了第一种。\x3c\/p\x3e\n\x3cp\x3e其实改变没有想象中的大，只是把withRedux函数改了一下，并且有一部分功能也不再支持，比如页面覆盖commonReducers和定制middleware：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import commonMiddlewares from \x27.\/commonMiddlewares\x27;\nimport commonReducers from \x27.\/commonReducers\x27;\n\nconst defaultConfig = {\n  pageReducers: {},\n  reducers: commonReducers,\n  middlewares: commonMiddlewares,\n};\n\nexport const createReduxStore = (config) =\x3e {\n  const finalConfig = {\n    ...defaultConfig,\n    ...config,\n  };\n\n  const { middlewares, reducers } = finalConfig;\n\n  const reducerFn = combineReducers({\n    ...reducers,\n  });\n\n  return applyMiddleware(\n    ...middlewares,\n  )(createStore)(reducerFn);\n};\n\nconst store = createReduxStore();\n\nconst withRedux = config =\x3e Comp =\x3e class WithRedux extends Component {\n  constructor(props) {\n    super(props);\n\n    if (config \x26amp;\x26amp; config.pageReducers) {\n      store.replaceReducer(combineReducers({\n        ...commonReducers,\n        ...config.pageReducers,\n      }));\n    }\n  }\n  render() {\n    return (\n      \x3cProvider store={store}\x3e\n        \x3cComp {...this.props} \/\x3e\n      \x3c\/Provider\x3e\n    );\n  }\n};\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e commonMiddlewares \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/commonMiddlewares\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e commonReducers \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/commonReducers\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e defaultConfig = {\n  \x3cspan class=\x22hljs-attr\x22\x3epageReducers\x3c\/span\x3e: {},\n  \x3cspan class=\x22hljs-attr\x22\x3ereducers\x3c\/span\x3e: commonReducers,\n  \x3cspan class=\x22hljs-attr\x22\x3emiddlewares\x3c\/span\x3e: commonMiddlewares,\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e createReduxStore = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3econfig\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e finalConfig = {\n    ...defaultConfig,\n    ...config,\n  };\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { middlewares, reducers } = finalConfig;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reducerFn = combineReducers({\n    ...reducers,\n  });\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e applyMiddleware(\n    ...middlewares,\n  )(createStore)(reducerFn);\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e store = createReduxStore();\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e withRedux = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3econfig\x3c\/span\x3e =\x26gt;\x3c\/span\x3e Comp =\x26gt; \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eWithRedux\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(props) {\n    \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e(props);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (config \x26amp;\x26amp; config.pageReducers) {\n      store.replaceReducer(combineReducers({\n        ...commonReducers,\n        ...config.pageReducers,\n      }));\n    }\n  }\n  render() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n      \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3estore\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{store}\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eComp\x3c\/span\x3e {\x3cspan class=\x22hljs-attr\x22\x3e...this.props\x3c\/span\x3e} \/\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    );\n  }\n};\n\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Redux状态管理之痛点、分析与改良</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009540007">https://segmentfault.com/a/1190000009540007</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/34uimyuvjtx/" target="_blank">https://alili.tech/archive/34uimyuvjtx/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>