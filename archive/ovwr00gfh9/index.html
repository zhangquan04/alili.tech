<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="[译] 用 Node.js 搭建 API Gateway"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>[译] 用 Node.js 搭建 API Gateway | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/ovwr00gfh9/",
				"appid": "1613049289050283", 
				"title": "[译] 用 Node.js 搭建 API Gateway | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-05T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/qef8o4z447/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/4ox9vu22jug/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&text=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&text=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&title=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&is_video=false&description=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&title=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&title=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&title=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fovwr00gfh9%2f&title=%5b%e8%af%91%5d%20%e7%94%a8%20Node.js%20%e6%90%ad%e5%bb%ba%20API%20Gateway"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">[译] 用 Node.js 搭建 API Gateway</h1><div class="meta"><div class="postdate"><time datetime="2019-01-05" itemprop="datePublished">2019-01-05</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e我们团队的后端服务中，一开始只有一个大服务，所有的东西都往里面写，可以想象下，当这个服务变得不断的庞大，将会变得多么难以维护。后来逐渐把一些数据服务抽离成单独的 API 服务，在原有的服务里，就还剩一些模板渲染，数据聚合还有一些耦合的业务逻辑。目前来说拆的还不够干净，我们的目标其实是希望这个旧的服务充当一个 API Gateway，或者说一个给前端用的中间层。单一职责原则，其实是一个很重要的解耦方式，一个服务干好一件事就好了。偶然间看到下面的文章，虽然只是一些很简单的介绍，也让我了解到很多东西。也分享给 大家看看。\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/blog.risingstack.com\/building-an-api-gateway-using-nodejs\/?utm_source=RisingStack\x2bEngineering\x26amp;utm_campaign=cf6ea5b2e0-EMAIL_CAMPAIGN_2017_08_03\x26amp;utm_medium=email\x26amp;utm_term=0_02a6a69990-cf6ea5b2e0-475054665\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e阅读原文\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e客户端一般都需要经过一些认证以及满足在数据传输时的安全要求，才能获得访问微服务架构中的服务的权利。不同的服务在认证上都会或多或少存在一些差异，API Gateway 就像一个集线器，用它来抹平各种服务协议之间的差异，并满足对特定客户端的特殊处理。他的存在，方便了客户端对各类服务的享用。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e微服务和消费者\x3c\/h2\x3e\n\x3cp\x3e微服务适合用在团队可以独立设计、开发、运行服务的架构体系中。它允许系统中的各个服务存在技术多样性，团队可以在适合的场景使用合适的开发语言、数据库和网络协议。例如，一个团队中使用 JSON 和 HTTP REST，而另一个团队则可能使用 gRPC 和 HTTP\/2 或者像 \x3ca href=\x22http:\/\/blog.csdn.net\/anzhsoft\/article\/details\/19563091\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eRabbitMQ\x3c\/a\x3e 这样的消息代理。\x3c\/p\x3e\n\x3cp\x3e有些场景中使用不同的数据序列化方式和协议可能收益巨大，但是需要使用我们服务的客户端可能会有不同的需求。由于存在各种各样的客户端，需要我们支持的数据格式也是多种多样，比如一个客户端可能希望拿到的数据是 XML 格式的，而另一个客户端则希望数据是 JSON。另一个你可能需要面对的问题是，可能不同服务之间存在着一些公共的逻辑(比如权限认证之类)，总不能在每个服务里都实现一遍吧？\x3c\/p\x3e\n\x3cp\x3e总结：我们不想把一些支持多个客户端等相关的公用逻辑重复实现在微服务中，我们需要一个 API Gateway 来提供一个中间层来处理服务协议之间的差异，并满足特定客户端的需求。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e什么是 API Gateway\x3c\/h2\x3e\n\x3cp\x3eAPI 网关是微服务架构中的一种服务，它为客户端提供共享层和 API，以便与内部服务进行通信。 API 网关可以路由请求，转换协议，聚合数据，并实现一些共享逻辑，如身份验证和速率限制器等。\x3c\/p\x3e\n\x3cp\x3e你可以将 API Gateway 看做是一个享用各种微服务的入口。\x3c\/p\x3e\n\x3cp\x3e我们的系统可以有一个或多个 API Gateway，这具体取决于客户端的需求。例如，我们可以为桌面浏览器，移动应用程序和公共API提供单独的网关。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581427\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581427\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e前端团队的Node.js API Gateway\x3c\/h2\x3e\n\x3cp\x3e由于 API Gateway 为客户端应用程序（如浏览器）提供了支持，它可以由负责前端应用程序的团队来实现和管理。\x3c\/p\x3e\n\x3cp\x3e这也意味着 API Gateway 的实现语言应由负责客户端的团队选择。由于 JavaScript 是开发浏览器应用程序的主要语言，即使你的微服务架构用不同的语言开发，Node.js 也可以成为实现 API Gateway 的绝佳选择。\x3cbr\x3eNetflix 成功地使用 Node.js API Gateway 及其 Java 后端来支持广泛的客户端, \x3ca href=\x22https:\/\/www.infoq.com\/news\/2017\/06\/paved-paas-netflix\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e了解更多\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581428\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581428\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3eAPI Gateway 的实用性\x3c\/h2\x3e\n\x3cp\x3e我们之前讨论过，可以将通用共享逻辑放入 API Gateway，本节将介绍其常见用法。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e路由和版本控制\x3c\/h3\x3e\n\x3cp\x3e我们将 API Gateway 定义为微服务的入口。 在你的 API Gateway 中，你可以将请求从客户端路由到指定的服务。 你甚至可以在路由期间对服务程序的版本进行选择或更改后端接口，而公开的接口可以保持不变。你还可以在你的 API Gateway 中集合多个微服务到一点。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581429\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581429\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e迭代设计\x3c\/h3\x3e\n\x3cp\x3eAPI Gateway 可以帮助你分解臃肿的应用程序。由于业务的不断迭代，从头开始把整个应用重写成一个微服务架构的系统似乎不太可行。\x3c\/p\x3e\n\x3cp\x3e在这种情况下，我们可以将代理或 API Gateway 置于我们的整体应用之前，并将新功能作为微服务实现，只需要保证 API Gateway 能将新接口路由到新服务，同时保证旧接口依然能够访问。慢慢的我们要把这些旧的服务迁移成微服务以达到分解臃肿应用程序的目的。\x3cbr\x3e通过小步迭代设计，我们能够平滑的从庞大的整体过渡到微服务架构。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581430\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581430\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e认证\x3c\/h3\x3e\n\x3cp\x3e大多数微服务是需要通过认证才可以使用的。将类似身份验证的共享逻辑放在 API Gateway 上可以让你的微服务更加专注。\x3c\/p\x3e\n\x3cp\x3e在微服务架构中，您可以通过网络配置将服务放置于 DMZ（非军事区域）中，并通过API Gateway 将其暴露给客户端。该网关还可以处理多个身份验证方法，例如，可以支持基于cookie和基于 token 的身份验证。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e数据聚合\x3c\/h3\x3e\n\x3cp\x3e在微服务架构中，客户端可能会需要不同聚合程度的数据。 在这种情况下，我们可以使用 API Gateway 来解决这些依赖关系并从多个服务收集数据。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581431\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581431\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e序列化格式转换\x3c\/h3\x3e\n\x3cp\x3e这种问题发生在不同客户端需要不同格式数据的需求中。\x3c\/p\x3e\n\x3cp\x3e想象一下，在微服务中如果我们使用了 JSON，但是在某个客户端中只支持 XML 的 API，这个时候怎么办？我们完全可以把 JSON 转换 XML 这一过程放在 API Gateway 中，而不是在每个微服务中实现。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581432\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581432\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e协议转换\x3c\/h3\x3e\n\x3cp\x3e微服务架构允许使用不同的协议以便于获得使用不同技术的优势。然而，大多数客户端只支持一种协议。在这种情况下，我们需要转换客户端的服务协议。\x3c\/p\x3e\n\x3cp\x3eAPI Gateway 也可以成为介于客户端和微服务之间的一个协议转换层。\x3c\/p\x3e\n\x3cp\x3e下面的图片中你可以看到，客户端只使用 HTTP REST 来和各种服务交换信息，而实际上我们内部的各种微服务可以基于不同的规范、协议来进行信息传递。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010581433\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010581433\x22 alt=\x22image\x22 title=\x22image\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e速率控制和缓存\x3c\/h3\x3e\n\x3cp\x3e除了身份验证之外，你还可以在 API Gateway 中实现速率限制，缓存和各种可靠性相关的功能。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e过于庞大的 API Gateway\x3c\/h3\x3e\n\x3cp\x3e在实现 API Gateway 时，应当避免将非通用逻辑（如领域特定数据转换）放入其中。\x3c\/p\x3e\n\x3cp\x3e服务应始终对其数据域拥有完全的所有权。 构建一个过于庞大的 API Gateway，从服务团队争夺控制权，这违反了微服务的理念。\x3c\/p\x3e\n\x3cp\x3e这就是为什么你应该注意你的API网关中的数据聚合 —— 如果你明确它的职责，它可以是很强大的，应当避免在 API Gateway 中处理业务逻辑，是谁的事情就交给谁干，一定要明确其在整个架构中的角色。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3eNode.js Gateways\x3c\/h2\x3e\n\x3cp\x3e如果你希望在 API Gateway 中执行一些简单的操作，例如将请求路由到特定的服务，你可以使用像nginx这样的反向代理。 但在某些时候，你可能需要实现一般代理不支持的逻辑。 在这种情况下，你可以在 Node.js 中实现自己的 API Gateway。\x3c\/p\x3e\n\x3cp\x3e在 Node.js 中，你可以使用 http-proxy 完成一些简单的代理请求的服务，当然也可以使用具有更多功能的 express-gateway。\x3c\/p\x3e\n\x3cp\x3e在第一个 API Gateway 示例中，我们在其代理请求到真实的服务之前，先进行权限认证。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const express = require(\x27express\x27) \nconst httpProxy = require(\x27express-http-proxy\x27)  \nconst app = express()\n\nconst userServiceProxy = httpProxy(\x27https:\/\/user-service\x27)\n\n\/\/ Authentication\napp.use((req, res, next) =\x3e {\n  \/\/ TODO: my authentication logic  \n  next()\n})\n\/\/ Proxy request \napp.get(\x27\/users\/:userId\x27, (req, res, next) =\x3e {    \n  userServiceProxy(req, res, next)\n}) \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22JavaScript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e express = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e) \n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e httpProxy = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express-http-proxy\x27\x3c\/span\x3e)  \n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = express()\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e userServiceProxy = httpProxy(\x3cspan class=\x22hljs-string\x22\x3e\x27https:\/\/user-service\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Authentication\x3c\/span\x3e\napp.use(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res, next\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x3cspan class=\x22hljs-doctag\x22\x3eTODO:\x3c\/span\x3e my authentication logic  \x3c\/span\x3e\n  next()\n})\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Proxy request \x3c\/span\x3e\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/users\/:userId\x27\x3c\/span\x3e, (req, res, next) =\x26gt; {    \n  userServiceProxy(req, res, next)\n}) \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e另一种方式是由 API Gateway 向微服务发送请求，再将响应回馈给客户端：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const express = require(\x27express\x27)  \nconst request = require(\x27request-promise-native\x27)  \nconst app = express()\n\/\/ Resolve: GET \/users\/me\napp.get(\x27\/users\/me\x27, async (req, res) =\x3e {  \n  const userId = req.session.userId\n  const uri = `https:\/\/user-service\/users\/${userId}`\n  const user = await request(uri)\n  res.json(user)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22JavaScript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e express = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e)  \n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e request = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27request-promise-native\x27\x3c\/span\x3e)  \n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = express()\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Resolve: GET \/users\/me\x3c\/span\x3e\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/users\/me\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e (req, res) =\x26gt; {  \n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e userId = req.session.userId\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e uri = \x3cspan class=\x22hljs-string\x22\x3e`https:\/\/user-service\/users\/\x3cspan class=\x22hljs-subst\x22\x3e${userId}\x3c\/span\x3e`\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e user = \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e request(uri)\n  res.json(user)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader13\x22\x3e总结：\x3c\/h2\x3e\n\x3cp\x3eAPI Gateway 提供了一个中间层来协调客户端和微服务架构。它有助于帮助我们完成单一职责原则，让我们的应用或者服务持续的关注一件事。你可以将通用逻辑放入 API Gateway 中，但是也应该注意不要过度的使用 API Gateway。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>[译] 用 Node.js 搭建 API Gateway</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010581422">https://segmentfault.com/a/1190000010581422</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/ovwr00gfh9/" target="_blank">https://alili.tech/archive/ovwr00gfh9/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>