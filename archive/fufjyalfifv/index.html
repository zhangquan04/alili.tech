<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Koa2源码阅读笔记"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Koa2源码阅读笔记 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/fufjyalfifv/",
				"appid": "1613049289050283", 
				"title": "Koa2源码阅读笔记 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-11T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/l18u9aur5f8/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/feqdcys3ubv/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&text=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&text=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&title=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&is_video=false&description=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&title=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&title=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&title=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ffufjyalfifv%2f&title=Koa2%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e7%ac%94%e8%ae%b0"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Koa2源码阅读笔记</h1><div class="meta"><div class="postdate"><time datetime="2019-01-11" itemprop="datePublished">2019-01-11</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e引言\x3c\/h2\x3e\n\x3cp\x3e最近空闲时间读了一下\x3ca href=\x22https:\/\/github.com\/koajs\/koa\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eKoa2\x3c\/a\x3e的源码；在阅读Koa2(version 2.2.0)的源码的过程中，我的感受是代码简洁、思路清晰（不得不佩服大神的水平）。\x3cbr\x3e下面是我读完之后的一些感受。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eKoa的设计理念\x3c\/h2\x3e\n\x3cblockquote\x3e\x3cp\x3eKoa 是一个轻量级的、极富表现力的 http 框架。\x3cbr\x3e一个web request会通过 Koa 的中间件栈，来动态完成 response 的处理。\x3cbr\x3eKoa2 采用了 async 和 await 的语法来增强中间件的表现力。\x3cbr\x3eKoa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3eKoa基本组成\x3c\/h2\x3e\n\x3cp\x3eKoa源码非常精简，只有四个文件：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3eapplication.js：框架入口；负责管理中间件，以及处理请求\x3c\/li\x3e\n\x3cli\x3econtext.js：context对象的原型，代理request与response对象上的方法和属性\x3c\/li\x3e\n\x3cli\x3erequest.js：request对象的原型，提供请求相关的方法和属性\x3c\/li\x3e\n\x3cli\x3eresponse.js：response对象的原型，提供响应相关的方法和属性\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3eapplication.js\x3c\/h3\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ application.js\n\nmodule.exports = class Application extends Emitter {\n  constructor() {\n    super();\n\n    this.proxy = false; \/\/ 是否信任 proxy header 参数，默认为 false\n    \n    this.middleware = []; \/\/保存通过app.use(middleware)注册的中间件\n    \n    this.subdomainOffset = 2; \/\/ 子域默认偏移量，默认为 2\n    \n    this.env = process.env.NODE_ENV || \x27development\x27; \/\/ 环境参数，默认为 NODE_ENV 或 ‘development’\n    \n    this.context = Object.create(context); \/\/context模块，通过context.js创建\n    \n    this.request = Object.create(request); \/\/request模块，通过request.js创建\n    \n    this.response = Object.create(response); \/\/response模块，通过response.js创建\n  }\n\n  \/\/ ...\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ application.js\x3c\/span\x3e\n\nmodule.exports = \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eApplication\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEmitter\x3c\/span\x3e \x3c\/span\x3e{\n  constructor() {\n    \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e();\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.proxy = \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 是否信任 proxy header 参数，默认为 false\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.middleware = []; \x3cspan class=\x22hljs-comment\x22\x3e\/\/保存通过app.use(middleware)注册的中间件\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.subdomainOffset = \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 子域默认偏移量，默认为 2\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.env = process.env.\x3cspan class=\x22hljs-type\x22\x3eNODE_ENV\x3c\/span\x3e || \x3cspan class=\x22hljs-symbol\x22\x3e\x27developmen\x3c\/span\x3et\x27; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 环境参数，默认为 NODE_ENV 或 ‘development’\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.context = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(context); \x3cspan class=\x22hljs-comment\x22\x3e\/\/context模块，通过context.js创建\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.request = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(request); \x3cspan class=\x22hljs-comment\x22\x3e\/\/request模块，通过request.js创建\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.response = \x3cspan class=\x22hljs-type\x22\x3eObject\x3c\/span\x3e.create(response); \x3cspan class=\x22hljs-comment\x22\x3e\/\/response模块，通过response.js创建\x3c\/span\x3e\n  }\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eapplication.js 是 koa 的入口主要文件，暴露应用的 class, 这个 class 继承自 EventEmitter ，这里可以看出跟 koa1.x 的不同，koa1.x 是用的是构造函数的方式，koa2 大量使用 es6 的语法。调用的时候就跟 koa1.x 有区别\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var koa = require(\x27koa\x27);\n\/\/ koa 1.x\nvar app = koa();\n\/\/ koa 2.x\n\/\/ 使用class必须使用new来调用\nvar app = new koa();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs haxe\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e koa = require(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ koa 1.x\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e app = koa();\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ koa 2.x\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 使用class必须使用new来调用\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3ekoa\x3c\/span\x3e();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eapplication.js除了上面的的构造函数外，还暴露了一些公用的api，比如两个常见的，一个是\x3ccode\x3elisten\x3c\/code\x3e，一个是\x3ccode\x3euse\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch4\x3euse函数\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ application.js\n\nuse(fn) {\n  if (typeof fn !== \x27function\x27) throw new TypeError(\x27middleware must be a function!\x27);\n  if (isGeneratorFunction(fn)) {\n    deprecate(\x27Support for generators will be removed in v3. \x27 \x2b\n              \x27See the documentation for examples of how to convert old middleware \x27 \x2b\n              \x27https:\/\/github.com\/koajs\/koa\/blob\/master\/docs\/migration.md\x27);\n    fn = convert(fn);\n  }\n  debug(\x27use %s\x27, fn._name || fn.name || \x27-\x27);\n  this.middleware.push(fn);\n  return this;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs rust\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ application.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e) {\n  \x3cspan class=\x22hljs-title\x22\x3eif\x3c\/span\x3e \x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e !== \x27\x3cspan class=\x22hljs-title\x22\x3efunction\x3c\/span\x3e\x27) \x3cspan class=\x22hljs-title\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eTypeError\x3c\/span\x3e\x3c\/span\x3e(\x3cspan class=\x22hljs-symbol\x22\x3e\x27middleware\x3c\/span\x3e must \x3cspan class=\x22hljs-keyword\x22\x3ebe\x3c\/span\x3e a function!\x27);\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (isGeneratorFunction(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e)) {\n    \x3cspan class=\x22hljs-title\x22\x3edeprecate\x3c\/span\x3e\x3c\/span\x3e(\x3cspan class=\x22hljs-symbol\x22\x3e\x27Support\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e generators will \x3cspan class=\x22hljs-keyword\x22\x3ebe\x3c\/span\x3e removed \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e v3. \x27 \x2b\n              \x3cspan class=\x22hljs-symbol\x22\x3e\x27See\x3c\/span\x3e the documentation \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e examples of how to convert old middleware \x27 \x2b\n              \x3cspan class=\x22hljs-symbol\x22\x3e\x27https\x3c\/span\x3e:\x3cspan class=\x22hljs-comment\x22\x3e\/\/github.com\/koajs\/koa\/blob\/master\/docs\/migration.md\x27);\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e = \x3cspan class=\x22hljs-title\x22\x3econvert\x3c\/span\x3e\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e);\n  }\n  \x3cspan class=\x22hljs-title\x22\x3edebug\x3c\/span\x3e\x3c\/span\x3e(\x3cspan class=\x22hljs-symbol\x22\x3e\x27use\x3c\/span\x3e %s\x27, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3e_name\x3c\/span\x3e || \x3cspan class=\x22hljs-title\x22\x3efn\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3ename\x3c\/span\x3e || \x27-\x27);\n  \x3cspan class=\x22hljs-title\x22\x3ethis\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3emiddleware\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3epush\x3c\/span\x3e\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-title\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ethis\x3c\/span\x3e;\n}\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3euse\x3c\/code\x3e函数做的事很简单：注册一个中间件\x3ccode\x3efn\x3c\/code\x3e，其实就是将\x3ccode\x3efn\x3c\/code\x3e放入\x3ccode\x3emiddleware\x3c\/code\x3e数组。\x3c\/p\x3e\n\x3ch4\x3elisten函数\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ application.js\n\nlisten(...args) {\n  debug(\x27listen\x27);\n  const server = http.createServer(this.callback());\n  return server.listen(...args);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs arduino\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ application.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-built_in\x22\x3elisten\x3c\/span\x3e(...args) {\n  debug(\x3cspan class=\x22hljs-string\x22\x3e\x27listen\x27\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e server = http.createServer(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.callback());\n  \x3cspan class=\x22hljs-built_in\x22\x3ereturn\x3c\/span\x3e server.\x3cspan class=\x22hljs-built_in\x22\x3elisten\x3c\/span\x3e(...args);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3elisten\x3c\/code\x3e方法首先会通过\x3ccode\x3ethis.callback\x3c\/code\x3e方法来返回一个函数作为\x3ccode\x3ehttp.createServer\x3c\/code\x3e的回调函数，然后进行监听。我们已经知道，\x3ccode\x3ehttp.createServer\x3c\/code\x3e的回调函数接收两个参数：\x3ccode\x3ereq\x3c\/code\x3e和\x3ccode\x3eres\x3c\/code\x3e，下面来看\x3ccode\x3ethis.callback\x3c\/code\x3e的实现：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ application.js\n\ncallback() {\n  const fn = compose(this.middleware);\n    \n  if (!this.listeners(\x27error\x27).length) this.on(\x27error\x27, this.onerror);\n    \n  const handleRequest = (req, res) =\x3e {\n    res.statusCode = 404;\n    const ctx = this.createContext(req, res);\n    const onerror = err =\x3e ctx.onerror(err);\n    const handleResponse = () =\x3e respond(ctx);\n    onFinished(res, onerror);\n    return fn(ctx).then(handleResponse).catch(onerror);\n  };\n    \n  return handleRequest;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ application.js\x3c\/span\x3e\n\ncallback() {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fn = compose(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.middleware);\n    \n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.listeners(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e).length) \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.on(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.onerror);\n    \n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e handleRequest = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    res.statusCode = \x3cspan class=\x22hljs-number\x22\x3e404\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.createContext(req, res);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e onerror = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ctx.onerror(err);\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e handleResponse = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e respond(ctx);\n    onFinished(res, onerror);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fn(ctx).then(handleResponse).catch(onerror);\n  };\n    \n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e handleRequest;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e首先，\x3ccode\x3ecallback\x3c\/code\x3e方法把所有\x3ccode\x3emiddleware\x3c\/code\x3e进行了组合，使用了\x3ccode\x3ekoa-compose\x3c\/code\x3e，我们来看一下\x3ccode\x3ekoa-compose\x3c\/code\x3e的代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ koa-compose\n\nfunction compose (middleware) {\n\/\/ 传入的middleware必须是一个数组\n  if (!Array.isArray(middleware)) throw new TypeError(\x27Middleware stack must be an array!\x27)\n\/\/ 传入的middleware的每一个元素都必须是函数\n  for (const fn of middleware) {\n    if (typeof fn !== \x27function\x27) throw new TypeError(\x27Middleware must be composed of functions!\x27)\n  }\n\n  return function (context, next) {\n    let index = -1\n    return dispatch(0)\n    function dispatch (i) {\n      if (i \x3c= index) return Promise.reject(new Error(\x27next() called multiple times\x27))\n      index = i\n      let fn = middleware[i]\n      \/\/下面两行代码是处理最后一个中间件还有next的情况的，其实就是直接resolve出来\n      if (i === middleware.length) fn = next\n      if (!fn) return Promise.resolve() \n      try {\n        \/\/ 这里就是传入next执行中间件代码了\n        return Promise.resolve(fn(context, function next () {\n          return dispatch(i \x2b 1)\n        }))\n      } catch (err) {\n        return Promise.reject(err)\n      }\n    }\n  }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ koa-compose\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecompose\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3emiddleware\x3c\/span\x3e) \x3c\/span\x3e{\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 传入的middleware必须是一个数组\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.isArray(middleware)) \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eTypeError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Middleware stack must be an array!\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 传入的middleware的每一个元素都必须是函数\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fn \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e middleware) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eTypeError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Middleware must be composed of functions!\x27\x3c\/span\x3e)\n  }\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3econtext, next\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e index = \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e dispatch(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edispatch\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ei\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (i \x26lt;= index) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27next() called multiple times\x27\x3c\/span\x3e))\n      index = i\n      \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e fn = middleware[i]\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/下面两行代码是处理最后一个中间件还有next的情况的，其实就是直接resolve出来\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (i === middleware.length) fn = next\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!fn) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve() \n      \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这里就是传入next执行中间件代码了\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(fn(context, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e dispatch(i \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n        }))\n      } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(err)\n      }\n    }\n  }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以看到\x3ccode\x3ekoa-compose\x3c\/code\x3e基本就是个\x3ccode\x3edispatch\x3c\/code\x3e函数的递归调用。其中最重要的就是下面这段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22return Promise.resolve(fn(context, function next () {\n  return dispatch(i \x2b 1)\n}))\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs ada\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Promise.resolve(fn(context, \x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e () {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3edispatch(i\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n}))\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这段代码等价于：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fn(context, function next () {\n return dispatch(i \x2b 1)\n})\nreturn Promise.resolve()\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs ada\x22\x3e\x3ccode\x3efn(context, \x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e () {\n \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3edispatch(i\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n})\n\x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e Promise.resolve()\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里\x3ccode\x3emiddlewareFunction\x3c\/code\x3e的第二个参数(也就是next)是动态传递进去的信使，它会调取\x3ccode\x3edispatch(index)\x3c\/code\x3e执行下一个的\x3ccode\x3emiddleware\x3c\/code\x3e。最后会返回一个\x3ccode\x3eResolved\x3c\/code\x3e（已完成）状态的Promise对象。这个对象的作用我们稍后再说。\x3c\/p\x3e\n\x3cp\x3e我们先暂时回到\x3ccode\x3ecallback\x3c\/code\x3e方法里面，前面说了它先对\x3ccode\x3emiddleware\x3c\/code\x3e进行了组合，生成了一个函数\x3ccode\x3efn\x3c\/code\x3e。\x3cbr\x3e然后，\x3ccode\x3ecallback\x3c\/code\x3e方法返回\x3ccode\x3ehttp.createServer\x3c\/code\x3e所需要的回调函数\x3ccode\x3ehandleRequest\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3ehandleRequest\x3c\/code\x3e函数，先把http code默认设置为404，接着利用\x3ccode\x3ecreateContext\x3c\/code\x3e函数把node返回的req和res进行了封装创建出\x3ccode\x3econtext\x3c\/code\x3e，\x3cbr\x3e然后通过\x3ccode\x3eonFinished(res, onerror)\x3c\/code\x3e监听\x3ccode\x3ehttp response\x3c\/code\x3e，当请求结束时执行回调。这里传入的回调是\x3ccode\x3econtext.onerror(err)\x3c\/code\x3e，即当错误发生时才执行。\x3cbr\x3e最后返回 \x3ccode\x3efn(ctx).then(handleResponse).catch(onerror)\x3c\/code\x3e的执行结果，这里的\x3ccode\x3efn\x3c\/code\x3e函数就是就是组合所有\x3ccode\x3emiddleware\x3c\/code\x3e后生成的函数，调用它执行所有\x3ccode\x3emiddleware\x3c\/code\x3e后会返回前面提到的\x3ccode\x3eResolved\x3c\/code\x3e（已完成）状态的Promise对象，之后执行响应处理函数\x3ccode\x3erespond(ctx)\x3c\/code\x3e（\x3ccode\x3erespond\x3c\/code\x3e函数里面也主要是一些收尾工作，例如判断http code为空如何输出啦，http method是head如何输出啦，body返回是流或json时如何输出；代码就不贴了，感兴趣的小伙伴自己可以去看一下），当抛出异常时同样使用 \x3ccode\x3econtext.onerror(err)\x3c\/code\x3e处理。\x3c\/p\x3e\n\x3cp\x3e我们可以看看\x3ccode\x3ecreateContext\x3c\/code\x3e函数\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ application.js\n\ncreateContext(req, res) {\n  const context = Object.create(this.context);\n  const request = context.request = Object.create(this.request);\n  const response = context.response = Object.create(this.response);\n  context.app = request.app = response.app = this;\n  context.req = request.req = response.req = req;\n  context.res = request.res = response.res = res;\n  request.ctx = response.ctx = context;\n  request.response = response;\n  response.request = request;\n  context.originalUrl = request.originalUrl = req.url;\n  context.cookies = new Cookies(req, res, {\n    keys: this.keys,\n    secure: request.secure\n  });\n  request.ip = request.ips[0] || req.socket.remoteAddress || \x27\x27;\n  context.accept = request.accept = accepts(req);\n  context.state = {};\n  return context;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs verilog\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ application.js\x3c\/span\x3e\n\ncreateContext(req, res) {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.context\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e request = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e response = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e = Object\x3cspan class=\x22hljs-variable\x22\x3e.create\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.app\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.req\x3c\/span\x3e = req;\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.res\x3c\/span\x3e = res;\n  request\x3cspan class=\x22hljs-variable\x22\x3e.ctx\x3c\/span\x3e = response\x3cspan class=\x22hljs-variable\x22\x3e.ctx\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e;\n  request\x3cspan class=\x22hljs-variable\x22\x3e.response\x3c\/span\x3e = response;\n  response\x3cspan class=\x22hljs-variable\x22\x3e.request\x3c\/span\x3e = request;\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.originalUrl\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.originalUrl\x3c\/span\x3e = req\x3cspan class=\x22hljs-variable\x22\x3e.url\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.cookies\x3c\/span\x3e = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Cookies(req, res, {\n    keys: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.keys\x3c\/span\x3e,\n    secure: request\x3cspan class=\x22hljs-variable\x22\x3e.secure\x3c\/span\x3e\n  });\n  request\x3cspan class=\x22hljs-variable\x22\x3e.ip\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.ips\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] || req\x3cspan class=\x22hljs-variable\x22\x3e.socket\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.remoteAddress\x3c\/span\x3e || \x27\x27;\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.accept\x3c\/span\x3e = request\x3cspan class=\x22hljs-variable\x22\x3e.accept\x3c\/span\x3e = accepts(req);\n  \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e\x3cspan class=\x22hljs-variable\x22\x3e.state\x3c\/span\x3e = {};\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econtext\x3c\/span\x3e;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ecreateContext\x3c\/code\x3e创建\x3ccode\x3econtext\x3c\/code\x3e的时候，还会同时创建request和response，通过下图可以比较直观地看到所有这些对象之间的关系。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVPAMf?w=833\x26amp;h=562\x22 src=\x22https:\/\/static.alili.tech\/img\/bVPAMf?w=833\x26amp;h=562\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e图中：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e最左边一列表示每个文件的导出对象\x3c\/li\x3e\n\x3cli\x3e中间一列表示每个Koa应用及其维护的属性\x3c\/li\x3e\n\x3cli\x3e右边两列表示对应每个请求所维护的一些列对象\x3c\/li\x3e\n\x3cli\x3e黑色的线表示实例化\x3c\/li\x3e\n\x3cli\x3e红色的线表示原型链\x3c\/li\x3e\n\x3cli\x3e蓝色的线表示属性\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e通过上面的分析，我们已经可以大概得知Koa处理请求的过程：当请求到来的时候，会通过 req 和 res 来创建一个 context (ctx) ，然后执行中间件。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3econtent.js\x3c\/h3\x3e\n\x3cp\x3econtent.js 主要的功能提供了对\x3ccode\x3erequest\x3c\/code\x3e和\x3ccode\x3eresponse\x3c\/code\x3e对象的方法与属性便捷访问能力。\x3cbr\x3e其中使用了\x3ca href=\x22https:\/\/github.com\/tj\/node-delegates\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3enode-delegates\x3c\/a\x3e（有兴趣的可以看一下\x3ca href=\x22https:\/\/github.com\/tj\/node-delegates\/blob\/master\/index.js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e源码\x3c\/a\x3e），将\x3ccode\x3econtext.request\x3c\/code\x3e与\x3ccode\x3econtext.response\x3c\/code\x3e上的方法与属性代理到\x3ccode\x3econtext\x3c\/code\x3e上。\x3cbr\x3e在源码中，我们可以看到：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ context.js\n\ndelegate(proto, \x27response\x27)\n  .method(\x27attachment\x27)\n  \/\/ ...\n  .access(\x27status\x27)\n  \/\/ ...\n  .getter(\x27writable\x27);\n\ndelegate(proto, \x27request\x27)\n  .method(\x27acceptsLanguages\x27)\n  \/\/ ...\n  .access(\x27querystring\x27)\n  \/\/ ...\n  .getter(\x27ip\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs less\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ context.js\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-selector-tag\x22\x3edelegate\x3c\/span\x3e(proto, \x3cspan class=\x22hljs-string\x22\x3e\x27response\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.method\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27attachment\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.access\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27status\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.getter\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27writable\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-selector-tag\x22\x3edelegate\x3c\/span\x3e(proto, \x3cspan class=\x22hljs-string\x22\x3e\x27request\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.method\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27acceptsLanguages\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.access\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27querystring\x27\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n  \x3cspan class=\x22hljs-selector-class\x22\x3e.getter\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27ip\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3erequest.js\x3c\/h3\x3e\n\x3cp\x3erequest.js 封装了请求相关的属性以及方法。通过 application.js 中的\x3ccode\x3ecreateContext\x3c\/code\x3e方法，代理对应的 request 对象。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const request = context.request = Object.create(this.request);\n\/\/ ...\ncontext.req = request.req = response.req = req;\n\/\/ ...\nrequest.response = response;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs nix\x22\x3e\x3ccode\x3econst \x3cspan class=\x22hljs-attr\x22\x3erequest\x3c\/span\x3e = context.\x3cspan class=\x22hljs-attr\x22\x3erequest\x3c\/span\x3e = Object.create(this.request);\n\/\/ ...\ncontext.\x3cspan class=\x22hljs-attr\x22\x3ereq\x3c\/span\x3e = request.\x3cspan class=\x22hljs-attr\x22\x3ereq\x3c\/span\x3e = response.\x3cspan class=\x22hljs-attr\x22\x3ereq\x3c\/span\x3e = req;\n\/\/ ...\nrequest.\x3cspan class=\x22hljs-attr\x22\x3eresponse\x3c\/span\x3e = response;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3erequest.req\x3c\/code\x3e为原生的请求对象，在 request.js 中属性的获取都是通过 \x3ccode\x3eths.req\x3c\/code\x3e来获取的（即 \x3ccode\x3erequest.req\x3c\/code\x3e）。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3eresponse.js\x3c\/h3\x3e\n\x3cp\x3eresponse.js 封装了响应相关的属性以及方法。与 request 相同，通过\x3ccode\x3ecreateContext\x3c\/code\x3e方法代理对应的 response 对象。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const response = context.response = Object.create(this.response);\n\/\/ ...\ncontext.res = request.res = response.res = res;\n\/\/ ...\nresponse.request = request;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs nix\x22\x3e\x3ccode\x3econst \x3cspan class=\x22hljs-attr\x22\x3eresponse\x3c\/span\x3e = context.\x3cspan class=\x22hljs-attr\x22\x3eresponse\x3c\/span\x3e = Object.create(this.response);\n\/\/ ...\ncontext.\x3cspan class=\x22hljs-attr\x22\x3eres\x3c\/span\x3e = request.\x3cspan class=\x22hljs-attr\x22\x3eres\x3c\/span\x3e = response.\x3cspan class=\x22hljs-attr\x22\x3eres\x3c\/span\x3e = res;\n\/\/ ...\nresponse.\x3cspan class=\x22hljs-attr\x22\x3erequest\x3c\/span\x3e = request;\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e结语\x3c\/h2\x3e\n\x3cp\x3e关于Koa2的源码就先分析到这，希望对大家有所帮助。\x3cbr\x3e如有不同的看法，欢迎交流！\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Koa2源码阅读笔记</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009875733">https://segmentfault.com/a/1190000009875733</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/fufjyalfifv/" target="_blank">https://alili.tech/archive/fufjyalfifv/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>