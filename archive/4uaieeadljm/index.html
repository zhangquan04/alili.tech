<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="微信小程序开发：python&#43;sanic 实现小程序登录注册"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>微信小程序开发：python&#43;sanic 实现小程序登录注册 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/4uaieeadljm/",
				"appid": "1613049289050283", 
				"title": "微信小程序开发：python&#43;sanic 实现小程序登录注册 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-06T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/yhj7wtcuko8/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/0gn2i71wt99l/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&text=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&text=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&title=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&is_video=false&description=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&title=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&title=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&title=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f4uaieeadljm%2f&title=%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%bc%80%e5%8f%91%ef%bc%9apython%2bsanic%20%e5%ae%9e%e7%8e%b0%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">微信小程序开发：python&#43;sanic 实现小程序登录注册</h1><div class="meta"><div class="postdate"><time datetime="2019-01-06" itemprop="datePublished">2019-01-06</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e开发微信小程序时，接入小程序的授权登录可以快速实现用户注册登录的步骤，是快速建立用户体系的重要一步。这篇文章将介绍 python \x2b sanic \x2b 微信小程序实现用户快速注册登录全栈方案。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e微信小程序登录时序图如下：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010414725\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010414725\x22 alt=\x22登录时序图\x22 title=\x22登录时序图\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这个流程分为两大部分：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e小程序使用 wx.login() API 获取 code，调用 wx.getUserInfo() API 获取 encryptedData 和 iv，然后将这三个信息发送给第三方服务器。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e第三方服务器获取到 code、encryptedData和 iv 后，使用 code 换取 session_key，然后将 session_key 利用 encryptedData 和 iv 解密在服务端获取用户信息。根据用户信息返回 jwt 数据，完成登录。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e下面我们先看一下小程序提供的 API。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e小程序登录 API\x3c\/h2\x3e\n\x3cp\x3e在这个授权登录的过程中，用到的 API 如下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3ewx.login\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ewx.getUserInfo\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3ccode\x3ewx.chekSession\x3c\/code\x3e 是可选的，这里并没有用到。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3ewx.login(OBJECT)\x3c\/h3\x3e\n\x3cp\x3e调用此接口可以获取登录凭证（code），以用来换取用户登录态信息，包括用户的唯一标识（openid） 及本次登录的 会话密钥（session_key）。\x3c\/p\x3e\n\x3cp\x3e如果接口调用成功，返回结果如下：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e参数名\x3c\/th\x3e\n\x3cth\x3e类型\x3c\/th\x3e\n\x3cth\x3e说明\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd\x3eerrMsg\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e调用结果\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3ecode\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e用户允许登录后，回调内容会带上 code（有效期五分钟），开发者需要将 code 发送到开发者服务器后台，使用code 换取 session_key api，将 code 换成 openid 和 session_key\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3ch4\x3ecode 换取 session_key\x3c\/h4\x3e\n\x3cp\x3e开发者服务器使用登录凭证 code 获取 session_key 和 openid。其中 session_key 是对用户数据进行加密签名的密钥。为了自身应用安全，session_key 不应该在网络上传输。所以这一步应该在服务器端实现。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3ewx.getUserInfo\x3c\/h3\x3e\n\x3cp\x3e此接口用来获取用户信息。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e当 \x3ccode\x3ewithCredentials\x3c\/code\x3e 为 true 时，要求此前有调用过 wx.login 且登录态尚未过期，此时返回的数据会包含 encryptedData, iv 等敏感信息；当 withCredentials 为 false 时，不要求有登录态，返回的数据不包含 encryptedData, iv 等敏感信息。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e接口success 时返回参数如下：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e参数名\x3c\/th\x3e\n\x3cth\x3e类型\x3c\/th\x3e\n\x3cth\x3e说明\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd\x3euserInfo\x3c\/td\x3e\n\x3ctd\x3eOBJECT\x3c\/td\x3e\n\x3ctd\x3e用户信息对象，不包含 openid 等敏感信息\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3erawData\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e不包括敏感信息的原始数据字符串，用于计算签名。\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3esignature\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e使用 sha1( rawData \x2b sessionkey ) 得到字符串，用于校验用户信息，参考文档 signature。\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3eencryptedData\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e包括敏感数据在内的完整用户信息的加密数据，详细见加密数据解密算法\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3eiv\x3c\/td\x3e\n\x3ctd\x3eString\x3c\/td\x3e\n\x3ctd\x3e加密算法的初始向量，详细见加密数据解密算法\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e\x3ccode\x3eencryptedData\x3c\/code\x3e 解密后为以下 json 结构，详见加密数据解密算法\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{\n    \x26quot;openId\x26quot;: \x26quot;OPENID\x26quot;,\n    \x26quot;nickName\x26quot;: \x26quot;NICKNAME\x26quot;,\n    \x26quot;gender\x26quot;: GENDER,\n    \x26quot;city\x26quot;: \x26quot;CITY\x26quot;,\n    \x26quot;province\x26quot;: \x26quot;PROVINCE\x26quot;,\n    \x26quot;country\x26quot;: \x26quot;COUNTRY\x26quot;,\n    \x26quot;avatarUrl\x26quot;: \x26quot;AVATARURL\x26quot;,\n    \x26quot;unionId\x26quot;: \x26quot;UNIONID\x26quot;,\n    \x26quot;watermark\x26quot;:\n    {\n        \x26quot;appid\x26quot;:\x26quot;APPID\x26quot;,\n    \x26quot;timestamp\x26quot;:TIMESTAMP\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22json hljs\x22\x3e\x3ccode class=\x22json\x22\x3e{\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22openId\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22OPENID\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22nickName\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22NICKNAME\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22gender\x22\x3c\/span\x3e: GENDER,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22city\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22CITY\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22province\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22PROVINCE\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22country\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22COUNTRY\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22avatarUrl\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22AVATARURL\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22unionId\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22UNIONID\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22watermark\x22\x3c\/span\x3e:\n    {\n        \x3cspan class=\x22hljs-attr\x22\x3e\x22appid\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22APPID\x22\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3e\x22timestamp\x22\x3c\/span\x3e:TIMESTAMP\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cblockquote\x3e\x3cp\x3e由于解密 encryptedData 需要 session_key 和 iv 所以，在给服务器端发送授权验证的过程中需要将 code、encryptedData 和 iv 一起发送。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e服务器端提供的 API\x3c\/h2\x3e\n\x3cp\x3e服务器端授权需要提供两个 API：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e\/oauth\/token 通过小程序提供的验证信息获取服务器自己的 token\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\/accounts\/wxapp 如果登录用户是未注册用户，使用此接口注册为新用户。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e换取第三方 token（\/oauth\/token）\x3c\/h3\x3e\n\x3cp\x3e开始授权时，小程序调用此 API 尝试换取jwt，如果用户未注册返回401，如果用户发送参数错误，返回403。\x3c\/p\x3e\n\x3cp\x3e接口 获取 jwt 成功时返回参数如下：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e参数名\x3c\/th\x3e\n\x3cth\x3e类型\x3c\/th\x3e\n\x3cth\x3e说明\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd\x3eaccount_id\x3c\/td\x3e\n\x3ctd\x3estring\x3c\/td\x3e\n\x3ctd\x3e当前授权用户的用户 ID\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3eaccess_token\x3c\/td\x3e\n\x3ctd\x3estring\x3c\/td\x3e\n\x3ctd\x3ejwt（登录流程中的第三方 session_key\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd\x3etoken_type\x3c\/td\x3e\n\x3ctd\x3estring\x3c\/td\x3e\n\x3ctd\x3etoken 类型（固定Bearer）\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e小程序授权后应该先调用此接口，如果结果是用户未注册，则应该调用新用户注册的接口先注册新用户，注册成功后再调用此接口换取 jwt。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e新用户注册（\/accounts\/wxapp）\x3c\/h3\x3e\n\x3cp\x3e注册新用户时，服务器端需要存储当前用户的 openid，所以和授权接口一样，请求时需要的参数为 code、encryptedData 和 iv。\x3c\/p\x3e\n\x3cp\x3e注册成功后，将返回用户的 ID 和注册时间。此时，应该再次调用获取 token 的接口去换取第三方 token，以用来下次登录。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e实现流程\x3c\/h2\x3e\n\x3cp\x3e接口定义好之后，来看下前后端整体的授权登录流程。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010414726\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010414726\x22 alt=\x22小程序授权登录流程\x22 title=\x22小程序授权登录流程\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这个流程需要注意的是，在 C 步（使用 code 换取 session ）之后我们得到 session_key，然后需要用 session_key 解密得到用户数据。\x3c\/p\x3e\n\x3cp\x3e然后使用 openid 判断用户是否已经注册，如果用户已经注册，生成  jwt 返回给小程序。\x3cbr\x3e如果用户未注册返回401， 提示用户未注册。\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e\x3ccode\x3ejwt(3rd_session)\x3c\/code\x3e 用于第三方服务器和小程序之间做登录态校验，为了保证安全性，jwt 应该满足：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e足够长。建议有 2^128 组合\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e避免使用 srand(当前时间)，然后 rand() 的方法，而是采用操作系统提供的真正随机数机制。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e设置一定的有效时间，\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e当然，在小程序中也可以使用手机号登录，不过这是另一个功能了，就不在这里叙述了。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e代码实现\x3c\/h2\x3e\n\x3cp\x3e说了这么多，接下来看代码吧。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e小程序端代码\x3c\/h3\x3e\n\x3cp\x3e代码逻辑为：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e用户在小程序授权\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e小程序将授权消息发送到服务器，服务器检查用户是否已经注册，如果注册返回 jwt，如果没注册提示用户未注册，然后小程序重新请求注册接口，注册用户，注册成功后重复这一步。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e为了简便，这里在小程序 启动的时候就请求授权。代码实现如下。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/app.js\nvar config = require(\x27.\/config.js\x27)\n\nApp({\n    onLaunch: function() {\n        \/\/调用API从本地缓存中获取数据\n        var jwt = wx.getStorageSync(\x27jwt\x27);\n        var that = this;\n        if (!jwt.access_token){ \/\/检查 jwt 是否存在 如果不存在调用登录\n            that.login();\n        } else {\n            console.log(jwt.account_id);\n        }\n    },\n    login: function() {\n        \/\/ 登录部分代码\n        var that = this;\n        wx.login({\n            \/\/ 调用 login 获取 code\n            success: function(res) {\n                var code = res.code;\n                wx.getUserInfo({\n                    \/\/ 调用 getUserInfo 获取 encryptedData 和 iv\n                    success: function(res) {\n                        \/\/ success\n                        that.globalData.userInfo = res.userInfo;\n                        var encryptedData = res.encryptedData || \x27encry\x27;\n                        var iv = res.iv || \x27iv\x27;\n                        console.log(config.basic_token);\n                        wx.request({ \/\/ 发送请求 获取 jwt\n                            url: config.host \x2b \x27\/auth\/oauth\/token?code=\x27 \x2b code,\n                            header: {\n                                Authorization: config.basic_token\n                            },\n                            data: {\n                                username: encryptedData,\n                                password: iv,\n                                grant_type: \x26quot;password\x26quot;,\n                                auth_approach: \x27wxapp\x27,\n                            },\n                            method: \x26quot;POST\x26quot;,\n                            success: function(res) {\n                                if (res.statusCode === 201) {\n                                    \/\/ 得到 jwt 后存储到 storage，\n                                    wx.showToast({\n                                        title: \x27登录成功\x27,\n                                        icon: \x27success\x27\n                                    });\n                                    wx.setStorage({\n                                        key: \x26quot;jwt\x26quot;,\n                                        data: res.data\n                                    });\n                                    that.globalData.access_token = res.data.access_token;\n                                    that.globalData.account_id = res.data.sub;\n                                } else if (res.statusCode === 401){\n                                    \/\/ 如果没有注册调用注册接口\n                                    that.register();\n                                } else {\n                                    \/\/ 提示错误信息\n                                    wx.showToast({\n                                        title: res.data.text,\n                                        icon: \x27success\x27,\n                                        duration: 2000\n                                    });\n                                }\n                            },\n                            fail: function(res) {\n                                console.log(\x27request token fail\x27);\n                            }\n                        })\n                    },\n                    fail: function() {\n                        \/\/ fail\n                    },\n                    complete: function() {\n                        \/\/ complete\n                    }\n                })\n            }\n        })\n\n    },\n    register: function() {\n        \/\/ 注册代码\n        var that = this;\n        wx.login({ \/\/ 调用登录接口获取 code\n            success: function(res) {\n                var code = res.code;\n                wx.getUserInfo({\n                    \/\/ 调用 getUserInfo 获取 encryptedData 和 iv\n                    success: function(res) {\n                        \/\/ success\n                        that.globalData.userInfo = res.userInfo;\n                        var encryptedData = res.encryptedData || \x27encry\x27;\n                        var iv = res.iv || \x27iv\x27;\n                        console.log(iv);\n                        wx.request({ \/\/ 请求注册用户接口\n                            url: config.host \x2b \x27\/auth\/accounts\/wxapp\x27,\n                            header: {\n                                Authorization: config.basic_token\n                            },\n                            data: {\n                                username: encryptedData,\n                                password: iv,\n                                code: code,\n                            },\n                            method: \x26quot;POST\x26quot;,\n                            success: function(res) {\n                                if (res.statusCode === 201) {\n                                    wx.showToast({\n                                        title: \x27注册成功\x27,\n                                        icon: \x27success\x27\n                                    });\n                                    that.login();\n                                } else if (res.statusCode === 400) {\n                                    wx.showToast({\n                                        title: \x27用户已注册\x27,\n                                        icon: \x27success\x27\n                                    });\n                                    that.login();\n                                } else if (res.statusCode === 403) {\n                                    wx.showToast({\n                                        title: res.data.text,\n                                        icon: \x27success\x27\n                                    });\n                                }\n                                console.log(res.statusCode);\n                                console.log(\x27request token success\x27);\n                            },\n                            fail: function(res) {\n                                console.log(\x27request token fail\x27);\n                            }\n                        })\n                    },\n                    fail: function() {\n                        \/\/ fail\n                    },\n                    complete: function() {\n                        \/\/ complete\n                    }\n                })\n            }\n        })\n\n    },\n\n    get_user_info: function(jwt) {\n        wx.request({\n            url: config.host \x2b \x27\/auth\/accounts\/self\x27,\n            header: {\n                Authorization: jwt.token_type \x2b \x27 \x27 \x2b jwt.access_token\n            },\n            method: \x26quot;GET\x26quot;,\n            success: function (res) {\n                if (res.statusCode === 201) {\n                    wx.showToast({\n                        title: \x27已注册\x27,\n                        icon: \x27success\x27\n                    });\n                } else if (res.statusCode === 401 || res.statusCode === 403) {\n                    wx.showToast({\n                        title: \x27未注册\x27,\n                        icon: \x27error\x27\n                    });\n                }\n\n                console.log(res.statusCode);\n                console.log(\x27request token success\x27);\n            },\n            fail: function (res) {\n                console.log(\x27request token fail\x27);\n            }\n        })\n    },\n\n    globalData: {\n        userInfo: null\n    }\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e config = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/config.js\x27\x3c\/span\x3e)\n\nApp({\n    \x3cspan class=\x22hljs-attr\x22\x3eonLaunch\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/调用API从本地缓存中获取数据\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e jwt = wx.getStorageSync(\x3cspan class=\x22hljs-string\x22\x3e\x27jwt\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e that = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!jwt.access_token){ \x3cspan class=\x22hljs-comment\x22\x3e\/\/检查 jwt 是否存在 如果不存在调用登录\x3c\/span\x3e\n            that.login();\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(jwt.account_id);\n        }\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3elogin\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 登录部分代码\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e that = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n        wx.login({\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用 login 获取 code\x3c\/span\x3e\n            success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e code = res.code;\n                wx.getUserInfo({\n                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用 getUserInfo 获取 encryptedData 和 iv\x3c\/span\x3e\n                    success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ success\x3c\/span\x3e\n                        that.globalData.userInfo = res.userInfo;\n                        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e encryptedData = res.encryptedData || \x3cspan class=\x22hljs-string\x22\x3e\x27encry\x27\x3c\/span\x3e;\n                        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e iv = res.iv || \x3cspan class=\x22hljs-string\x22\x3e\x27iv\x27\x3c\/span\x3e;\n                        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(config.basic_token);\n                        wx.request({ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 发送请求 获取 jwt\x3c\/span\x3e\n                            url: config.host \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\/auth\/oauth\/token?code=\x27\x3c\/span\x3e \x2b code,\n                            \x3cspan class=\x22hljs-attr\x22\x3eheader\x3c\/span\x3e: {\n                                \x3cspan class=\x22hljs-attr\x22\x3eAuthorization\x3c\/span\x3e: config.basic_token\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3edata\x3c\/span\x3e: {\n                                \x3cspan class=\x22hljs-attr\x22\x3eusername\x3c\/span\x3e: encryptedData,\n                                \x3cspan class=\x22hljs-attr\x22\x3epassword\x3c\/span\x3e: iv,\n                                \x3cspan class=\x22hljs-attr\x22\x3egrant_type\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22password\x22\x3c\/span\x3e,\n                                \x3cspan class=\x22hljs-attr\x22\x3eauth_approach\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27wxapp\x27\x3c\/span\x3e,\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22POST\x22\x3c\/span\x3e,\n                            \x3cspan class=\x22hljs-attr\x22\x3esuccess\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e201\x3c\/span\x3e) {\n                                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 得到 jwt 后存储到 storage，\x3c\/span\x3e\n                                    wx.showToast({\n                                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27登录成功\x27\x3c\/span\x3e,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e\n                                    });\n                                    wx.setStorage({\n                                        \x3cspan class=\x22hljs-attr\x22\x3ekey\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22jwt\x22\x3c\/span\x3e,\n                                        \x3cspan class=\x22hljs-attr\x22\x3edata\x3c\/span\x3e: res.data\n                                    });\n                                    that.globalData.access_token = res.data.access_token;\n                                    that.globalData.account_id = res.data.sub;\n                                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e401\x3c\/span\x3e){\n                                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 如果没有注册调用注册接口\x3c\/span\x3e\n                                    that.register();\n                                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 提示错误信息\x3c\/span\x3e\n                                    wx.showToast({\n                                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: res.data.text,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eduration\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2000\x3c\/span\x3e\n                                    });\n                                }\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3efail\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27request token fail\x27\x3c\/span\x3e);\n                            }\n                        })\n                    },\n                    \x3cspan class=\x22hljs-attr\x22\x3efail\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fail\x3c\/span\x3e\n                    },\n                    \x3cspan class=\x22hljs-attr\x22\x3ecomplete\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ complete\x3c\/span\x3e\n                    }\n                })\n            }\n        })\n\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3eregister\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注册代码\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e that = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n        wx.login({ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用登录接口获取 code\x3c\/span\x3e\n            success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e code = res.code;\n                wx.getUserInfo({\n                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用 getUserInfo 获取 encryptedData 和 iv\x3c\/span\x3e\n                    success: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ success\x3c\/span\x3e\n                        that.globalData.userInfo = res.userInfo;\n                        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e encryptedData = res.encryptedData || \x3cspan class=\x22hljs-string\x22\x3e\x27encry\x27\x3c\/span\x3e;\n                        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e iv = res.iv || \x3cspan class=\x22hljs-string\x22\x3e\x27iv\x27\x3c\/span\x3e;\n                        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(iv);\n                        wx.request({ \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 请求注册用户接口\x3c\/span\x3e\n                            url: config.host \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\/auth\/accounts\/wxapp\x27\x3c\/span\x3e,\n                            \x3cspan class=\x22hljs-attr\x22\x3eheader\x3c\/span\x3e: {\n                                \x3cspan class=\x22hljs-attr\x22\x3eAuthorization\x3c\/span\x3e: config.basic_token\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3edata\x3c\/span\x3e: {\n                                \x3cspan class=\x22hljs-attr\x22\x3eusername\x3c\/span\x3e: encryptedData,\n                                \x3cspan class=\x22hljs-attr\x22\x3epassword\x3c\/span\x3e: iv,\n                                \x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: code,\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22POST\x22\x3c\/span\x3e,\n                            \x3cspan class=\x22hljs-attr\x22\x3esuccess\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e201\x3c\/span\x3e) {\n                                    wx.showToast({\n                                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27注册成功\x27\x3c\/span\x3e,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e\n                                    });\n                                    that.login();\n                                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e400\x3c\/span\x3e) {\n                                    wx.showToast({\n                                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27用户已注册\x27\x3c\/span\x3e,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e\n                                    });\n                                    that.login();\n                                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e403\x3c\/span\x3e) {\n                                    wx.showToast({\n                                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: res.data.text,\n                                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e\n                                    });\n                                }\n                                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res.statusCode);\n                                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27request token success\x27\x3c\/span\x3e);\n                            },\n                            \x3cspan class=\x22hljs-attr\x22\x3efail\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27request token fail\x27\x3c\/span\x3e);\n                            }\n                        })\n                    },\n                    \x3cspan class=\x22hljs-attr\x22\x3efail\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fail\x3c\/span\x3e\n                    },\n                    \x3cspan class=\x22hljs-attr\x22\x3ecomplete\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ complete\x3c\/span\x3e\n                    }\n                })\n            }\n        })\n\n    },\n\n    \x3cspan class=\x22hljs-attr\x22\x3eget_user_info\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ejwt\x3c\/span\x3e) \x3c\/span\x3e{\n        wx.request({\n            \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e: config.host \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\/auth\/accounts\/self\x27\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-attr\x22\x3eheader\x3c\/span\x3e: {\n                \x3cspan class=\x22hljs-attr\x22\x3eAuthorization\x3c\/span\x3e: jwt.token_type \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27 \x27\x3c\/span\x3e \x2b jwt.access_token\n            },\n            \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22GET\x22\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-attr\x22\x3esuccess\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e201\x3c\/span\x3e) {\n                    wx.showToast({\n                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27已注册\x27\x3c\/span\x3e,\n                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27success\x27\x3c\/span\x3e\n                    });\n                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e401\x3c\/span\x3e || res.statusCode === \x3cspan class=\x22hljs-number\x22\x3e403\x3c\/span\x3e) {\n                    wx.showToast({\n                        \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27未注册\x27\x3c\/span\x3e,\n                        \x3cspan class=\x22hljs-attr\x22\x3eicon\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e\n                    });\n                }\n\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res.statusCode);\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27request token success\x27\x3c\/span\x3e);\n            },\n            \x3cspan class=\x22hljs-attr\x22\x3efail\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27request token fail\x27\x3c\/span\x3e);\n            }\n        })\n    },\n\n    \x3cspan class=\x22hljs-attr\x22\x3eglobalData\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3euserInfo\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e\n    }\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e服务端代码\x3c\/h3\x3e\n\x3cp\x3e服务端使用 \x3ca href=\x22https:\/\/github.com\/channelcat\/sanic\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3esanic\x3c\/code\x3e\x3c\/a\x3e 框架 \x2b \x3ca href=\x22https:\/\/github.com\/guokr\/swagger-py-codegen\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3eswagger_py_codegen\x3c\/code\x3e\x3c\/a\x3e 生成 rest-api。\x3cbr\x3e数据库使用 MongoDB，\x3ca href=\x22https:\/\/github.com\/gusibi\/python-weixin\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3epython-weixin\x3c\/code\x3e\x3c\/a\x3e 实现了登录过程中 code 换取 session_key 以及 encryptedData 解密的功能，所以使用python-weixin 作为 python 微信 sdk 使用。\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e为了过滤无效请求，服务器端要求用户在获取 token 或授权时在 header 中带上 \x3ccode\x3eAuthorization\x3c\/code\x3e 信息。 \x3ccode\x3eAuthorization\x3c\/code\x3e 在登录前使用的是 Basic 验证（格式 (Basic hashkey) 注 hashkey为client_id \x2b client_secret 做BASE64处理），只是用来校验请求的客户端是否合法。不过Basic 基本等同于明文，并不能用它来进行严格的授权验证。\x3c\/p\x3e\n\x3cp\x3ejwt 原理及使用参见 \x3ca href=\x22https:\/\/mp.weixin.qq.com\/s?__biz=MzAwNjI5MjAzNw==\x26amp;mid=2655752020\x26amp;idx=1\x26amp;sn=b5e56989a57e9b8067eb6614381a04fd\x26amp;chksm=80b0b87eb7c73168d7eb1d7f1a95e759b9b0934318571de4f6d2455402e654e6c09d9b022f25\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e理解JWT（JSON Web Token）认证及实践\x3c\/a\x3e\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e使用 swagger 生成代码结构如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000010414727\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000010414727\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e由于代码太长，这里只放获取 jwt 的逻辑：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22def get_wxapp_userinfo(encrypted_data, iv, code):\n    from weixin.lib.wxcrypt import WXBizDataCrypt\n    from weixin import WXAPPAPI\n    from weixin.oauth2 import OAuth2AuthExchangeError\n    appid = Config.WXAPP_ID\n    secret = Config.WXAPP_SECRET\n    api = WXAPPAPI(appid=appid, app_secret=secret)\n    try:\n        # 使用 code  换取 session key    \n        session_info = api.exchange_code_for_session_key(code=code)\n    except OAuth2AuthExchangeError as e:\n        raise Unauthorized(e.code, e.description)\n    session_key = session_info.get(\x27session_key\x27)\n    crypt = WXBizDataCrypt(appid, session_key)\n    # 解密得到 用户信息\n    user_info = crypt.decrypt(encrypted_data, iv)\n    return user_info\n\n\ndef verify_wxapp(encrypted_data, iv, code):\n    user_info = get_wxapp_userinfo(encrypted_data, iv, code)\n    # 获取 openid\n    openid = user_info.get(\x27openId\x27, None)\n    if openid:\n        auth = Account.get_by_wxapp(openid)\n        if not auth:\n            raise Unauthorized(\x27wxapp_not_registered\x27)\n        return auth\n    raise Unauthorized(\x27invalid_wxapp_code\x27)\n    \n    \ndef create_token(request):\n    # verify basic token\n    approach = request.json.get(\x27auth_approach\x27)\n    username = request.json[\x27username\x27]\n    password = request.json[\x27password\x27]\n    if approach == \x27password\x27:\n        account = verify_password(username, password)\n    elif approach == \x27wxapp\x27:\n        account = verify_wxapp(username, password, request.args.get(\x27code\x27))\n    if not account:\n        return False, {}\n    payload = {\n        \x26quot;iss\x26quot;: Config.ISS,\n        \x26quot;iat\x26quot;: int(time.time()),\n        \x26quot;exp\x26quot;: int(time.time()) \x2b 86400 * 7,\n        \x26quot;aud\x26quot;: Config.AUDIENCE,\n        \x26quot;sub\x26quot;: str(account[\x27_id\x27]),\n        \x26quot;nickname\x26quot;: account[\x27nickname\x27],\n        \x26quot;scopes\x26quot;: [\x27open\x27]\n    }\n    token = jwt.encode(payload, \x27secret\x27, algorithm=\x27HS256\x27)\n    # 由于 account 中 _id 是一个 object 需要转化成字符串\n    return True, {\x27access_token\x27: token, \x27account_id\x27: str(account[\x27_id\x27])}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22python hljs\x22\x3e\x3ccode class=\x22python\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3edef\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eget_wxapp_userinfo\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(encrypted_data, iv, code)\x3c\/span\x3e:\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e weixin.lib.wxcrypt \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e WXBizDataCrypt\n    \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e weixin \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e WXAPPAPI\n    \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e weixin.oauth2 \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e OAuth2AuthExchangeError\n    appid = Config.WXAPP_ID\n    secret = Config.WXAPP_SECRET\n    api = WXAPPAPI(appid=appid, app_secret=secret)\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e:\n        \x3cspan class=\x22hljs-comment\x22\x3e# 使用 code  换取 session key    \x3c\/span\x3e\n        session_info = api.exchange_code_for_session_key(code=code)\n    \x3cspan class=\x22hljs-keyword\x22\x3eexcept\x3c\/span\x3e OAuth2AuthExchangeError \x3cspan class=\x22hljs-keyword\x22\x3eas\x3c\/span\x3e e:\n        \x3cspan class=\x22hljs-keyword\x22\x3eraise\x3c\/span\x3e Unauthorized(e.code, e.description)\n    session_key = session_info.get(\x3cspan class=\x22hljs-string\x22\x3e\x27session_key\x27\x3c\/span\x3e)\n    crypt = WXBizDataCrypt(appid, session_key)\n    \x3cspan class=\x22hljs-comment\x22\x3e# 解密得到 用户信息\x3c\/span\x3e\n    user_info = crypt.decrypt(encrypted_data, iv)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e user_info\n\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3edef\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3everify_wxapp\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(encrypted_data, iv, code)\x3c\/span\x3e:\x3c\/span\x3e\n    user_info = get_wxapp_userinfo(encrypted_data, iv, code)\n    \x3cspan class=\x22hljs-comment\x22\x3e# 获取 openid\x3c\/span\x3e\n    openid = user_info.get(\x3cspan class=\x22hljs-string\x22\x3e\x27openId\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3eNone\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e openid:\n        auth = Account.get_by_wxapp(openid)\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e auth:\n            \x3cspan class=\x22hljs-keyword\x22\x3eraise\x3c\/span\x3e Unauthorized(\x3cspan class=\x22hljs-string\x22\x3e\x27wxapp_not_registered\x27\x3c\/span\x3e)\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e auth\n    \x3cspan class=\x22hljs-keyword\x22\x3eraise\x3c\/span\x3e Unauthorized(\x3cspan class=\x22hljs-string\x22\x3e\x27invalid_wxapp_code\x27\x3c\/span\x3e)\n    \n    \n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3edef\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreate_token\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(request)\x3c\/span\x3e:\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e# verify basic token\x3c\/span\x3e\n    approach = request.json.get(\x3cspan class=\x22hljs-string\x22\x3e\x27auth_approach\x27\x3c\/span\x3e)\n    username = request.json[\x3cspan class=\x22hljs-string\x22\x3e\x27username\x27\x3c\/span\x3e]\n    password = request.json[\x3cspan class=\x22hljs-string\x22\x3e\x27password\x27\x3c\/span\x3e]\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e approach == \x3cspan class=\x22hljs-string\x22\x3e\x27password\x27\x3c\/span\x3e:\n        account = verify_password(username, password)\n    \x3cspan class=\x22hljs-keyword\x22\x3eelif\x3c\/span\x3e approach == \x3cspan class=\x22hljs-string\x22\x3e\x27wxapp\x27\x3c\/span\x3e:\n        account = verify_wxapp(username, password, request.args.get(\x3cspan class=\x22hljs-string\x22\x3e\x27code\x27\x3c\/span\x3e))\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enot\x3c\/span\x3e account:\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eFalse\x3c\/span\x3e, {}\n    payload = {\n        \x3cspan class=\x22hljs-string\x22\x3e\x22iss\x22\x3c\/span\x3e: Config.ISS,\n        \x3cspan class=\x22hljs-string\x22\x3e\x22iat\x22\x3c\/span\x3e: int(time.time()),\n        \x3cspan class=\x22hljs-string\x22\x3e\x22exp\x22\x3c\/span\x3e: int(time.time()) \x2b \x3cspan class=\x22hljs-number\x22\x3e86400\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-string\x22\x3e\x22aud\x22\x3c\/span\x3e: Config.AUDIENCE,\n        \x3cspan class=\x22hljs-string\x22\x3e\x22sub\x22\x3c\/span\x3e: str(account[\x3cspan class=\x22hljs-string\x22\x3e\x27_id\x27\x3c\/span\x3e]),\n        \x3cspan class=\x22hljs-string\x22\x3e\x22nickname\x22\x3c\/span\x3e: account[\x3cspan class=\x22hljs-string\x22\x3e\x27nickname\x27\x3c\/span\x3e],\n        \x3cspan class=\x22hljs-string\x22\x3e\x22scopes\x22\x3c\/span\x3e: [\x3cspan class=\x22hljs-string\x22\x3e\x27open\x27\x3c\/span\x3e]\n    }\n    token = jwt.encode(payload, \x3cspan class=\x22hljs-string\x22\x3e\x27secret\x27\x3c\/span\x3e, algorithm=\x3cspan class=\x22hljs-string\x22\x3e\x27HS256\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-comment\x22\x3e# 由于 account 中 _id 是一个 object 需要转化成字符串\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eTrue\x3c\/span\x3e, {\x3cspan class=\x22hljs-string\x22\x3e\x27access_token\x27\x3c\/span\x3e: token, \x3cspan class=\x22hljs-string\x22\x3e\x27account_id\x27\x3c\/span\x3e: str(account[\x3cspan class=\x22hljs-string\x22\x3e\x27_id\x27\x3c\/span\x3e])}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e具体代码可以在 \x3ca href=\x22https:\/\/github.com\/gusibi\/Metis\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMetis：https:\/\/github.com\/gusibi\/Metis\x3c\/a\x3e 查看。\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e\x3ccode\x3eNote\x3c\/code\x3e: 如果试用代码，请先设定 oauth2_client，使用自己的配置。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e不要将私密配置信息提交到 github。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3e参考链接\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/www.cnblogs.com\/ihardcoder\/p\/6279602.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e《微信小程序七日谈》- 第五天：你可能要在登录功能上花费大力气\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/mp.weixin.qq.com\/s?__biz=MzAwNjI5MjAzNw==\x26amp;mid=2655752020\x26amp;idx=1\x26amp;sn=b5e56989a57e9b8067eb6614381a04fd\x26amp;chksm=80b0b87eb7c73168d7eb1d7f1a95e759b9b0934318571de4f6d2455402e654e6c09d9b022f25\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e理解JWT（JSON Web Token）认证及实践\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/blog.gusibi.com\/post\/weixin-python-login\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e网站微信登录－python 实现\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3chr\x3e\n\x3cp\x3e最后，感谢女朋友支持。\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth\x3e欢迎关注(April_Louisa)\x3c\/th\x3e\n\x3cth\x3e请我喝芬达\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\x3ctr\x3e\n\x3ctd\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009873993?w=430\x26amp;h=430\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009873993?w=430\x26amp;h=430\x22 alt=\x22欢迎关注\x22 title=\x22欢迎关注\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/td\x3e\n\x3ctd\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009873994?w=425\x26amp;h=425\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009873994?w=425\x26amp;h=425\x22 alt=\x22请我喝芬达\x22 title=\x22请我喝芬达\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/td\x3e\n\x3c\/tr\x3e\x3c\/tbody\x3e\n\x3c\/table\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>微信小程序开发：python+sanic 实现小程序登录注册</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010414722">https://segmentfault.com/a/1190000010414722</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/4uaieeadljm/" target="_blank">https://alili.tech/archive/4uaieeadljm/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>