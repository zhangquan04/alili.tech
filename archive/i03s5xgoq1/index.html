<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="秒杀 tj/co 的 hprose 协程库"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>秒杀 tj/co 的 hprose 协程库 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/i03s5xgoq1/",
				"appid": "1613049289050283", 
				"title": "秒杀 tj/co 的 hprose 协程库 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-31T02:31:16"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/rcthy000sg/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/74yvxrfyspv/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&text=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&text=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&title=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&is_video=false&description=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&title=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&title=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&title=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fi03s5xgoq1%2f&title=%e7%a7%92%e6%9d%80%20tj%2fco%20%e7%9a%84%20hprose%20%e5%8d%8f%e7%a8%8b%e5%ba%93"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">秒杀 tj/co 的 hprose 协程库</h1><div class="meta"><div class="postdate"><time datetime="2019-01-31" itemprop="datePublished">2019-01-31</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3eES6 中引入了 Generator，Generator 通过封装之后，可以作为协程来进行使用。\x3c\/p\x3e\n\x3cp\x3e其中对 Generator 封装最为著名的当属 tj\/co，但是 tj\/co 跟 ES2016 的 async\/await 相比的话，还存在一些比较严重的缺陷。\x3c\/p\x3e\n\x3cp\x3ehprose 中也引入了对 Generator 封装的协程支持，但是比 tj\/co 更加完善，下面我们就来详细介绍一下它们之间的差别。\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/tj\/co\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3etj\/co\x3c\/code\x3e\x3c\/a\x3e 有以下几个方面的问题：\x3c\/p\x3e\n\x3cp\x3e首先，\x3ccode\x3etj\/co\x3c\/code\x3e 库中的 \x3ccode\x3eyield\x3c\/code\x3e 只支持 thunk 函数，生成器函数，promise 对象，以及数组和对象，但是不支持普通的基本类型的数据，比如 \x3ccode\x3enull\x3c\/code\x3e, 数字，字符串等都不支持。这对于 \x3ccode\x3eyield\x3c\/code\x3e 一个类型不确定的变量来说，是很不方便的。而且这跟 \x3ccode\x3eawait\x3c\/code\x3e 也是不兼容的。\x3c\/p\x3e\n\x3cp\x3e其次，在 \x3ccode\x3eyield\x3c\/code\x3e 数组和对象时，\x3ccode\x3etj\/co\x3c\/code\x3e 库会自动对数组中的元素和对象中的字段递归的遍历，将其中的所有的 \x3ccode\x3ePromise\x3c\/code\x3e 元素和字段替换为实际值，这对于简单的数据来说，会方便一些。但是对于带有循环引用的数组和对象来说，会导致无法获取到结果，这是一个致命的问题。即使对于不带有循环引用结构的数组和对象来说，如果该数组和对象比较复杂，这也会消耗大量的时间。而且这跟 \x3ccode\x3eawait\x3c\/code\x3e 也是不兼容的。\x3c\/p\x3e\n\x3cp\x3e再次，对于 thunk 函数，\x3ccode\x3etj\/co\x3c\/code\x3e 库会认为回调函数第一个参数必须是表示错误，从第二个参数开始才表示返回值。而这对于回调函数只有一个返回值参数的函数，或者回调函数的第一个参数不表示错误的函数来说，\x3ccode\x3etj\/co\x3c\/code\x3e 库就无法使用了。\x3c\/p\x3e\n\x3cp\x3e而 \x3ccode\x3ehprose.co\x3c\/code\x3e 对 \x3ccode\x3eyield\x3c\/code\x3e 的支持则跟 \x3ccode\x3eawait\x3c\/code\x3e 完全兼容，支持对所有类型的数据进行 \x3ccode\x3eyield\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e当 \x3ccode\x3ehprose.co\x3c\/code\x3e 对 chunk 函数进行 \x3ccode\x3eyield\x3c\/code\x3e 时，如果回调函数第一个参数是 \x3ccode\x3eError\x3c\/code\x3e 类型的对象才会被当做错误处理。如果回调函数只有一个参数且不是 \x3ccode\x3eError\x3c\/code\x3e 类型的对象，则作为返回值对待。如果回调函数有两个以上的参数，如果第一个参数为 \x3ccode\x3enull\x3c\/code\x3e 或 \x3ccode\x3eundefined\x3c\/code\x3e，则第一个参数被当做无错误被忽略，否则，全部回调参数都被当做返回值对待。如果被当做返回值的回调参数有多个，则这多个参数被当做数组结果对待，如果只有一个，则该参数被直接当做返回值对待。\x3c\/p\x3e\n\x3cp\x3e下面我们来举例说明一下：\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3eyield 基本类型\x3c\/h2\x3e\n\x3cp\x3e首先我们来看一下 \x3ccode\x3etj\/co\x3c\/code\x3e 库的例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var co = require(\x27co\x27);\n\nco(function*() {\n    try {\n        console.log(yield Promise.resolve(\x26quot;promise\x26quot;));\n        console.log(yield function *() { return \x26quot;generator\x26quot; });\n        console.log(yield new Date());\n        console.log(yield 123);\n        console.log(yield 3.14);\n        console.log(yield \x26quot;hello\x26quot;);\n        console.log(yield true);\n    }\n    catch (e) {\n        console.error(e);\n    }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27co\x27\x3c\/span\x3e);\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(\x3cspan class=\x22hljs-string\x22\x3e\x22promise\x22\x3c\/span\x3e));\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22generator\x22\x3c\/span\x3e });\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e());\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e123\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e3.14\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22hello\x22\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e该程序运行结果为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22promise\ngenerator\nTypeError: You may only yield a function, promise, generator, array, or object, but the following object was passed: \x26quot;Sat Nov 19 2016 14:51:09 GMT\x2b0800 (CST)\x26quot;\n    at next (\/usr\/local\/lib\/node_modules\/co\/index.js:101:25)\n    at onFulfilled (\/usr\/local\/lib\/node_modules\/co\/index.js:69:7)\n    at process._tickCallback (internal\/process\/next_tick.js:103:7)\n    at Module.runMain (module.js:577:11)\n    at run (bootstrap_node.js:352:7)\n    at startup (bootstrap_node.js:144:9)\n    at bootstrap_node.js:467:3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3epromise\ngenerator\nTypeError: You may only yield \x3cspan class=\x22hljs-selector-tag\x22\x3ea\x3c\/span\x3e function, promise, generator, array, or \x3cspan class=\x22hljs-selector-tag\x22\x3eobject\x3c\/span\x3e, but the following \x3cspan class=\x22hljs-selector-tag\x22\x3eobject\x3c\/span\x3e was passed: \x3cspan class=\x22hljs-string\x22\x3e\x22Sat Nov 19 2016 14:51:09 GMT\x2b0800 (CST)\x22\x3c\/span\x3e\n    at next (\/usr\/local\/lib\/node_modules\/co\/index\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e101\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e25\x3c\/span\x3e)\n    at onFulfilled (\/usr\/local\/lib\/node_modules\/co\/index\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e69\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e)\n    at process._tickCallback (internal\/process\/next_tick\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e103\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e)\n    at Module\x3cspan class=\x22hljs-selector-class\x22\x3e.runMain\x3c\/span\x3e (module\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e577\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e11\x3c\/span\x3e)\n    at run (bootstrap_node\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e352\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e)\n    at startup (bootstrap_node\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e144\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9\x3c\/span\x3e)\n    at bootstrap_node\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e467\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其实除了前两个，后面的几个基本类型的数据都不能被 \x3ccode\x3eyield\x3c\/code\x3e。如果我们把上面代码的第一句改为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var co = require(\x27hprose\x27).co;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27hprose\x27\x3c\/span\x3e).co;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e后面的代码都不需要修改，我们来看看运行结果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22promise\ngenerator\n2016-11-19T06:54:30.081Z\n123\n3.14\nhello\ntrue\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-tag\x22\x3epromise\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3egenerator\x3c\/span\x3e\n2016\x3cspan class=\x22hljs-selector-tag\x22\x3e-11-19T06\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:54\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:30.081Z\x3c\/span\x3e\n123\n3\x3cspan class=\x22hljs-selector-class\x22\x3e.14\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3ehello\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3etrue\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e也就是说，\x3ccode\x3ehprose.co\x3c\/code\x3e 支持对所有类型进行 \x3ccode\x3eyield\x3c\/code\x3e 操作。下面我们再来看看 async\/await 是什么效果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(async function() {\n    try {\n        console.log(await Promise.resolve(\x26quot;promise\x26quot;));\n        console.log(await function *() { return \x26quot;generator\x26quot; });\n        console.log(await new Date());\n        console.log(await 123);\n        console.log(await 3.14);\n        console.log(await \x26quot;hello\x26quot;);\n        console.log(await true);\n    }\n    catch (e) {\n        console.error(e);\n    }\n})();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(\x3cspan class=\x22hljs-string\x22\x3e\x22promise\x22\x3c\/span\x3e));\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22generator\x22\x3c\/span\x3e });\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e());\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e123\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e3.14\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22hello\x22\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n})();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面的代码基本上就是把 \x3ccode\x3eco(function*...)\x3c\/code\x3e 替换成了 \x3ccode\x3easync function...\x3c\/code\x3e，把 \x3ccode\x3eyield\x3c\/code\x3e 替换成了 \x3ccode\x3eawait\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e我们来运行上面的程序，注意，对于当前版本的 node 运行时需要加上 \x3ccode\x3e--harmony_async_await\x3c\/code\x3e 参数，运行结果如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22promise\n[Function]\n2016-11-19T08:16:25.316Z\n123\n3.14\nhello\ntrue\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-tag\x22\x3epromise\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-attr\x22\x3e[Function]\x3c\/span\x3e\n2016\x3cspan class=\x22hljs-selector-tag\x22\x3e-11-19T08\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:16\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:25.316Z\x3c\/span\x3e\n123\n3\x3cspan class=\x22hljs-selector-class\x22\x3e.14\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3ehello\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3etrue\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们可以看出，\x3ccode\x3eawait\x3c\/code\x3e 和 \x3ccode\x3ehprose.co\x3c\/code\x3e 除了对生成器的处理不同以外，其它的都相同。对于生成器函数，\x3ccode\x3eawait\x3c\/code\x3e 是按原样返回的，而 \x3ccode\x3ehprose.co\x3c\/code\x3e 则是按照 \x3ccode\x3etj\/co\x3c\/code\x3e 的方式处理。也就是说 \x3ccode\x3ehprose.co\x3c\/code\x3e 综合了 \x3ccode\x3eawait\x3c\/code\x3e 和 \x3ccode\x3etj\/co\x3c\/code\x3e 的全部优点。使用 \x3ccode\x3ehprose.co\x3c\/code\x3e 比使用 \x3ccode\x3eawait\x3c\/code\x3e 或 \x3ccode\x3etj\/co\x3c\/code\x3e 都方便。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eyield 数组或对象\x3c\/h2\x3e\n\x3cp\x3e我们来看第二个让 \x3ccode\x3etj\/co\x3c\/code\x3e 崩溃的例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var co = require(\x27co\x27);\n\nco(function*() {\n    try {\n        var a = [];\n        for (i = 0; i \x3c 1000000; i\x2b\x2b) {\n            a[i] = i;\n        }\n        var start = Date.now();;\n        yield a;\n        var end = Date.now();;\n        console.log(end - start);\n    }\n    catch (e) {\n        console.error(e);\n    }\n});\n\nco(function*() {\n    try {\n        var a = [];\n        a[0] = a;\n        console.log(yield a);\n    }\n    catch (e) {\n        console.error(e);\n    }\n});\n\nco(function*() {\n    try {\n        var o = {};\n        o.self = o;\n        console.log(yield o);\n    }\n    catch (e) {\n        console.error(e);\n    }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27co\x27\x3c\/span\x3e);\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e a = [];\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; \x3cspan class=\x22hljs-number\x22\x3e1000000\x3c\/span\x3e; i\x2b\x2b) {\n            a[i] = i;\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e start = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();;\n        \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e a;\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e end = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(end - start);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e a = [];\n        a[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] = a;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e a);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e o = {};\n        o.self = o;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e o);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e运行该程序，我们会看到程序会卡一会儿，然后出现下面的结果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x222530\n(node:70754) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): RangeError: Maximum call stack size exceeded\n(node:70754) DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\n(node:70754) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 2): RangeError: Maximum call stack size exceeded\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs crmsh\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e2530\x3c\/span\x3e\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:70754\x3c\/span\x3e) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e): RangeError: Maximum call stack size exceeded\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:70754\x3c\/span\x3e) DeprecationWarning: Unhandled promise rejections are deprecated. \x3cspan class=\x22hljs-keyword\x22\x3eIn\x3c\/span\x3e the future, promise rejections that are not handled will terminate the \x3cspan class=\x22hljs-keyword\x22\x3eNode\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3ejs\x3c\/span\x3e process with a non-zero exit code.\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:70754\x3c\/span\x3e) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e): RangeError: Maximum call stack size exceeded\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面的 \x3ccode\x3e2530\x3c\/code\x3e 是第一个 \x3ccode\x3eco\x3c\/code\x3e 程序段输出的结果，也就是说这个 \x3ccode\x3eyield\x3c\/code\x3e 要等待 2.5 秒才能返回结果。而后面两个 \x3ccode\x3eco\x3c\/code\x3e 程序段则直接调用栈溢出了。如果在实际应用中，出现了这样的数据，使用 \x3ccode\x3etj\/co\x3c\/code\x3e 你的程序就会变得很慢，或者直接崩溃了。\x3c\/p\x3e\n\x3cp\x3e下面看看 \x3ccode\x3ehprose.co\x3c\/code\x3e 的效果，同样只替换第一句话为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var co = require(\x27hprose\x27).co;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27hprose\x27\x3c\/span\x3e).co;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e后面的代码都不需要修改，我们来看看运行结果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x227\n[ [Circular] ]\n{ self: [Circular] }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e7\n\x3cspan class=\x22hljs-selector-attr\x22\x3e[ [Circular]\x3c\/span\x3e ]\n{ \x3cspan class=\x22hljs-attribute\x22\x3eself\x3c\/span\x3e: [Circular] }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第一个 \x3ccode\x3eco\x3c\/code\x3e 程序段用时很短，只需要 \x3ccode\x3e7\x3c\/code\x3e ms。注意，这还是包含了后面两个程序段的时间，因为这三个协程是并发的，如果去掉后面两个程序段，你看的输出可能是 \x3ccode\x3e1\x3c\/code\x3e ms 或者 \x3ccode\x3e0\x3c\/code\x3e ms。而后面两个程序段也完美的返回了带有循环引用的数据。这才是我们期望的结果。\x3c\/p\x3e\n\x3cp\x3e我们再来看看 \x3ccode\x3easync\/await\x3c\/code\x3e 下是什么效果，程序代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(async function() {\n    try {\n        var a = [];\n        for (i = 0; i \x3c 1000000; i\x2b\x2b) {\n            a[i] = i;\n        }\n        var start = Date.now();\n        await a;\n        var end = Date.now();\n        console.log(end - start);\n    }\n    catch (e) {\n        console.error(e);\n    }\n})();\n\n(async function() {\n    try {\n        var a = [];\n        a[0] = a;\n        console.log(await a);\n    }\n    catch (e) {\n        console.error(e);\n    }\n})();\n\n(async function() {\n    try {\n        var o = {};\n        o.self = o;\n        console.log(await o);\n    }\n    catch (e) {\n        console.error(e);\n    }\n})();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e a = [];\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; \x3cspan class=\x22hljs-number\x22\x3e1000000\x3c\/span\x3e; i\x2b\x2b) {\n            a[i] = i;\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e start = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();\n        \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e a;\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e end = \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e.now();\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(end - start);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n})();\n\n(\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e a = [];\n        a[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] = a;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e a);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n})();\n\n(\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e o = {};\n        o.self = o;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e o);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(e);\n    }\n})();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e运行结果如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x2214\n[ [Circular] ]\n{ self: [Circular] }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e14\n\x3cspan class=\x22hljs-selector-attr\x22\x3e[ [Circular]\x3c\/span\x3e ]\n{ \x3cspan class=\x22hljs-attribute\x22\x3eself\x3c\/span\x3e: [Circular] }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们发现 \x3ccode\x3easync\/await\x3c\/code\x3e 的输出结果跟 \x3ccode\x3ehprose.co\x3c\/code\x3e 是一致的，但是在性能上，\x3ccode\x3ehprose.co\x3c\/code\x3e 则比 \x3ccode\x3easync\/await\x3c\/code\x3e 还要快 1 倍。因此，第二个回合，\x3ccode\x3ehprose.co\x3c\/code\x3e 仍然是完胜 \x3ccode\x3etj\/co\x3c\/code\x3e 和 \x3ccode\x3easync\/await\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3eyield thunk 函数\x3c\/h2\x3e\n\x3cp\x3e我们再来看看 \x3ccode\x3etj\/co\x3c\/code\x3e 和 \x3ccode\x3etj\/thunkify\x3c\/code\x3e 是多么的让人抓狂，以及 \x3ccode\x3ehprose.co\x3c\/code\x3e 和 \x3ccode\x3ehprose.thunkify\x3c\/code\x3e 是如何优雅的解决 \x3ccode\x3etj\/co\x3c\/code\x3e 和 \x3ccode\x3etj\/thunkify\x3c\/code\x3e 带来的这些让人抓狂的问题的。\x3c\/p\x3e\n\x3cp\x3e首先我们来看第一个问题：\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3etj\/thunkify\x3c\/code\x3e 返回的 thunk 函数的执行结果是一次性的，不能像 \x3ccode\x3epromise\x3c\/code\x3e 结果那样被使用多次，我们来看看下面这个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var co = require(\x26quot;co\x26quot;);\nvar thunkify = require(\x26quot;thunkify\x26quot;);\n\nvar sum = thunkify(function(a, b, callback) {\n    callback(null, a \x2b b);\n});\n\nco(function*() {\n    var result = sum(1, 2);\n    console.log(yield result);\n    console.log(yield sum(2, 3));\n    console.log(yield result);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22co\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e thunkify = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22thunkify\x22\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = thunkify(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ea, b, callback\x3c\/span\x3e) \x3c\/span\x3e{\n    callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, a \x2b b);\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e));\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个例子很简单，输出结果你猜是啥？\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n5\n3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e是上面的结果吗？恭喜你，答错了！不过，这不是你的错，而是 \x3ccode\x3etj\/thunkify\x3c\/code\x3e 的错，它的结果是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n5\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e什么？最后的 \x3ccode\x3econsole.log(yield result)\x3c\/code\x3e 输出结果哪儿去了？不好意思，\x3ccode\x3etj\/thunkify\x3c\/code\x3e 解释说是为了防止 \x3ccode\x3ecallback\x3c\/code\x3e 被重复执行，所以就只能这么玩了。可是真的是这样吗？\x3c\/p\x3e\n\x3cp\x3e我们来看看使用 \x3ccode\x3ehprose.co\x3c\/code\x3e 和 \x3ccode\x3ehprose.thunkify\x3c\/code\x3e 的执行结果吧，把开头两行换成下面三行：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var hprose = require(\x26quot;hprose\x26quot;);\nvar co = hprose.co;\nvar thunkify = hprose.thunkify;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e hprose = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22hprose\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e co = hprose.co;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e thunkify = hprose.thunkify;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其它代码都不用改，运行它，你会发现预期的结果出来了，就是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n5\n3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可能你还不服气，你会说，\x3ccode\x3etj\/thunkify\x3c\/code\x3e 这样做是为了防止类似被 \x3ccode\x3ethunkify\x3c\/code\x3e 的函数中，回调被多次调用时，\x3ccode\x3eyield\x3c\/code\x3e 的结果不正确，比如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var sum = thunkify(function(a, b, callback) {\n    callback(null, a \x2b b);\n    callback(null, a \x2b b \x2b a);\n});\n\nco(function*() {\n    var result = sum(1, 2);\n    console.log(yield result);\n    console.log(yield sum(2, 3));\n    console.log(yield result);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = thunkify(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ea, b, callback\x3c\/span\x3e) \x3c\/span\x3e{\n    callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, a \x2b b);\n    callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, a \x2b b \x2b a);\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e));\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果 \x3ccode\x3etj\/thunkify\x3c\/code\x3e 不这样做，结果可能就会变成：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n4\n5\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可是真的是这样吗？你会发现，即使改成上面的样子，\x3ccode\x3ehprose.thunkify\x3c\/code\x3e 配合 \x3ccode\x3ehprose.co\x3c\/code\x3e 返回的结果仍然是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n5\n3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e跟预期的一样，回调函数并没有重复执行，错误的结果并没有出现。而且当需要重复 \x3ccode\x3eyield\x3c\/code\x3e 结果函数时，还能够正确得到结果。\x3c\/p\x3e\n\x3cp\x3e最后我们再来看一下，\x3ccode\x3etj\/thunkify\x3c\/code\x3e 这样做真的解决了问题了吗？我们把代码改成下面这样：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var sum = thunkify(function(a, b, callback) {\n    console.log(\x26quot;call sum(\x26quot; \x2b Array.prototype.join.call(arguments) \x2b \x26quot;)\x26quot;);\n    callback(null, a \x2b b);\n    callback(null, a \x2b b \x2b a);\n});\n\nco(function*() {\n    var result = sum(1, 2);\n    console.log(yield result);\n    console.log(yield sum(2, 3));\n    console.log(yield result);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = thunkify(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ea, b, callback\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22call sum(\x22\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype.join.call(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22)\x22\x3c\/span\x3e);\n    callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, a \x2b b);\n    callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, a \x2b b \x2b a);\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e));\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后替换不同的 \x3ccode\x3eco\x3c\/code\x3e 和 \x3ccode\x3ethunkify\x3c\/code\x3e，然后执行，我们会发现，\x3ccode\x3etj\x3c\/code\x3e 版本的输出如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22call sum(1,2,function (){\n        if (called) return;\n        called = true;\n        done.apply(null, arguments);\n      })\n3\ncall sum(2,3,function (){\n        if (called) return;\n        called = true;\n        done.apply(null, arguments);\n      })\n5\ncall sum(1,2,function (){\n        if (called) return;\n        called = true;\n        done.apply(null, arguments);\n      },function (){\n        if (called) return;\n        called = true;\n        done.apply(null, arguments);\n      })\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3ecall sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (called) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n        called = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n        done.apply(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n      })\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\ncall sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (called) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n        called = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n        done.apply(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n      })\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\ncall sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (called) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n        called = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n        done.apply(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n      },\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (called) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n        called = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n        done.apply(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n      })\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而 \x3ccode\x3ehprose\x3c\/code\x3e 版本的输出结果如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22call sum(1,2,function () {\n                thisArg = this;\n                results.resolve(arguments);\n            })\n3\ncall sum(2,3,function () {\n                thisArg = this;\n                results.resolve(arguments);\n            })\n5\n3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3ecall sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                thisArg = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n                results.resolve(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n            })\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\ncall sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                thisArg = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n                results.resolve(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e);\n            })\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e从这里，我们可以看出，\x3ccode\x3etj\x3c\/code\x3e 版本的程序在执行第二次 \x3ccode\x3eyield result\x3c\/code\x3e 时，简直错的离谱，它不但没有让我们得到预期的结果，反而还重复执行了 \x3ccode\x3ethunkify\x3c\/code\x3e 后的函数，而且带入的参数也完全不对了，所以，这是一个完全错误的实现。\x3c\/p\x3e\n\x3cp\x3e而从 \x3ccode\x3ehprose\x3c\/code\x3e 版本的输出来看，\x3ccode\x3ehprose\x3c\/code\x3e 不但完美的避免了回调被重复执行，而且保证了被 \x3ccode\x3ethunkify\x3c\/code\x3e 后的函数执行的结果被多次 \x3ccode\x3eyield\x3c\/code\x3e 时，也不会被重复执行，而且还能够得到预期的结果，可以实现跟返回 promise 对象一样的效果。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3etj\x3c\/code\x3e 因为没有解决他所实现的 \x3ccode\x3ethunkify\x3c\/code\x3e 函数带来的这些问题，所以在后期推荐大家放弃 \x3ccode\x3ethunkify\x3c\/code\x3e，转而投奔到返回 \x3ccode\x3epromise\x3c\/code\x3e 对象的怀抱中，而实际上，这个问题并非是不能解决的。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3ehprose\x3c\/code\x3e 在对 \x3ccode\x3ethunkify\x3c\/code\x3e 函数的处理上，再次完胜 \x3ccode\x3etj\x3c\/code\x3e。而这个回合中，\x3ccode\x3easync\/await\x3c\/code\x3e 就不用提了，因为 \x3ccode\x3easync\/await\x3c\/code\x3e 完全不支持对 thunk 函数进行 \x3ccode\x3eawait\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e这还不是 \x3ccode\x3ehprose.co\x3c\/code\x3e 和 \x3ccode\x3ehprose.thunkify\x3c\/code\x3e 的全部呢，再继续看下面这个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var sum = thunkify(function(a, b, callback) {\n    callback(a \x2b b);\n});\n\nco(function*() {\n    var result = sum(1, 2);\n    console.log(yield result);\n    console.log(yield sum(2, 3));\n    console.log(yield result);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = thunkify(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ea, b, callback\x3c\/span\x3e) \x3c\/span\x3e{\n    callback(a \x2b b);\n});\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = sum(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e sum(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e));\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e result);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里开头对 \x3ccode\x3ehprose\x3c\/code\x3e 和 \x3ccode\x3etj\x3c\/code\x3e 版本的不同 \x3ccode\x3eco\x3c\/code\x3e 和 \x3ccode\x3ethunkify\x3c\/code\x3e 实现的引用就省略了，请大家自行脑补。\x3c\/p\x3e\n\x3cp\x3e上面这段程序，如果使用 \x3ccode\x3etj\x3c\/code\x3e 版本的 \x3ccode\x3eco\x3c\/code\x3e 和 \x3ccode\x3ethunkify\x3c\/code\x3e 实现，运行结果是这样的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22(node:75927) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 2): 3\n(node:75927) DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs crmsh\x22\x3e\x3ccode\x3e(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:75927\x3c\/span\x3e) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e): \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n(\x3cspan class=\x22hljs-keyword\x22\x3enode\x3c\/span\x3e\x3cspan class=\x22hljs-title\x22\x3e:75927\x3c\/span\x3e) DeprecationWarning: Unhandled promise rejections are deprecated. \x3cspan class=\x22hljs-keyword\x22\x3eIn\x3c\/span\x3e the future, promise rejections that are not handled will terminate the \x3cspan class=\x22hljs-keyword\x22\x3eNode\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3ejs\x3c\/span\x3e process with a non-zero exit code.\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而如果使用 \x3ccode\x3ehprose\x3c\/code\x3e 版本的 \x3ccode\x3eco\x3c\/code\x3e 和 \x3ccode\x3ethunkify\x3c\/code\x3e 实现，运行结果是这样的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x223\n5\n3\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ehprose\x3c\/code\x3e 版本的运行结果再次符合预期，而 \x3ccode\x3etj\x3c\/code\x3e 版本的运行结果再次让人失望之极。\x3c\/p\x3e\n\x3cp\x3e进过上面三个回合的较量，我们发现 hprose 的协程完胜 \x3ccode\x3etj\x3c\/code\x3e 和 \x3ccode\x3easync\/await\x3c\/code\x3e，而且 \x3ccode\x3etj\x3c\/code\x3e 的实现是惨败，\x3ccode\x3easync\/await\x3c\/code\x3e 虽然比 \x3ccode\x3etj\x3c\/code\x3e 稍微好那么一点，但是跟 \x3ccode\x3ehprose\x3c\/code\x3e 所实现协程比起来，也是望尘莫及。\x3c\/p\x3e\n\x3cp\x3e所以，用 \x3ccode\x3etj\/co\x3c\/code\x3e 和 \x3ccode\x3easync\/await\x3c\/code\x3e 感觉很不爽的同学，可以试试 \x3ccode\x3ehprose.co\x3c\/code\x3e 了，绝对让你爽歪歪。\x3c\/p\x3e\n\x3cp\x3ehprose 有 4 个 JavaScript 版本，它们都支持上面的协程库，它们的地址分别是：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-nodejs\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehprose for Node.js\x3c\/a\x3e(\x3ca href=\x22https:\/\/git.oschina.net\/andot\/hprose-nodejs\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoschina镜像\x3c\/a\x3e)\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-html5\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehprose for HTML5\x3c\/a\x3e(\x3ca href=\x22https:\/\/git.oschina.net\/andot\/hprose-html5\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoschina镜像\x3c\/a\x3e)\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehprose for JavaScript\x3c\/a\x3e(\x3ca href=\x22https:\/\/git.oschina.net\/andot\/hprose-js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoschina镜像\x3c\/a\x3e)\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-wx\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehprose for 微信小程序\x3c\/a\x3e(\x3ca href=\x22https:\/\/git.oschina.net\/andot\/hprose-wx\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoschina镜像\x3c\/a\x3e)\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e另外，如果你不需要使用 hprose 序列化和远程调用的话，下面还有一个专门的从 hprose 中精简出来的 Promise A\x2b 实现和协程库：\x3ca href=\x22https:\/\/github.com\/andot\/future-js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eFuture.js\x3c\/a\x3e(\x3ca href=\x22https:\/\/git.oschina.net\/hprose\/future-js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoschina镜像\x3c\/a\x3e)\x3c\/p\x3e\n\x3cp\x3e当然该协程库的功能不止于此，更多介绍请参见：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-nodejs\/wiki\/Promise-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ePromise 异步编程\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hprose\/hprose-nodejs\/wiki\/%E5%8D%8F%E7%A8%8B\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e协程\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>秒杀 tj/co 的 hprose 协程库</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000007573266">https://segmentfault.com/a/1190000007573266</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/i03s5xgoq1/" target="_blank">https://alili.tech/archive/i03s5xgoq1/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>