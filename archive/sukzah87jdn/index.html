<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="socket.io搭配pm2（cluster）集群解决方案"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>socket.io搭配pm2（cluster）集群解决方案 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/sukzah87jdn/",
				"appid": "1613049289050283", 
				"title": "socket.io搭配pm2（cluster）集群解决方案 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-13T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/sxc2zel0ccl/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/lz1aostfuxf/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&text=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&text=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&title=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&is_video=false&description=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&title=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&title=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&title=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fsukzah87jdn%2f&title=socket.io%e6%90%ad%e9%85%8dpm2%ef%bc%88cluster%ef%bc%89%e9%9b%86%e7%be%a4%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">socket.io搭配pm2（cluster）集群解决方案</h1><div class="meta"><div class="postdate"><time datetime="2019-01-13" itemprop="datePublished">2019-01-13</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e可以收藏\x3ca href=\x22http:\/\/www.cnblogs.com\/accordion\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e我的博客\x3c\/a\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3esocket.io与cluster\x3c\/h2\x3e\n\x3cp\x3e在线上系统中，需要使用node的多进程模型，我们可以自己实现简易的基于cluster模式的socket分发模型，也可以使用比较稳定的pm2这样进程管理工具。在常规的http服务中，这套模式一切正常，可是一旦server中集成了socket.io服务就会导致ws通道建立失败，即使通过backup的polling方式仍会出现时断时连的现象，因此我们需要解决这种问题，让socket.io充分利用多核。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e在这里之所以提到socket.io而未说websocket服务，是因为socket.io在封装websocket基础上又保证了可用性。在客户端未提供websocket功能的基础上使用xhr polling、jsonp或forever iframe的方式进行兼容，同时在建立ws连接前往往通过几次http轮训确保ws服务可用，因此socket.io并不等于websocket。再往底层深入研究，socket.io其实并没有做真正的websocket兼容，而是提供了上层的接口以及namespace服务，真正的逻辑则是在“engine.io”模块。该模块实现握手的http代理、连接升级、心跳、传输方式等，因此研究engine.io模块才能清楚的了解socket.io实现机制。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e场景重现\x3c\/h2\x3e\n\x3cp\x3e服务端采用express\x2bsocket.io的组合方案，搭配pm2的cluster模式，实现一个简易的b\/s通信demo：\x3c\/p\x3e\n\x3cp\x3eapp.js\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var path = require(\x27path\x27);\nvar app = require(\x27express\x27)(),\n    server = require(\x27http\x27).createServer(app),\n    io = require(\x27socket.io\x27)(server);\n\nio\n  .on(\x27connection\x27, function(socket) {\n      socket.on(\x27disconnect\x27, function() {\n          console.log(\x27\/: disconnect--------\x3e\x27)\n      });\n\n      socket.on(\x27b:message\x27, function() {\n          socket.emit(\x27s:message\x27, \x27\/: \x27\x2bport);\n          console.log(\x27\/: \x27\x2bport)\n      });\n  });\n\nio.of(\x27\/ws\x27)\n  .on(\x27connection\x27, function(socket) {\n    socket.on(\x27disconnect\x27, function() {\n        console.log(\x27\/ws: disconnect--------\x3e\x27)\n    });\n\n    socket.on(\x27b:message\x27, function() {\n        socket.emit(\x27\/ws: message\x27, port);\n    });\n});\n\napp.get(\x27\/page\x27,function(req,res){\n    res.sendFile(path.join(process.cwd(),\x27.\/index.html\x27));\n});\n\nserver.listen(8080);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e app = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e)(),\n    server = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27http\x27\x3c\/span\x3e).createServer(app),\n    io = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27socket.io\x27\x3c\/span\x3e)(server);\n\nio\n  .on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e) \x3c\/span\x3e{\n      socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27disconnect\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27\/: disconnect--------\x26gt;\x27\x3c\/span\x3e)\n      });\n\n      socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27s:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\/: \x27\x3c\/span\x3e\x2bport);\n          \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27\/: \x27\x3c\/span\x3e\x2bport)\n      });\n  });\n\nio.of(\x3cspan class=\x22hljs-string\x22\x3e\x27\/ws\x27\x3c\/span\x3e)\n  .on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e) \x3c\/span\x3e{\n    socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27disconnect\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27\/ws: disconnect--------\x26gt;\x27\x3c\/span\x3e)\n    });\n\n    socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27\/ws: message\x27\x3c\/span\x3e, port);\n    });\n});\n\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/page\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq,res\x3c\/span\x3e)\x3c\/span\x3e{\n    res.sendFile(path.join(process.cwd(),\x3cspan class=\x22hljs-string\x22\x3e\x27.\/index.html\x27\x3c\/span\x3e));\n});\n\nserver.listen(\x3cspan class=\x22hljs-number\x22\x3e8080\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eindex.html\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cscript\x3e\n        var btn = document.getElementById(\x27btn1\x27);\n        btn.addEventListener(\x27click\x27,function(){\n            var socket = io.connect(\x27http:\/\/127.0.0.1:8080\/ws\x27,{\n                reconnection: false\n            });\n            socket.on(\x27connect\x27,function(){\n                \/\/ 发起“脚手架安装”请求\n                socket.emit(\x27b:message\x27,{});\n\n                socket.on(\x27s:message\x27,function(d){\n                    console.log(d);\n                });\n\n            });\n\n            socket.on(\x27error\x27,function(err){\n                console.log(err);\n            })\n        });\n    \x3c\/script\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs xml\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22javascript\x22\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e btn = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27btn1\x27\x3c\/span\x3e);\n        btn.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e socket = io.connect(\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/127.0.0.1:8080\/ws\x27\x3c\/span\x3e,{\n                \x3cspan class=\x22hljs-attr\x22\x3ereconnection\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n            });\n            socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27connect\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 发起“脚手架安装”请求\x3c\/span\x3e\n                socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e,{});\n\n                socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27s:message\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ed\x3c\/span\x3e)\x3c\/span\x3e{\n                    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(d);\n                });\n\n            });\n\n            socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e)\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err);\n            })\n        });\n    \x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3epm2.json\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{\n  \x26quot;apps\x26quot;: [\n    {\n      \x26quot;name\x26quot;: \x26quot;ws\x26quot;,\n      \x26quot;script\x26quot;: \x26quot;.\/app.js\x26quot;,\n      \x26quot;env\x26quot;: {\n        \x26quot;NODE_ENV\x26quot;: \x26quot;development\x26quot;\n      },\n      \x26quot;env_production\x26quot;: {\n        \x26quot;NODE_ENV\x26quot;: \x26quot;production\x26quot;\n      },\n      \x26quot;instances\x26quot;: 4,\n      \x26quot;exec_mode\x26quot;: \x26quot;cluster\x26quot;,\n      \x26quot;max_restarts\x26quot; : 3,\n      \x26quot;restart_delay\x26quot; : 5000,\n      \x26quot;log_date_format\x26quot; : \x26quot;YYYY-MM-DD HH:mm Z\x26quot;,\n      \x26quot;combine_logs\x26quot; : true\n    }\n  ]\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs json\x22\x3e\x3ccode\x3e{\n  \x3cspan class=\x22hljs-attr\x22\x3e\x22apps\x22\x3c\/span\x3e: [\n    {\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22name\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22ws\x22\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22script\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22.\/app.js\x22\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22env\x22\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3e\x22NODE_ENV\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22development\x22\x3c\/span\x3e\n      },\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22env_production\x22\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3e\x22NODE_ENV\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22production\x22\x3c\/span\x3e\n      },\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22instances\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22exec_mode\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22cluster\x22\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22max_restarts\x22\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22restart_delay\x22\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e5000\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22log_date_format\x22\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e\x22YYYY-MM-DD HH:mm Z\x22\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3e\x22combine_logs\x22\x3c\/span\x3e : \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n    }\n  ]\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样，执行命令\x3ccode\x3epm2 start pm2.json\x3c\/code\x3e即可开启服务，访问\x3ccode\x3e127.0.0.1:8080\/page\x3c\/code\x3e，点击按钮发起ws连接，观察控制台即可。\x3c\/p\x3e\n\x3cp\x3e下图清晰显示了socket.io握手的错误：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009622161?w=1628\x26amp;h=412\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009622161?w=1628\x26amp;h=412\x22 alt=\x22ws握手失败\x22 title=\x22ws握手失败\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e可见在websocket连接建立之前多出了3个xhr请求，而websocket连接建立失败后又多出了几个xhr请求，同时最后两个xhr请求失败了。\x3c\/p\x3e\n\x3cp\x3esocket.io没有采用直接建立websocket连接的粗暴方式，而是首先通过http请求（xhr）访问服务端的相关轮训配置信息以及\x3cstrong\x3esid\x3c\/strong\x3e。此处sid类似sessionID，但是它唯一标识连接，可理解为socketId，以后每次http请求cookie中都必须携带sid（httponly）；\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009622162?w=1478\x26amp;h=182\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009622162?w=1478\x26amp;h=182\x22 alt=\x22初次握手信息\x22 title=\x22初次握手信息\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e第二、三个请求用于确认连接，在socket.io中，post请求是客户端发送消息给服务端的唯一形式，而且post响应一定是“ok”，它的“content-length”一定为2；而get请求主要用于轮训，同时获取服务端的相关消息，这会在下文中有体现；\x3c\/p\x3e\n\x3cp\x3e第四个websocket连接请求失败，这主要是由于与后端http握手失败造成的；\x3c\/p\x3e\n\x3cp\x3e第五个请求为xhr方式的post请求，它是作为websocket通道建立失败后的一种兼容性处理，上文讲述了socket.io的post请求只在\x3cstrong\x3e客户端需要发送消息给服务端时才会使用\x3c\/strong\x3e，因此，为了证实我们查看消息体：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009622163?w=1574\x26amp;h=426\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009622163?w=1574\x26amp;h=426\x22 alt=\x22post消息体\x22 title=\x22post消息体\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e可见，它携带了客户端发出的消息类型\x3cstrong\x3eb:message\x3c\/strong\x3e,同时包含消息体\x3cstrong\x3e{}\x3c\/strong\x3e空对象。对应的，服务端返回“OK”；\x3c\/p\x3e\n\x3cp\x3e第六个请求为xhr方式的get请求，用来获取服务端对第五个请求的响应。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009622164?w=520\x26amp;h=150\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009622164?w=520\x26amp;h=150\x22 alt=\x22响应\x22 title=\x22响应\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e至此，大致分析了socket.io建立连接的大致过程以及连接建立失败后如何兜底的方案，下面分析为何出现握手失败的问题。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e原因何在\x3c\/h2\x3e\n\x3cp\x3e实例中pm2主进程开启了4个工作进程，由主进程侦听8080端口并分发请求给工作进程。pm2进程在分发请求的阶段采用了某种算法的均衡，如round-robin或者其他hash方式（但不是iphash），因此在socket.io客户端连接建立阶段发送的多个xhr请求，会被pm2定位到不同的worker进程中。前文中提到每个xhr请求都会携带sid字段标识当前连接，因此当一个携带sid字段的请求被pm2定位到另一个与该连接无关的worker时，就会造成请求失败，返回\x3cstrong\x3e{\x22code\x22:1,\x22message\x22:\x22Session ID unknown\x22}\x3c\/strong\x3e错误；即使前三次xhr握手成功，进入websocket连接升级阶段，负责侦听update事件的worker也往往不是之前的那个worder，因此导致websocket连接建立失败。\x3c\/p\x3e\n\x3cp\x3e一言以蔽之，客户端多次请求的服务端进程不是同一个进程才导致的ws连接无法成功建立。\x3cbr\x3e那么如何才能解决呢？最简单的方案就是确保客户端的每次请求都可以定位到同一个服务进程即可。当然，分布式session同样可以解决问题，依托第三方缓存类似redis并配合一致性hash算法，确保所有服务进程都可以获取到连接信息，相互配合完成连接建立。但这也仅仅是作者在理论上分析的一种实现方式，并没有测试通过，因为这种分布式架构不仅实现繁杂而且引入了相关依赖redis，不太可取。\x3c\/p\x3e\n\x3cp\x3e那么下文主要针对\x3cstrong\x3e确保客户端的每次请求都可以定位到同一个服务进程\x3c\/strong\x3e这一点实现解决方案。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e多种实现\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e官方实现\x3c\/h3\x3e\n\x3cp\x3e官方提供了一种比较轻便的架构：\x3cstrong\x3enginx反向代理\x2biphash\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e我们的示例demo中的http服务器只侦听8080端口，因此必须由pm2分发请求，否则会出现端口占用的错误发生。但是，官方的解决方案是每个进程的socket.io服务器创建不同端口的http服务器，专注用于http握手和升级，由nginx做握手请求的代理。而且针对nginx必须设置\x3cstrong\x3eiphash\x3c\/strong\x3e，保证同一个客户端的多次请求定位到后端同一个服务进程。\x3c\/p\x3e\n\x3cp\x3e这样，示例demo中会占用5个端口，其中8080端口为公用的http服务器使用，其他四个端口则只用于ws连接握手。但是这四个端口却如何选取呢？为了保证扩展性以及顺序性，采用与pm2相兼容的方案。pm2会为每个worker进程分配一个id，并且将该id绑定到进程的环境变量中，那么我们就可以利用该worker id生成4个不同的端口号。\x3c\/p\x3e\n\x3cp\x3eapp.js\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var path = require(\x27path\x27);\nvar app = require(\x27express\x27)(),\n    server = require(\x27http\x27).createServer(app),\n    port = 3131 \x2b parseInt(process.env.NODE_APP_INSTANCE),\n    io = require(\x27socket.io\x27)(port);\n\nio\n  .on(\x27connection\x27, function(socket) {\n      socket.on(\x27disconnect\x27, function() {\n          console.log(\x27\/: disconnect--------\x3e\x27)\n      });\n\n      socket.on(\x27b:message\x27, function() {\n          socket.emit(\x27s:message\x27, \x27\/: \x27\x2bport);\n          console.log(\x27\/: \x27\x2bport)\n      });\n  });\n\nio.of(\x27\/ws\x27)\n  .on(\x27connection\x27, function(socket) {\n    socket.on(\x27disconnect\x27, function() {\n        console.log(\x27disconnect--------\x3e\x27)\n    });\n\n    socket.on(\x27b:message\x27, function() {\n        socket.emit(\x27s:message\x27, port);\n    });\n});\n\napp.get(\x27\/abc\x27,function(req,res){\n    res.sendFile(path.join(process.cwd(),\x27.\/index.html\x27));\n});\n\nserver.listen(8080);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e app = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e)(),\n    server = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27http\x27\x3c\/span\x3e).createServer(app),\n    port = \x3cspan class=\x22hljs-number\x22\x3e3131\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eparseInt\x3c\/span\x3e(process.env.NODE_APP_INSTANCE),\n    io = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27socket.io\x27\x3c\/span\x3e)(port);\n\nio\n  .on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e) \x3c\/span\x3e{\n      socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27disconnect\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27\/: disconnect--------\x26gt;\x27\x3c\/span\x3e)\n      });\n\n      socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27s:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27\/: \x27\x3c\/span\x3e\x2bport);\n          \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27\/: \x27\x3c\/span\x3e\x2bport)\n      });\n  });\n\nio.of(\x3cspan class=\x22hljs-string\x22\x3e\x27\/ws\x27\x3c\/span\x3e)\n  .on(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esocket\x3c\/span\x3e) \x3c\/span\x3e{\n    socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27disconnect\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27disconnect--------\x26gt;\x27\x3c\/span\x3e)\n    });\n\n    socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27s:message\x27\x3c\/span\x3e, port);\n    });\n});\n\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/abc\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq,res\x3c\/span\x3e)\x3c\/span\x3e{\n    res.sendFile(path.join(process.cwd(),\x3cspan class=\x22hljs-string\x22\x3e\x27.\/index.html\x27\x3c\/span\x3e));\n});\n\nserver.listen(\x3cspan class=\x22hljs-number\x22\x3e8080\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eindex.html\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  \x3cscript\x3e\n        var btn = document.getElementById(\x27btn1\x27);\n        btn.addEventListener(\x27click\x27,function(){\n            var socket = io.connect(\x27http:\/\/ws.vd.net\/ws\x27,{\n                reconnection: false\n            });\n            socket.on(\x27connect\x27,function(){\n                \/\/ 发起“脚手架安装”请求\n                socket.emit(\x27b:message\x27,{a:1});\n\n                socket.on(\x27s:message\x27,function(d){\n                    console.log(d);\n                });\n\n            });\n\n            socket.on(\x27error\x27,function(err){\n                console.log(err);\n            })\n        });\n    \x3c\/script\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs xml\x22\x3e\x3ccode\x3e  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22javascript\x22\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e btn = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x27btn1\x27\x3c\/span\x3e);\n        btn.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e socket = io.connect(\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/ws.vd.net\/ws\x27\x3c\/span\x3e,{\n                \x3cspan class=\x22hljs-attr\x22\x3ereconnection\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e\n            });\n            socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27connect\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 发起“脚手架安装”请求\x3c\/span\x3e\n                socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27b:message\x27\x3c\/span\x3e,{\x3cspan class=\x22hljs-attr\x22\x3ea\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e});\n\n                socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27s:message\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ed\x3c\/span\x3e)\x3c\/span\x3e{\n                    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(d);\n                });\n\n            });\n\n            socket.on(\x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e)\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err);\n            })\n        });\n    \x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3escript\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3enginx.conf\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    upstream io_nodes {\n      ip_hash;\n      server 127.0.0.1:3131;\n      server 127.0.0.1:3132;\n      server 127.0.0.1:3133;\n      server 127.0.0.1:3134;\n    }\n    server {\n        listen 80;\n        server_name ws.vd.net;\n        location \/ {\n          proxy_set_header Upgrade $http_upgrade;\n          proxy_set_header Connection \x26quot;upgrade\x26quot;;\n          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n          proxy_set_header Host $host;\n          proxy_http_version 1.1;\n          proxy_pass http:\/\/io_nodes;\n        }\n  }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs x86asm\x22\x3e\x3ccode\x3e    upstream io_nodes {\n      ip_hash\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      server \x3cspan class=\x22hljs-number\x22\x3e127.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.1\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3131\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      server \x3cspan class=\x22hljs-number\x22\x3e127.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.1\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3132\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      server \x3cspan class=\x22hljs-number\x22\x3e127.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.1\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3133\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      server \x3cspan class=\x22hljs-number\x22\x3e127.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-meta\x22\x3e.1\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3134\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n    }\n    server {\n        listen \x3cspan class=\x22hljs-number\x22\x3e80\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n        server_name ws.vd.net\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n        location \/ {\n          proxy_set_header Upgrade $http_upgrade\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n          proxy_set_header Connection \x3cspan class=\x22hljs-string\x22\x3e\x22upgrade\x22\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n          proxy_set_header Host $host\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n          proxy_http_version \x3cspan class=\x22hljs-number\x22\x3e1.1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n          proxy_pass http:\/\/io_nodes\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n        }\n  }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在本机绑定hosts地址后开启nginx服务，同时开启服务器，点击按钮建立ws连接成功。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e服务端路由\x3c\/h2\x3e\n\x3cp\x3e服务端路由，意义在于“\x3cstrong\x3e服务端做worker的负载均衡，并将选择的worker ip和端口渲染在页面，之后浏览器的所有ws连接默认连接到对应 ip:port的服务器中\x3c\/strong\x3e”。这样只要是服务端渲染的页面都可以采用这种方式实现。\x3c\/p\x3e\n\x3cp\x3e如果页面采用前端异步渲染，仍可以采用这种方式，不过首先通过xhr请求向服务端获取需要握手的http服务器的ip和端口，然后在进行ws连接。\x3c\/p\x3e\n\x3cp\x3e服务端路由的前提仍然是需要针对每个ws服务器分配一个端口，只不过去掉nginx由服务端做ip hash。采用服务端路由架构清晰，而且实现容易，兼容性好。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e上帝进程路由\x3c\/h2\x3e\n\x3cp\x3e此处的上帝进程即为主进程，类似pm2进程。上帝进程路由则是在上帝进程层面上做请求的定向分发，保证请求主机和进程的一致性。在上帝进程中，针对每个请求的ip做hash，并对每一个ws服务器创建单独的http服务器用于握手升级。\x3c\/p\x3e\n\x3cp\x3e简易代码:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var express = require(\x27express\x27),\n    cluster = require(\x27cluster\x27),\n    net = require(\x27net\x27),\n    sio = require(\x27socket.io\x27);\n\nvar port = 3000,\n    num_processes = require(\x27os\x27).cpus().length;\n\nif (cluster.isMaster) {\n    var workers = [];\n\n    var spawn = function(i) {\n        workers[i] = cluster.fork();\n        workers[i].on(\x27exit\x27, function(code, signal) {\n            console.log(\x27respawning worker\x27, i);\n            spawn(i);\n        });\n    };\n\n    for (var i = 0; i \x3c num_processes; i\x2b\x2b) {\n        spawn(i);\n    }\n\n    \/\/ ip hash\n    var worker_index = function(ip, len) {\n        var s = \x27\x27;\n        for (var i = 0, _len = ip.length; i \x3c _len; i\x2b\x2b) {\n            if (!isNaN(ip[i])) {\n                s \x2b= ip[i];\n            }\n        }\n\n        return Number(s) % len;\n    };\n\n    var server = net.createServer({ pauseOnConnect: true }, function(connection) {\n        var worker = workers[worker_index(connection.remoteAddress, num_processes)];\n        worker.send(\x27sticky-session:connection\x27, connection);\n    }).listen(port);\n} else {\n    \/\/ worker\n    var app = new express();\n\n    \/\/ handshake server.\n    var server = app.listen(0, \x27localhost\x27),\n        io = sio(server);\n\n    process.on(\x27message\x27, function(message, connection) {\n        if (message !== \x27sticky-session:connection\x27) {\n            return;\n        }\n\n        server.emit(\x27connection\x27, connection);\n\n        connection.resume();\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e express = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e),\n    cluster = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27cluster\x27\x3c\/span\x3e),\n    net = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27net\x27\x3c\/span\x3e),\n    sio = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27socket.io\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e port = \x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e,\n    num_processes = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27os\x27\x3c\/span\x3e).cpus().length;\n\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (cluster.isMaster) {\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e workers = [];\n\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e spawn = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ei\x3c\/span\x3e) \x3c\/span\x3e{\n        workers[i] = cluster.fork();\n        workers[i].on(\x3cspan class=\x22hljs-string\x22\x3e\x27exit\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ecode, signal\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27respawning worker\x27\x3c\/span\x3e, i);\n            spawn(i);\n        });\n    };\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; num_processes; i\x2b\x2b) {\n        spawn(i);\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ip hash\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e worker_index = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eip, len\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e s = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, _len = ip.length; i \x26lt; _len; i\x2b\x2b) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-built_in\x22\x3eisNaN\x3c\/span\x3e(ip[i])) {\n                s \x2b= ip[i];\n            }\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eNumber\x3c\/span\x3e(s) % len;\n    };\n\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e server = net.createServer({ \x3cspan class=\x22hljs-attr\x22\x3epauseOnConnect\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e }, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3econnection\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e worker = workers[worker_index(connection.remoteAddress, num_processes)];\n        worker.send(\x3cspan class=\x22hljs-string\x22\x3e\x27sticky-session:connection\x27\x3c\/span\x3e, connection);\n    }).listen(port);\n} \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ worker\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e express();\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ handshake server.\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e server = app.listen(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27localhost\x27\x3c\/span\x3e),\n        io = sio(server);\n\n    process.on(\x3cspan class=\x22hljs-string\x22\x3e\x27message\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emessage, connection\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (message !== \x3cspan class=\x22hljs-string\x22\x3e\x27sticky-session:connection\x27\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n        }\n\n        server.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27connection\x27\x3c\/span\x3e, connection);\n\n        connection.resume();\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e总结\x3c\/h2\x3e\n\x3cp\x3e本文实现了三种解决方案，归根到底就是“ip hash”，不同点在于在请求处理的不同阶段做ip hash。\x3c\/p\x3e\n\x3cp\x3e可以在请求处理最前端做iphash，即nginx方式，这也就是第一种方案；\x3cbr\x3e可以在请求处理的第二层分发处做iphash，即上帝进程路由的方式，即第三种；\x3cbr\x3e也可以在请求处理的终端做iphash，即服务端路由的方式，也就是第二种；\x3cbr\x3e同时共享session也同样可以实现，借助socket.io-redis模块也可以实现。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>socket.io搭配pm2（cluster）集群解决方案</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009622158">https://segmentfault.com/a/1190000009622158</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/sukzah87jdn/" target="_blank">https://alili.tech/archive/sukzah87jdn/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>