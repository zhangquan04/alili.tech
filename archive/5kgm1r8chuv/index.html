<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="开发一个 Linux 调试器（一）：准备环境"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>开发一个 Linux 调试器（一）：准备环境 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/5kgm1r8chuv/",
				"appid": "1613049289050283", 
				"title": "开发一个 Linux 调试器（一）：准备环境 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-22T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/51qpzjb4wb4/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/4ks15a9h05e/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&text=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&text=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&is_video=false&description=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5kgm1r8chuv%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">开发一个 Linux 调试器（一）：准备环境</h1><div class="meta"><div class="postdate"><time datetime="2019-01-22" itemprop="datePublished">2019-01-22</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#开发一个-linux-调试器一准备环境\x22\x3e\x3c\/a\x3e开发一个 Linux 调试器（一）：准备环境\x3c\/h1\x3e\n\x3cp\x3e任何写过比 hello world 复杂一些的程序的人都应该使用过调试器（如果你还没有，那就停下手头的工作先学习一下吧）。但是，尽管这些工具已经得到了广泛的使用，却并没有太多的资源告诉你它们的工作原理以及如何开发，尤其是和其它那些比如编译器等工具链技术相比而言。\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e此处有一些其它的资源可以参考：\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cblockquote\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/eli.thegreenplace.net\/2011\/01\/23\/how-debuggers-work-part-1\x22\x3ehttp:\/\/eli.thegreenplace.net\/2011\/01\/23\/how-debuggers-work-part-1\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/blockquote\x3e\n\x3cblockquote\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/t-a-w.blogspot.co.uk\/2007\/03\/how-to-code-debuggers.html\x22\x3ehttps:\/\/t-a-w.blogspot.co.uk\/2007\/03\/how-to-code-debuggers.html\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/blockquote\x3e\n\x3cblockquote\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/www.codeproject.com\/Articles\/43682\/Writing-a-basic-Windows-debugger\x22\x3ehttps:\/\/www.codeproject.com\/Articles\/43682\/Writing-a-basic-Windows-debugger\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/blockquote\x3e\n\x3cblockquote\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/system.joekain.com\/debugger\/\x22\x3ehttp:\/\/system.joekain.com\/debugger\/\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e我们将会支持以下功能：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e启动、暂停、继续执行\x3c\/li\x3e\n\x3cli\x3e在不同地方设置断点\x3cul\x3e\n\x3cli\x3e内存地址\x3c\/li\x3e\n\x3cli\x3e源代码行\x3c\/li\x3e\n\x3cli\x3e函数入口\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e读写寄存器和内存\x3c\/li\x3e\n\x3cli\x3e单步执行\x3cul\x3e\n\x3cli\x3e指令\x3c\/li\x3e\n\x3cli\x3e进入函数\x3c\/li\x3e\n\x3cli\x3e跳出函数\x3c\/li\x3e\n\x3cli\x3e跳过函数\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e打印当前代码地址\x3c\/li\x3e\n\x3cli\x3e打印函数调用栈\x3c\/li\x3e\n\x3cli\x3e打印简单变量的值\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e在最后一部分，我还会大概介绍如何给你的调试器添加下面的功能：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e远程调试\x3c\/li\x3e\n\x3cli\x3e共享库和动态库支持\x3c\/li\x3e\n\x3cli\x3e表达式计算\x3c\/li\x3e\n\x3cli\x3e多线程调试支持\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e在本项目中我会将重点放在 C 和 C\x2b\x2b，但对于那些将源码编译为机器码并输出标准 DWARE 调试信息的语言也应该能起作用（如果你还不知道这些东西是什么，别担心，马上就会介绍到啦）。另外，我只关注如何将程序运行起来并在大部分情况下能正常工作，为了简便，会避开类似健壮错误处理方面的东西。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#系列文章索引\x22\x3e\x3c\/a\x3e系列文章索引\x3c\/h3\x3e\n\x3cp\x3e随着后面文章的发布，这些链接会逐渐生效。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/21\/writing-a-linux-debugger-setup\/\x22\x3e准备环境\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/24\/writing-a-linux-debugger-breakpoints\/\x22\x3e断点\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e寄存器和内存\x3c\/li\x3e\n\x3cli\x3eElves 和 dwarves\x3c\/li\x3e\n\x3cli\x3e源码和信号\x3c\/li\x3e\n\x3cli\x3e源码层逐步执行\x3c\/li\x3e\n\x3cli\x3e源码层断点\x3c\/li\x3e\n\x3cli\x3e调用栈\x3c\/li\x3e\n\x3cli\x3e读取变量\x3c\/li\x3e\n\x3cli\x3e之后步骤\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3eLCTT 译注：ELF —— 可执行文件格式\x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Executable_and_Linkable_Format\x22 title=\x22Executable and Linkable Format\x22\x3eExecutable and Linkable Format\x3c\/a\x3e；DWARF（一种广泛使用的调试数据格式，参考 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/DWARF\x22 title=\x22DWARF WIKI\x22\x3eWIKI\x3c\/a\x3e）。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#准备环境\x22\x3e\x3c\/a\x3e准备环境\x3c\/h3\x3e\n\x3cp\x3e在我们正式开始之前，我们首先要设置环境。在这篇文章中我会依赖两个工具：\x3ca href=\x22https:\/\/github.com\/antirez\/linenoise\x22\x3eLinenoise\x3c\/a\x3e 用于处理命令行输入，\x3ca href=\x22https:\/\/github.com\/TartanLlama\/libelfin\/tree\/fbreg\x22\x3elibelfin\x3c\/a\x3e 用于解析调试信息。你也可以使用更传统的 libdwarf 而不是 libelfin，但是界面没有那么友好，另外 libelfin 还提供了基本完整的 DWARF 表达式求值器，当你想读取变量的值时这能帮你节省很多时间。确认你使用的是 libelfin 我的 fbreg 分支，因为它提供 x86 上读取变量的额外支持。\x3c\/p\x3e\n\x3cp\x3e一旦你在系统上安装或者使用你喜欢的编译系统编译好了这些依赖工具，就可以开始啦。我在 CMake 文件中把它们设置为和我其余的代码一起编译。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#启动可执行程序\x22\x3e\x3c\/a\x3e启动可执行程序\x3c\/h3\x3e\n\x3cp\x3e在真正调试任何程序之前，我们需要启动被调试的程序。我们会使用经典的 \x3ccode\x3efork\x3c\/code\x3e\/\x3ccode\x3eexec\x3c\/code\x3e 模式。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3emain\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e argc, \x3cspan class=\x22hljs-keyword\x22\x3echar\x3c\/span\x3e* argv[])\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (argc \x26lt; \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3ecerr\x3c\/span\x3e \x26lt;\x26lt; \x3cspan class=\x22hljs-string\x22\x3e\x22Program name not specified\x22\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e prog = argv[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e];\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e pid = fork();\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (pid == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/we\x27re in the child process\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/execute debugee\x3c\/span\x3e\n\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (pid \x26gt;= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)  {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/we\x27re in the parent process\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/execute debugger\x3c\/span\x3e\n    }\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e我们调用 \x3ccode\x3efork\x3c\/code\x3e 把我们的程序分成两个进程。如果我们是在子进程，\x3ccode\x3efork\x3c\/code\x3e 返回 0，如果我们是在父进程，它会返回子进程的进程 ID。\x3c\/p\x3e\n\x3cp\x3e如果我们是在子进程，我们要用希望调试的程序替换正在执行的程序。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs lisp\x22\x3e   ptrace(\x3cspan class=\x22hljs-name\x22\x3ePTRACE_TRACEME\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, nullptr, nullptr)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n   execl(\x3cspan class=\x22hljs-name\x22\x3eprog\x3c\/span\x3e.c_str(), prog.c_str(), nullptr)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这里我们第一次遇到了 \x3ccode\x3eptrace\x3c\/code\x3e，它会在我们编写调试器的时候经常遇到。\x3ccode\x3eptrace\x3c\/code\x3e 通过读取寄存器、内存、逐步调试等让我们观察和控制另一个进程的执行。其 API 非常简单；你需要给这个简单函数提供一个枚举值指定你想要进行的操作，然后是一些取决于你所提供的值可能会被使用也可能会被忽略的参数。函数原型看起来类似：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs crystal\x22\x3elong ptrace(\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eenum\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3e__ptrace_request\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3erequest\x3c\/span\x3e, \x3cspan class=\x22hljs-title\x22\x3epid_t\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epid\x3c\/span\x3e,\x3c\/span\x3e\n            void *addr, void *data);\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3erequest\x3c\/code\x3e 是我们想对被跟踪进程进行的操作；\x3ccode\x3epid\x3c\/code\x3e 是被跟踪进程的进程 ID；\x3ccode\x3eaddr\x3c\/code\x3e 是一个内存地址，用于在一些调用中指定被跟踪程序的地址；\x3ccode\x3edata\x3c\/code\x3e 是 \x3ccode\x3erequest\x3c\/code\x3e 相应的资源。返回值通常是一些错误信息，因此在你实际的代码中你也许应该检查返回值；为了简洁我这里就省略了。你可以查看 man 手册获取更多（关于 ptrace）的信息。\x3c\/p\x3e\n\x3cp\x3e上面代码中我们发送的请求 \x3ccode\x3ePTRACE_TRACEME\x3c\/code\x3e 表示这个进程应该允许父进程跟踪它。所有其它参数都会被忽略，因为 API 设计并不是很重要，哈哈。\x3c\/p\x3e\n\x3cp\x3e下一步，我们会调用 \x3ccode\x3eexecl\x3c\/code\x3e，这是很多诸多的 \x3ccode\x3eexec\x3c\/code\x3e 函数格式之一。我们执行指定的程序，通过命令行参数传递它的名称，然后用一个 \x3ccode\x3enullptr\x3c\/code\x3e 终止列表。如果你愿意，你还可以传递其它执行你的程序所需的参数。\x3c\/p\x3e\n\x3cp\x3e在完成这些后，我们就会和子进程一起结束；在我们结束它之前它会一直执行。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#添加调试循环\x22\x3e\x3c\/a\x3e添加调试循环\x3c\/h3\x3e\n\x3cp\x3e现在我们已经启动了子进程，我们想要能够和它进行交互。为此，我们会创建一个 \x3ccode\x3edebugger\x3c\/code\x3e 类，循环监听用户输入，然后在我们父进程的 \x3ccode\x3emain\x3c\/code\x3e 函数中启动它。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs stata\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (pid \x26gt;= 1)  {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/parent\x3c\/span\x3e\n    debugger dbg{\x3cspan class=\x22hljs-keyword\x22\x3eprog\x3c\/span\x3e, pid};\n    dbg.\x3cspan class=\x22hljs-keyword\x22\x3erun\x3c\/span\x3e();\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edebugger\x3c\/span\x3e {\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e:\n    debugger (\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e prog_name, \x3cspan class=\x22hljs-keyword\x22\x3epid_t\x3c\/span\x3e pid)\n        : m_prog_name{\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::move(prog_name)}, m_pid{pid} {}\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3erun\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e:\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e m_prog_name;\n    \x3cspan class=\x22hljs-keyword\x22\x3epid_t\x3c\/span\x3e m_pid;\n};\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e在 \x3ccode\x3erun\x3c\/code\x3e 函数中，我们需要等待，直到子进程完成启动，然后一直从 \x3ccode\x3elinenoise\x3c\/code\x3e 获取输入直到收到 \x3ccode\x3eEOF\x3c\/code\x3e（\x3ccode\x3eCTRL\x2bD\x3c\/code\x3e）。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs arduino\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e debugger::\x3cspan class=\x22hljs-built_in\x22\x3erun\x3c\/span\x3e() {\n    \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e wait_status;\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e options = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n    waitpid(m_pid, \x26amp;wait_status, options);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3echar\x3c\/span\x3e* \x3cspan class=\x22hljs-built_in\x22\x3eline\x3c\/span\x3e = nullptr;\n    \x3cspan class=\x22hljs-built_in\x22\x3ewhile\x3c\/span\x3e((\x3cspan class=\x22hljs-built_in\x22\x3eline\x3c\/span\x3e = linenoise(\x3cspan class=\x22hljs-string\x22\x3e\x22minidbg\x26gt; \x22\x3c\/span\x3e)) != nullptr) {\n        handle_command(\x3cspan class=\x22hljs-built_in\x22\x3eline\x3c\/span\x3e);\n        linenoiseHistoryAdd(\x3cspan class=\x22hljs-built_in\x22\x3eline\x3c\/span\x3e);\n        linenoiseFree(\x3cspan class=\x22hljs-built_in\x22\x3eline\x3c\/span\x3e);\n    }\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e当被跟踪的进程启动时，会发送一个 \x3ccode\x3eSIGTRAP\x3c\/code\x3e 信号给它，这是一个跟踪或者断点中断。我们可以使用 \x3ccode\x3ewaitpid\x3c\/code\x3e 函数等待这个信号发送。\x3c\/p\x3e\n\x3cp\x3e当我们知道进程可以被调试之后，我们监听用户输入。\x3ccode\x3elinenoise\x3c\/code\x3e 函数它自己会用一个窗口显示和处理用户输入。这意味着我们不需要做太多的工作就会有一个支持历史记录和导航命令的命令行。当我们获取到输入时，我们把命令发给我们写的小程序 \x3ccode\x3ehandle_command\x3c\/code\x3e，然后我们把这个命令添加到 \x3ccode\x3elinenoise\x3c\/code\x3e 历史并释放资源。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#处理输入\x22\x3e\x3c\/a\x3e处理输入\x3c\/h3\x3e\n\x3cp\x3e我们的命令类似 gdb 以及 lldb 的格式。要继续执行程序，用户需要输入 \x3ccode\x3econtinue\x3c\/code\x3e 或 \x3ccode\x3econt\x3c\/code\x3e 甚至只需 \x3ccode\x3ec\x3c\/code\x3e。如果他们想在一个地址中设置断点，他们会输入 \x3ccode\x3ebreak 0xDEADBEEF\x3c\/code\x3e，其中 \x3ccode\x3e0xDEADBEEF\x3c\/code\x3e 就是所需地址的 16 进制格式。让我们来增加对这些命令的支持吧。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e debugger::handle_command(\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26amp; line) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e args = split(line,\x3cspan class=\x22hljs-string\x22\x3e\x27 \x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e command = args[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e];\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (is_prefix(command, \x3cspan class=\x22hljs-string\x22\x3e\x22continue\x22\x3c\/span\x3e)) {\n        continue_execution();\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3ecerr\x3c\/span\x3e \x26lt;\x26lt; \x3cspan class=\x22hljs-string\x22\x3e\x22Unknown command\\n\x22\x3c\/span\x3e;\n    }\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3esplit\x3c\/code\x3e 和 \x3ccode\x3eis_prefix\x3c\/code\x3e 是一对有用的小程序：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3evector\x3c\/span\x3e\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26gt; split(\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e \x26amp;s, \x3cspan class=\x22hljs-keyword\x22\x3echar\x3c\/span\x3e delimiter) {\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3evector\x3c\/span\x3e\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26gt; out{};\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estringstream\x3c\/span\x3e ss {s};\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e item;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::getline(ss,item,delimiter)) {\n        out.push_back(item);\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e out;\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3ebool\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eis_prefix\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26amp; s, \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26amp; of)\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (s.size() \x26gt; of.size()) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::equal(s.begin(), s.end(), of.begin());\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e我们会把 \x3ccode\x3econtinue_execution\x3c\/code\x3e 函数添加到 \x3ccode\x3edebuger\x3c\/code\x3e 类。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e debugger::continue_execution() {\n    ptrace(PTRACE_CONT, m_pid, \x3cspan class=\x22hljs-literal\x22\x3enullptr\x3c\/span\x3e, \x3cspan class=\x22hljs-literal\x22\x3enullptr\x3c\/span\x3e);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e wait_status;\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e options = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n    waitpid(m_pid, \x26amp;wait_status, options);\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e现在我们的 \x3ccode\x3econtinue_execution\x3c\/code\x3e 函数会用 \x3ccode\x3eptrace\x3c\/code\x3e 告诉进程继续执行，然后用 \x3ccode\x3ewaitpid\x3c\/code\x3e 等待直到收到信号。\x3c\/p\x3e\n\x3chr\x3e\n\x3ch3\x3e\x3ca href=\x22#总结\x22\x3e\x3c\/a\x3e总结\x3c\/h3\x3e\n\x3cp\x3e现在你应该编译一些 C 或者 C\x2b\x2b 程序，然后用你的调试器运行它们，看它是否能在函数入口暂停、从调试器中继续执行。在下一篇文章中，我们会学习如何让我们的调试器设置断点。如果你遇到了任何问题，在下面的评论框中告诉我吧！\x3c\/p\x3e\n\x3cp\x3e你可以在\x3ca href=\x22https:\/\/github.com\/TartanLlama\/minidbg\/tree\/tut_setup\x22\x3e这里\x3c\/a\x3e找到该项目的代码。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22http:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/21\/writing-a-linux-debugger-setup\/\x22\x3ehttp:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/21\/writing-a-linux-debugger-setup\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22https:\/\/www.linkedin.com\/in\/simon-brand-36520857\x22\x3eSimon Brand\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/ictlyh\x22\x3eictlyh\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/jasminepeng\x22\x3ejasminepeng\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>开发一个 Linux 调试器（一）：准备环境</p><h2 id="原文链接">原文链接</h2><p><a href="https://www.zcfy.cc/article/writing-a-linux-debugger-part-1-setup">https://www.zcfy.cc/article/writing-a-linux-debugger-part-1-setup</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/5kgm1r8chuv/" target="_blank">https://alili.tech/archive/5kgm1r8chuv/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>