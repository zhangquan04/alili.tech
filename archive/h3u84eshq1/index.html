<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="koa和egg项目webpack内存编译和热更新实现"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>koa和egg项目webpack内存编译和热更新实现 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/h3u84eshq1/",
				"appid": "1613049289050283", 
				"title": "koa和egg项目webpack内存编译和热更新实现 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-14T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/ex3sxwvot4n/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/wnhh1fmuior/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&text=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&text=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&title=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&is_video=false&description=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&title=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&title=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&title=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fh3u84eshq1%2f&title=koa%e5%92%8cegg%e9%a1%b9%e7%9b%aewebpack%e5%86%85%e5%ad%98%e7%bc%96%e8%af%91%e5%92%8c%e7%83%ad%e6%9b%b4%e6%96%b0%e5%ae%9e%e7%8e%b0"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">koa和egg项目webpack内存编译和热更新实现</h1><div class="meta"><div class="postdate"><time datetime="2019-01-14" itemprop="datePublished">2019-01-14</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e背景\x3c\/h2\x3e\n\x3cp\x3e在用Node.js\x2bWebpack构建的方式进行开发时,  我们希望能实现修改代码能实时刷新页面UI的效果.\x3cbr\x3e这个特性webpack本身是支持的, 而且基于koa也有现成的koa-webpack-hot-middleware 和 koa-webpack-dev-middleware 封装好的组件支持.\x3cbr\x3e不过这里如果需要支持Node.js服务器端修改代码自动重启webpack自动编译功能就需要cluster来实现.\x3c\/p\x3e\n\x3cp\x3e今天这里要讲的是如何在koa和egg应用实现Node.js应用重启中的webpack热更新功能. 要实现egg项目中webpack友好的开发体验, 需要解决如下三个问题.\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e问题\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e如何解决Node.js服务器端代码修改应用重启避免webpack重新编译.\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e如何访问js,css,image等静态资源.\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e如何处理本地开发webpack热更新内存存储读取和线上应用本机文件读取逻辑分离.\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e基于koa的webpack编译和热更新实现\x3c\/h2\x3e\n\x3cp\x3e在koa项目中, 通过koa-webpack-dev-middleware和koa-webpack-hot-middleware可以实现webpack编译内存存储和热更新功能, 代码如下:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const compiler = webpack(webpackConfig);\nconst devMiddleware = require(\x27koa-webpack-dev-middleware\x27)(compiler, options);\nconst hotMiddleware = require(\x27koa-webpack-hot-middleware\x27)(compiler, options);\napp.use(devMiddleware);\napp.use(hotMiddleware);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiler = webpack(webpackConfig);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e devMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-dev-middleware\x27\x3c\/span\x3e)(compiler, options);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e hotMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-hot-middleware\x27\x3c\/span\x3e)(compiler, options);\napp.use(devMiddleware);\napp.use(hotMiddleware);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果按照上面实现, 可以满足修改修改客户端代码实现webpack自动变编译和UI界面热更新的功能, 但如果是修改Node.js服务器端代码重启后就会发现webpack会重新编译,\x3cbr\x3e这不是我们要的效果.原因是因为middleware是依赖app的生命周期, 当app销毁时, 对应webpack compiler实例也就没有了, 重启时会重新执行middleware初始化工作.\x3cbr\x3e针对这个我们可以通过Node.js cluster实现, 大概思路如下:\x3c\/p\x3e\n\x3ch4\x3e通过cluster worker 启动App应用\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22if (cluster.isWorker) {\n  const koa = require(\x27koa\x27);\n    app.listen(8888, () =\x3e{\n        app.logger.info(\x27The server is running on port: 9999\x27);\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (cluster.isWorker) {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n    app.listen(\x3cspan class=\x22hljs-number\x22\x3e8888\x3c\/span\x3e, () =\x26gt;{\n        app.logger.info(\x3cspan class=\x22hljs-string\x22\x3e\x27The server is running on port: 9999\x27\x3c\/span\x3e);\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e通过cluster master 启动一个新的koa应用, 并启动 webpack 编译.\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const cluster = require(\x27cluster\x27);\nconst chokidar = require(\x27chokidar\x27);\n\nif (cluster.isMaster) {\n  const koa = require(\x27koa\x27);\n  const app = koa();\n  const compiler = webpack([clientWebpackConfig,serverWebpackConfig]);\n  const devMiddleware = require(\x27koa-webpack-dev-middleware\x27)(compiler);\n  const hotMiddleware = require(\x27koa-webpack-hot-middleware\x27)(compiler);\n  app.use(devMiddleware);\n  app.use(hotMiddleware);\n\n  let worker = cluster.fork();\n  chokidar.watch(config.dir, config.options).on(\x27change\x27, path =\x3e{\n    console.log(`${path} changed`);\n    worker.kill();\n    worker = cluster.fork().on(\x27listening\x27, (address) =\x3e{\n      console.log(`[master] listening: worker ${worker.id}, pid:${worker.process.pid} ,Address:${address.address } :${address.port}`);\n    });\n  });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e cluster = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27cluster\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e chokidar = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27chokidar\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (cluster.isMaster) {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = koa();\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiler = webpack([clientWebpackConfig,serverWebpackConfig]);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e devMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-dev-middleware\x27\x3c\/span\x3e)(compiler);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e hotMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-hot-middleware\x27\x3c\/span\x3e)(compiler);\n  app.use(devMiddleware);\n  app.use(hotMiddleware);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e worker = cluster.fork();\n  chokidar.watch(config.dir, config.options).on(\x3cspan class=\x22hljs-string\x22\x3e\x27change\x27\x3c\/span\x3e, path =\x26gt;{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${path}\x3c\/span\x3e changed`\x3c\/span\x3e);\n    worker.kill();\n    worker = cluster.fork().on(\x3cspan class=\x22hljs-string\x22\x3e\x27listening\x27\x3c\/span\x3e, (address) =\x26gt;{\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`[master] listening: worker \x3cspan class=\x22hljs-subst\x22\x3e${worker.id}\x3c\/span\x3e, pid:\x3cspan class=\x22hljs-subst\x22\x3e${worker.process.pid}\x3c\/span\x3e ,Address:\x3cspan class=\x22hljs-subst\x22\x3e${address.address }\x3c\/span\x3e :\x3cspan class=\x22hljs-subst\x22\x3e${address.port}\x3c\/span\x3e`\x3c\/span\x3e);\n    });\n  });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e通过chokidar库监听文件夹的文件修改, 然后重启worker, 这样就能保证webpack compiler实例不被销毁.\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const watchConfig = {\n        dir: [ \x27controller\x27, \x27middleware\x27, \x27lib\x27, \x27model\x27, \x27app.js\x27, \x27index.js\x27 ],\n        options: {}\n    };\n    let worker = cluster.fork();\n    chokidar.watch(watchConfig.dir, watchConfig.options).on(\x27change\x27, path =\x3e{\n        console.log(`${path} changed`);\n        worker \x26amp;\x26amp; worker.kill();\n        worker = cluster.fork().on(\x27listening\x27, (address) =\x3e{\n            console.log(`[master] listening: worker ${worker.id}, pid:${worker.process.pid} ,Address:${address.address } :${address.port}`);\n        });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e watchConfig = {\n        \x3cspan class=\x22hljs-attr\x22\x3edir\x3c\/span\x3e: [ \x3cspan class=\x22hljs-string\x22\x3e\x27controller\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27middleware\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27lib\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27model\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27app.js\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27index.js\x27\x3c\/span\x3e ],\n        \x3cspan class=\x22hljs-attr\x22\x3eoptions\x3c\/span\x3e: {}\n    };\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e worker = cluster.fork();\n    chokidar.watch(watchConfig.dir, watchConfig.options).on(\x3cspan class=\x22hljs-string\x22\x3e\x27change\x27\x3c\/span\x3e, path =\x26gt;{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${path}\x3c\/span\x3e changed`\x3c\/span\x3e);\n        worker \x26amp;\x26amp; worker.kill();\n        worker = cluster.fork().on(\x3cspan class=\x22hljs-string\x22\x3e\x27listening\x27\x3c\/span\x3e, (address) =\x26gt;{\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`[master] listening: worker \x3cspan class=\x22hljs-subst\x22\x3e${worker.id}\x3c\/span\x3e, pid:\x3cspan class=\x22hljs-subst\x22\x3e${worker.process.pid}\x3c\/span\x3e ,Address:\x3cspan class=\x22hljs-subst\x22\x3e${address.address }\x3c\/span\x3e :\x3cspan class=\x22hljs-subst\x22\x3e${address.port}\x3c\/span\x3e`\x3c\/span\x3e);\n        });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eworker 通过\x3ccode\x3eprocess.send\x3c\/code\x3e 向 master 发现消息, \x3ccode\x3eprocess.on\x3c\/code\x3e 监听 master返回的消息\x3c\/h4\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e首先我们看看本地文件读取的实现, 在context上面挂载readFile方法, 进行view render时, 调用\x3ccode\x3eapp.context.readFile\x3c\/code\x3e 方法.\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22app.context.readFile = function(fileName){\n  const filePath = path.join(config.baseDir, config.staticDir, fileName);\n  return new Promise((resolve, reject) =\x3e{\n    fs.readFile(filePath, CHARSET, function(err, data){\n      if (err) {\n        reject(err);\n      } else {\n        resolve(data);\n      }\n    });\n  });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eapp.context.readFile = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efileName\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.join(config.baseDir, config.staticDir, fileName);\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e{\n    fs.readFile(filePath, CHARSET, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerr, data\x3c\/span\x3e)\x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n        reject(err);\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        resolve(data);\n      }\n    });\n  });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e通过覆写worker \x3ccode\x3eapp.context.readFile\x3c\/code\x3e 方法, 这样进行本地开发时,开启该插件就可以无缝的从webpack编译内存系统里面读取文件\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22app.context.readFile = (fileName) =\x3e{\n  return new Promise((resolve, reject) =\x3e{\n    process.send({ action: Constant.EVENT_FILE_READ, fileName });\n    process.on(Constant.EVENT_MESSAGE, (msg) =\x3e{\n      resolve(msg.content);\n    });\n  });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eapp.context.readFile = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3efileName\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e{\n    process.send({ \x3cspan class=\x22hljs-attr\x22\x3eaction\x3c\/span\x3e: Constant.EVENT_FILE_READ, fileName });\n    process.on(Constant.EVENT_MESSAGE, (msg) =\x26gt;{\n      resolve(msg.content);\n    });\n  });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3emaster 通过监听worker发过来的消息, 获取webpack编译进度和读取webpack compiler内存系统文件内容\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22cluster.on(Constant.EVENT_MESSAGE, (worker, msg) =\x3e{\n        switch (msg.action) {\n            case Constant.EVENT_WEBPACK_BUILD_STATE: {\n                const data = {\n                    action: Constant.EVENT_WEBPACK_BUILD_STATE,\n                    state: app.webpack_client_build_success \x26amp;\x26amp; app.webpack_server_build_success\n                };\n                worker.send(data);\n                break;\n            }\n            case Constant.EVENT_FILE_READ: {\n                const fileName = msg.fileName;\n                try {\n                    const compiler = app.compiler;\n                    const filePath = path.join(compiler.outputPath, fileName);\n                    const content = app.compiler.outputFileSystem.readFileSync(filePath).toString(Constant.CHARSET);\n                    worker.send({ fileName, content });\n                } catch (e) {\n                    console.log(`read file ${fileName} error`, e.toString());\n                }\n                break;\n            }\n            default:\n                break;\n        }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3ecluster.on(Constant.EVENT_MESSAGE, (worker, msg) =\x26gt;{\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (msg.action) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e Constant.EVENT_WEBPACK_BUILD_STATE: {\n                \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e data = {\n                    \x3cspan class=\x22hljs-attr\x22\x3eaction\x3c\/span\x3e: Constant.EVENT_WEBPACK_BUILD_STATE,\n                    \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: app.webpack_client_build_success \x26amp;\x26amp; app.webpack_server_build_success\n                };\n                worker.send(data);\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e Constant.EVENT_FILE_READ: {\n                \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fileName = msg.fileName;\n                \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n                    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiler = app.compiler;\n                    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.join(compiler.outputPath, fileName);\n                    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e content = app.compiler.outputFileSystem.readFileSync(filePath).toString(Constant.CHARSET);\n                    worker.send({ fileName, content });\n                } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (e) {\n                    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e`read file \x3cspan class=\x22hljs-subst\x22\x3e${fileName}\x3c\/span\x3e error`\x3c\/span\x3e, e.toString());\n                }\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e:\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n        }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e基于egg的webpack编译和热更新实现\x3c\/h2\x3e\n\x3cp\x3e通过上面koa的实现思路, egg实现就更简单了. 因为egg已经内置了worker和agent通信机制以及自动重启功能.\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eworker和agent通信机制: \x3ca href=\x22https:\/\/eggjs.org\/zh-cn\/core\/cluster-and-ipc.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/eggjs.org\/zh-cn\/core\/...\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e实现egg项目服务器代码修改项目自动重启的功能可以使用\x3ca href=\x22https:\/\/github.com\/eggjs\/egg-development\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-development\x3c\/a\x3e插件.\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch4\x3eapp.js (worker) 通过 检测webpack 编译进度\x3c\/h4\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e通过\x3ccode\x3eapp.messenger.sendToAgent\x3c\/code\x3e 向agent发送消息\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e通过\x3ccode\x3eapp.messenger.on\x3c\/code\x3e 监听agent发送过来的消息\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22app.use(function* (next) {\n  if (app.webpack_server_build_success \x26amp;\x26amp; app.webpack_client_build_success) {\n    yield* next;\n  } else {\n    const serverData = yield new Promise(resolve =\x3e {\n      this.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, {\n        webpackBuildCheck: true,\n      });\n      this.app.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, data =\x3e {\n        resolve(data);\n      });\n    });\n    app.webpack_server_build_success = serverData.state;\n\n    const clientData = yield new Promise(resolve =\x3e {\n      this.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, {\n        webpackBuildCheck: true,\n      });\n      this.app.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x3e {\n        resolve(data);\n      });\n    });\n\n    app.webpack_client_build_success = clientData.state;\n\n    if (!(app.webpack_server_build_success \x26amp;\x26amp; app.webpack_client_build_success)) {\n      if (app.webpack_loading_text) {\n        this.body = app.webpack_loading_text;\n      } else {\n        const filePath = path.resolve(__dirname, \x27.\/lib\/template\/loading.html\x27);\n        this.body = app.webpack_loading_text = fs.readFileSync(filePath, \x27utf8\x27);\n      }\n    } else {\n      yield* next;\n    }\n  }\n});\n\napp.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, data =\x3e {\n  app.webpack_server_build_success = data.state;\n});\n\napp.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x3e {\n  app.webpack_client_build_success = data.state;\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eapp.use(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* (\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (app.webpack_server_build_success \x26amp;\x26amp; app.webpack_client_build_success) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e* next;\n  } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e serverData = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, {\n        \x3cspan class=\x22hljs-attr\x22\x3ewebpackBuildCheck\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, data =\x26gt; {\n        resolve(data);\n      });\n    });\n    app.webpack_server_build_success = serverData.state;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e clientData = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, {\n        \x3cspan class=\x22hljs-attr\x22\x3ewebpackBuildCheck\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x26gt; {\n        resolve(data);\n      });\n    });\n\n    app.webpack_client_build_success = clientData.state;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!(app.webpack_server_build_success \x26amp;\x26amp; app.webpack_client_build_success)) {\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (app.webpack_loading_text) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = app.webpack_loading_text;\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.resolve(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27.\/lib\/template\/loading.html\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = app.webpack_loading_text = fs.readFileSync(filePath, \x3cspan class=\x22hljs-string\x22\x3e\x27utf8\x27\x3c\/span\x3e);\n      }\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e* next;\n    }\n  }\n});\n\napp.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, data =\x26gt; {\n  app.webpack_server_build_success = data.state;\n});\n\napp.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x26gt; {\n  app.webpack_client_build_success = data.state;\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eagent.js 启动koa实例和webpack编译流程\x3c\/h4\x3e\n\x3cp\x3e这里client和server编译单独启动koa实例, 而不是一个是因为在测试时发现编译会导致热更新冲突.\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e启动webpack client 编译模式, 负责编译browser运行文件(js,css,image等静态资源)\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x27use strict\x27;\n\nconst webpack = require(\x27webpack\x27);\nconst koa = require(\x27koa\x27);\nconst cors = require(\x27kcors\x27);\nconst app = koa();\napp.use(cors());\nconst Constant = require(\x27.\/constant\x27);\nconst Utils = require(\x27.\/utils\x27);\n\nmodule.exports = agent =\x3e {\n\n  const config = agent.config.webpack;\n  const webpackConfig = config.clientConfig;\n  const compiler = webpack([webpackConfig]);\n\n  compiler.plugin(\x27done\x27, compilation =\x3e {\n    \/\/ Child extract-text-webpack-plugin:\n    compilation.stats.forEach(stat =\x3e {\n      stat.compilation.children = stat.compilation.children.filter(child =\x3e {\n        return child.name !== \x27extract-text-webpack-plugin\x27;\n      });\n    });\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, { state: true });\n    agent.webpack_client_build_success = true;\n  });\n\n  const devMiddleware = require(\x27koa-webpack-dev-middleware\x27)(compiler, {\n    publicPath: webpackConfig.output.publicPath,\n    stats: {\n      colors: true,\n      children: true,\n      modules: false,\n      chunks: false,\n      chunkModules: false,\n    },\n    watchOptions: {\n      ignored: \/node_modules\/,\n    },\n  });\n\n  const hotMiddleware = require(\x27koa-webpack-hot-middleware\x27)(compiler, {\n    log: false,\n    reload: true,\n  });\n\n  app.use(devMiddleware);\n  app.use(hotMiddleware);\n\n  app.listen(config.port, err =\x3e {\n    if (!err) {\n      agent.logger.info(`start webpack client build service: http:\/\/127.0.0.1:${config.port}`);\n    }\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, () =\x3e {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, { state: agent.webpack_client_build_success });\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY, data =\x3e {\n    const fileContent = Utils.readWebpackMemoryFile(compiler, data.filePath);\n    if (fileContent) {\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, {\n        fileContent,\n      });\n    } else {\n      agent.logger.error(`webpack client memory file[${data.filePath}] not exist!`);\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, {\n        fileContent: \x27\x27,\n      });\n    }\n  });\n};\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e\x27use strict\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e webpack = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27webpack\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e cors = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27kcors\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = koa();\napp.use(cors());\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Constant = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/constant\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Utils = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/utils\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eagent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e config = agent.config.webpack;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e webpackConfig = config.clientConfig;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiler = webpack([webpackConfig]);\n\n  compiler.plugin(\x3cspan class=\x22hljs-string\x22\x3e\x27done\x27\x3c\/span\x3e, compilation =\x26gt; {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Child extract-text-webpack-plugin:\x3c\/span\x3e\n    compilation.stats.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3estat\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      stat.compilation.children = stat.compilation.children.filter(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3echild\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e child.name !== \x3cspan class=\x22hljs-string\x22\x3e\x27extract-text-webpack-plugin\x27\x3c\/span\x3e;\n      });\n    });\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, { \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e });\n    agent.webpack_client_build_success = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n  });\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e devMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-dev-middleware\x27\x3c\/span\x3e)(compiler, {\n    \x3cspan class=\x22hljs-attr\x22\x3epublicPath\x3c\/span\x3e: webpackConfig.output.publicPath,\n    \x3cspan class=\x22hljs-attr\x22\x3estats\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ecolors\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echildren\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3emodules\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echunks\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echunkModules\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3ewatchOptions\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3eignored\x3c\/span\x3e: \x3cspan class=\x22hljs-regexp\x22\x3e\/node_modules\/\x3c\/span\x3e,\n    },\n  });\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e hotMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-hot-middleware\x27\x3c\/span\x3e)(compiler, {\n    \x3cspan class=\x22hljs-attr\x22\x3elog\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3ereload\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n  });\n\n  app.use(devMiddleware);\n  app.use(hotMiddleware);\n\n  app.listen(config.port, err =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!err) {\n      agent.logger.info(\x3cspan class=\x22hljs-string\x22\x3e`start webpack client build service: http:\/\/127.0.0.1:\x3cspan class=\x22hljs-subst\x22\x3e${config.port}\x3c\/span\x3e`\x3c\/span\x3e);\n    }\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, () =\x26gt; {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, { \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: agent.webpack_client_build_success });\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY, data =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fileContent = Utils.readWebpackMemoryFile(compiler, data.filePath);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (fileContent) {\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, {\n        fileContent,\n      });\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      agent.logger.error(\x3cspan class=\x22hljs-string\x22\x3e`webpack client memory file[\x3cspan class=\x22hljs-subst\x22\x3e${data.filePath}\x3c\/span\x3e] not exist!`\x3c\/span\x3e);\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, {\n        \x3cspan class=\x22hljs-attr\x22\x3efileContent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e,\n      });\n    }\n  });\n};\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e启动webpack server 编译模式, 负责编译服务器端Node运行文件\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x27use strict\x27;\n\nconst webpack = require(\x27webpack\x27);\nconst koa = require(\x27koa\x27);\nconst cors = require(\x27kcors\x27);\nconst app = koa();\napp.use(cors());\nconst Constant = require(\x27.\/constant\x27);\nconst Utils = require(\x27.\/utils\x27);\n\nmodule.exports = agent =\x3e {\n  const config = agent.config.webpack;\n  const serverWebpackConfig = config.serverConfig;\n  const compiler = webpack([serverWebpackConfig]);\n\n  compiler.plugin(\x27done\x27, () =\x3e {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, { state: true });\n    agent.webpack_server_build_success = true;\n  });\n\n  const devMiddleware = require(\x27koa-webpack-dev-middleware\x27)(compiler, {\n    publicPath: serverWebpackConfig.output.publicPath,\n    stats: {\n      colors: true,\n      children: true,\n      modules: false,\n      chunks: false,\n      chunkModules: false,\n    },\n    watchOptions: {\n      ignored: \/node_modules\/,\n    },\n  });\n\n  app.use(devMiddleware);\n\n  app.listen(config.port \x2b 1, err =\x3e {\n    if (!err) {\n      agent.logger.info(`start webpack server build service: http:\/\/127.0.0.1:${config.port \x2b 1}`);\n    }\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, () =\x3e {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, { state: agent.webpack_server_build_success });\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY, data =\x3e {\n    const fileContent = Utils.readWebpackMemoryFile(compiler, data.filePath);\n    if (fileContent) {\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, {\n        fileContent,\n      });\n    } else {\n      \/\/ agent.logger.error(`webpack server memory file[${data.filePath}] not exist!`);\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, {\n        fileContent: \x27\x27,\n      });\n    }\n  });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e\x27use strict\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e webpack = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27webpack\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e cors = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27kcors\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = koa();\napp.use(cors());\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Constant = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/constant\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Utils = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/utils\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eagent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e config = agent.config.webpack;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e serverWebpackConfig = config.serverConfig;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiler = webpack([serverWebpackConfig]);\n\n  compiler.plugin(\x3cspan class=\x22hljs-string\x22\x3e\x27done\x27\x3c\/span\x3e, () =\x26gt; {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, { \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e });\n    agent.webpack_server_build_success = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n  });\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e devMiddleware = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-webpack-dev-middleware\x27\x3c\/span\x3e)(compiler, {\n    \x3cspan class=\x22hljs-attr\x22\x3epublicPath\x3c\/span\x3e: serverWebpackConfig.output.publicPath,\n    \x3cspan class=\x22hljs-attr\x22\x3estats\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3ecolors\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echildren\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3emodules\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echunks\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3echunkModules\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n    },\n    \x3cspan class=\x22hljs-attr\x22\x3ewatchOptions\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3eignored\x3c\/span\x3e: \x3cspan class=\x22hljs-regexp\x22\x3e\/node_modules\/\x3c\/span\x3e,\n    },\n  });\n\n  app.use(devMiddleware);\n\n  app.listen(config.port \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, err =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!err) {\n      agent.logger.info(\x3cspan class=\x22hljs-string\x22\x3e`start webpack server build service: http:\/\/127.0.0.1:\x3cspan class=\x22hljs-subst\x22\x3e${config.port \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e}\x3c\/span\x3e`\x3c\/span\x3e);\n    }\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, () =\x26gt; {\n    agent.messenger.sendToApp(Constant.EVENT_WEBPACK_SERVER_BUILD_STATE, { \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: agent.webpack_server_build_success });\n  });\n\n  agent.messenger.on(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY, data =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fileContent = Utils.readWebpackMemoryFile(compiler, data.filePath);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (fileContent) {\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, {\n        fileContent,\n      });\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ agent.logger.error(`webpack server memory file[${data.filePath}] not exist!`);\x3c\/span\x3e\n      agent.messenger.sendToApp(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, {\n        \x3cspan class=\x22hljs-attr\x22\x3efileContent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e,\n      });\n    }\n  });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e挂载 webpack 内存读取实例到\x3ccode\x3eapp\x3c\/code\x3e上面, 方便业务扩展实现, 代码如下:\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e我们通过worker向agent发送消息, 就可以从webpack内存获取文件内容, 下面简单封装一下:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class FileSystem {\n\n  constructor(app) {\n    this.app = app;\n  }\n\n  readClientFile(filePath, fileName) {\n    return new Promise(resolve =\x3e {\n      this.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY, {\n        filePath,\n        fileName,\n      });\n      this.app.messenger.on(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, data =\x3e {\n        resolve(data.fileContent);\n      });\n    });\n  }\n\n  readServerFile(filePath, fileName) {\n    return new Promise(resolve =\x3e {\n      this.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY, {\n        filePath,\n        fileName,\n      });\n      this.app.messenger.on(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, data =\x3e {\n        resolve(data.fileContent);\n      });\n    });\n  }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eFileSystem\x3c\/span\x3e \x3c\/span\x3e{\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(app) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app = app;\n  }\n\n  readClientFile(filePath, fileName) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY, {\n        filePath,\n        fileName,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.on(Constant.EVENT_WEBPACK_READ_CLIENT_FILE_MEMORY_CONTENT, data =\x26gt; {\n        resolve(data.fileContent);\n      });\n    });\n  }\n\n  readServerFile(filePath, fileName) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.sendToAgent(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY, {\n        filePath,\n        fileName,\n      });\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.messenger.on(Constant.EVENT_WEBPACK_READ_SERVER_FILE_MEMORY_CONTENT, data =\x26gt; {\n        resolve(data.fileContent);\n      });\n    });\n  }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在app\/extend\/application.js 挂载webpack实例\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const WEBPACK = Symbol(\x27Application#webpack\x27);\nmodule.exports = {\n  get webpack() {\n    if (!this[WEBPACK]) {\n      this[WEBPACK] = new FileSystem(this);\n    }\n    return this[WEBPACK];\n  },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e WEBPACK = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Application#webpack\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = {\n  get webpack() {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[WEBPACK]) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[WEBPACK] = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e FileSystem(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[WEBPACK];\n  },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e本地开发webpack热更新内存存储读取和线上应用文件读取逻辑分离\x3c\/h4\x3e\n\x3cp\x3e基于上面编译流程实现和webpack实例, 我们很容易实现koa方式的本地开发和线上运行代码分离. 下面我们就以vue 服务器渲染render实现为例:\x3c\/p\x3e\n\x3cp\x3e在egg-view插件开发规范中,我们会在ctx上面挂载render方法, render方法会根据文件名进行文件读取, 模板与数据编译, 从而实现模板的渲染.如下就是controller的调用方式:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22exports.index = function* (ctx) {\n  yield ctx.render(\x27index\/index.js\x27, Model.getPage(1, 10));\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eexports.index = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* (\x3cspan class=\x22hljs-params\x22\x3ectx\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e ctx.render(\x3cspan class=\x22hljs-string\x22\x3e\x27index\/index.js\x27\x3c\/span\x3e, Model.getPage(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e));\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中最关键的一步是根据文件名进行文件读取, 只要view插件设计时, 把文件读取的方法暴露出来(例如上面的koa的readFile),就可以实现本地开发webpack热更新内存存储读取.\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3evue view engine设计实现:\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const Engine = require(\x27..\/..\/lib\/engine\x27);\nconst VUE_ENGINE = Symbol(\x27Application#vue\x27);\n\nmodule.exports = {\n\n  get vue() {\n    if (!this[VUE_ENGINE]) {\n      this[VUE_ENGINE] = new Engine(this);\n    }\n    return this[VUE_ENGINE];\n  },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Engine = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/..\/lib\/engine\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e VUE_ENGINE = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Application#vue\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = {\n\n  get vue() {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[VUE_ENGINE]) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[VUE_ENGINE] = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Engine(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[VUE_ENGINE];\n  },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Engine {\n  constructor(app) {\n    this.app = app;\n    this.config = app.config.vue;\n    this.cache = LRU(this.config.cache);\n    this.fileLoader = new FileLoader(app, this.cache);\n    this.renderer = vueServerRenderer.createRenderer();\n    this.renderOptions = Object.assign({\n      cache: this.cache,\n    }, this.config.renderOptions);\n  }\n\n  createBundleRenderer(code, renderOptions) {\n    return vueServerRenderer.createBundleRenderer(code, Object.assign({}, this.renderOptions, renderOptions));\n  }\n\n  * readFile(name) {\n    return yield this.fileLoader.load(name);\n  }\n\n  render(code, data = {}, options = {}) {\n    return new Promise((resolve, reject) =\x3e {\n      this.createBundleRenderer(code, options.renderOptions).renderToString(data, (err, html) =\x3e {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(html);\n        }\n      });\n    });\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEngine\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(app) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app = app;\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.config = app.config.vue;\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.cache = LRU(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.config.cache);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.fileLoader = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e FileLoader(app, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.cache);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.renderer = vueServerRenderer.createRenderer();\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.renderOptions = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign({\n      \x3cspan class=\x22hljs-attr\x22\x3ecache\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.cache,\n    }, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.config.renderOptions);\n  }\n\n  createBundleRenderer(code, renderOptions) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e vueServerRenderer.createBundleRenderer(code, \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign({}, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.renderOptions, renderOptions));\n  }\n\n  * readFile(name) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.fileLoader.load(name);\n  }\n\n  render(code, data = {}, options = {}) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.createBundleRenderer(code, options.renderOptions).renderToString(data, (err, html) =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n          reject(err);\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n          resolve(html);\n        }\n      });\n    });\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3ectx.render 方法\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class View {\n  constructor(ctx) {\n    this.app = ctx.app;\n  }\n\n  * render(name, locals, options = {}) {\n    \/\/ 我们通过覆写app.vue.readFile即可改变文件读取逻辑\n    const code = yield this.app.vue.readFile(name);\n    return this.app.vue.render(code, { state: locals }, options);\n  }\n\n  renderString(tpl, locals) {\n    return this.app.vue.renderString(tpl, locals);\n  }\n}\n\nmodule.exports = View;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eView\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(ctx) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app = ctx.app;\n  }\n\n  * render(name, locals, options = {}) {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 我们通过覆写app.vue.readFile即可改变文件读取逻辑\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e code = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.vue.readFile(name);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.vue.render(code, { \x3cspan class=\x22hljs-attr\x22\x3estate\x3c\/span\x3e: locals }, options);\n  }\n\n  renderString(tpl, locals) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.app.vue.renderString(tpl, locals);\n  }\n}\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = View;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e服务器view渲染插件实现 \x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-view-vue\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-view-vue\x3c\/a\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e通过webpack实例覆写app.vue.readFile 改变从webpack内存读取文件内容.\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22if (app.vue) {\n  app.vue.readFile = fileName =\x3e {\n    const filePath = path.isAbsolute(fileName) ? fileName : path.join(app.config.view.root[0], fileName);\n    if (\/\\.js$\/.test(fileName)) {\n      return app.webpack.fileSystem.readServerFile(filePath, fileName);\n    }\n    return app.webpack.fileSystem.readClientFile(filePath, fileName);\n  };\n}\n\napp.messenger.on(app.webpack.Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x3e {\n  if (data.state) {\n    const filepath = app.config.webpackvue.build.manifest;\n    const promise = app.webpack.fileSystem.readClientFile(filepath);\n    promise.then(content =\x3e {\n      fs.writeFileSync(filepath, content, \x27utf8\x27);\n    });\n  }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (app.vue) {\n  app.vue.readFile = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3efileName\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filePath = path.isAbsolute(fileName) ? fileName : path.join(app.config.view.root[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e], fileName);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-regexp\x22\x3e\/\\.js$\/\x3c\/span\x3e.test(fileName)) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e app.webpack.fileSystem.readServerFile(filePath, fileName);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e app.webpack.fileSystem.readClientFile(filePath, fileName);\n  };\n}\n\napp.messenger.on(app.webpack.Constant.EVENT_WEBPACK_CLIENT_BUILD_STATE, data =\x26gt; {\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (data.state) {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e filepath = app.config.webpackvue.build.manifest;\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e promise = app.webpack.fileSystem.readClientFile(filepath);\n    promise.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3econtent\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n      fs.writeFileSync(filepath, content, \x3cspan class=\x22hljs-string\x22\x3e\x27utf8\x27\x3c\/span\x3e);\n    });\n  }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3ewebpack \x2b vue 编译插件实现 \x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-webpack-vue\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-webpack-vue\x3c\/a\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3eegg\x2bwebpack\x2bvue工程解决方案\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-vue-webpack-boilerplate\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-vue-webpack-boilerplate\x3c\/a\x3e基于Vue多页面和单页面服务器渲染同构工程骨架项目\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-view-vue\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-view-vue\x3c\/a\x3e egg view plugin for vue\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-view-vue-ssr\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-view-vue-ssr\x3c\/a\x3e vue server side render solution for egg-view-vue\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-webpack\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-webpack\x3c\/a\x3e webpack dev server plugin for egg, support read file in memory and hot reload\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/egg-webpack-vue\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eegg-webpack-vue\x3c\/a\x3e egg webpack building solution for vue\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/hubcarl\/easywebpack\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eeasywebpack\x3c\/a\x3e programming instead of configuration, webpack is no longer complex\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>koa和egg项目webpack内存编译和热更新实现</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009377030">https://segmentfault.com/a/1190000009377030</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/h3u84eshq1/" target="_blank">https://alili.tech/archive/h3u84eshq1/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>