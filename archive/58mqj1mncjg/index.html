<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="白洁血战Node并发编程 - 预览"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>白洁血战Node并发编程 - 预览 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/58mqj1mncjg/",
				"appid": "1613049289050283", 
				"title": "白洁血战Node并发编程 - 预览 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-05T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/zp0qfj0lfz8/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/bae7muryc5c/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&text=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&text=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&title=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&is_video=false&description=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&title=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&title=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&title=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f58mqj1mncjg%2f&title=%e7%99%bd%e6%b4%81%e8%a1%80%e6%88%98Node%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20%e9%a2%84%e8%a7%88"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">白洁血战Node并发编程 - 预览</h1><div class="meta"><div class="postdate"><time datetime="2019-01-05" itemprop="datePublished">2019-01-05</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e预览。\x3c\/p\x3e\n\x3cp\x3e先给出一个基础类代码。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const EventEmitter = require(\x27events\x27)\nconst debug = require(\x27debug\x27)(\x27transform\x27)\n\nclass Transform extends EventEmitter {\n\n  constructor (options) {\n    super()\n    this.concurrency = 1\n\n    Object.assign(this, options)\n\n    this.pending = []\n    this.working = []\n    this.finished = []\n    this.failed = []\n\n    this.ins = []\n    this.outs = []\n  }\n\n  push (x) {\n    this.pending.push(x)\n    this.schedule()\n  }\n\n  pull () {\n    let xs = this.finished\n    this.finished = []\n    this.schedule()\n    return xs\n  }\n\n  isBlocked () {\n    return !!this.failed.length ||              \/\/ blocked by failed\n      !!this.finished.length ||                 \/\/ blocked by output buffer (lazy)\n      this.outs.some(t =\x3e t.isBlocked())        \/\/ blocked by outputs transform\n  }\n\n  isStopped () {\n    return !this.working.length \x26amp;\x26amp; this.outs.every(t =\x3e t.isStopped())\n  }\n\n  root () {\n    return this.ins.length === 0 ? this : this.ins[0].root()\n  }\n\n  pipe (next) {\n    this.outs.push(next)\n    next.ins.push(this)\n    return next\n  }\n\n  print () {\n    debug(this.name,\n      this.pending.map(x =\x3e x.name),\n      this.working.map(x =\x3e x.name),\n      this.finished.map(x =\x3e x.name),\n      this.failed.map(x =\x3e x.name),\n      this.isStopped())\n    this.outs.forEach(t =\x3e t.print())\n  }\n\n  schedule () {\n    \/\/ stop working if blocked\n    if (this.isBlocked()) return\n\n    this.pending = this.ins.reduce((acc, t) =\x3e [...acc, ...t.pull()], this.pending)\n\n    while (this.working.length \x3c this.concurrency \x26amp;\x26amp; this.pending.length) {\n      let x = this.pending.shift()\n      this.working.push(x)\n      this.transform(x, (err, y) =\x3e {\n        this.working.splice(this.working.indexOf(x), 1)\n        if (err) {\n          x.error = err\n          this.failed.push(x)\n        } else {\n          if (this.outs.length) {\n            this.outs.forEach(t =\x3e t.push(y))\n          } else {\n            if (this.root().listenerCount(\x27data\x27)) {\n              this.root().emit(\x27data\x27, y)\n            } else {\n              this.finished.push(y)\n            }\n          }\n        }\n\n        this.schedule()\n        this.root().emit(\x27step\x27, this.name, x.name)\n      })\n    }\n  }\n\n}\n\nmodule.exports = Transform\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e EventEmitter = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27events\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e debug = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27debug\x27\x3c\/span\x3e)(\x3cspan class=\x22hljs-string\x22\x3e\x27transform\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eTransform\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEventEmitter\x3c\/span\x3e \x3c\/span\x3e{\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e (options) {\n    \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e()\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.concurrency = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, options)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending = []\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working = []\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished = []\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.failed = []\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ins = []\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs = []\n  }\n\n  push (x) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending.push(x)\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.schedule()\n  }\n\n  pull () {\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e xs = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished = []\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.schedule()\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e xs\n  }\n\n  isBlocked () {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e !!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.failed.length ||              \x3cspan class=\x22hljs-comment\x22\x3e\/\/ blocked by failed\x3c\/span\x3e\n      !!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished.length ||                 \x3cspan class=\x22hljs-comment\x22\x3e\/\/ blocked by output buffer (lazy)\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.some(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3et\x3c\/span\x3e =\x26gt;\x3c\/span\x3e t.isBlocked())        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ blocked by outputs transform\x3c\/span\x3e\n  }\n\n  isStopped () {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e !\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.length \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.every(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3et\x3c\/span\x3e =\x26gt;\x3c\/span\x3e t.isStopped())\n  }\n\n  root () {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ins.length === \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ? \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e : \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ins[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].root()\n  }\n\n  pipe (next) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.push(next)\n    next.ins.push(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next\n  }\n\n  print () {\n    debug(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.name,\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x.name),\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x.name),\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x.name),\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.failed.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x.name),\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isStopped())\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3et\x3c\/span\x3e =\x26gt;\x3c\/span\x3e t.print())\n  }\n\n  schedule () {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ stop working if blocked\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isBlocked()) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.ins.reduce(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eacc, t\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e [...acc, ...t.pull()], \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.length \x26lt; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.concurrency \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending.length) {\n      \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e x = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pending.shift()\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.push(x)\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.transform(x, (err, y) =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.splice(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.working.indexOf(x), \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n          x.error = err\n          \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.failed.push(x)\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.length) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.outs.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3et\x3c\/span\x3e =\x26gt;\x3c\/span\x3e t.push(y))\n          } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.root().listenerCount(\x3cspan class=\x22hljs-string\x22\x3e\x27data\x27\x3c\/span\x3e)) {\n              \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.root().emit(\x3cspan class=\x22hljs-string\x22\x3e\x27data\x27\x3c\/span\x3e, y)\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n              \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.finished.push(y)\n            }\n          }\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.schedule()\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.root().emit(\x3cspan class=\x22hljs-string\x22\x3e\x27step\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.name, x.name)\n      })\n    }\n  }\n\n}\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = Transform\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这段代码目前还是雏形。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eTransform\x3c\/code\x3e类的设计类似node里的\x3ccode\x3estream.Transform\x3c\/code\x3e，但是它的设计目的不是buffering或流性能，而是作为并发编程的基础模块。\x3c\/p\x3e\n\x3cp\x3e如果你熟悉流式编程，\x3ccode\x3eTransform\x3c\/code\x3e的设计就很容易理解；在内部，\x3ccode\x3eTransform\x3c\/code\x3e维护四个队列：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3epending\x3c\/code\x3e是input buffer\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eworking\x3c\/code\x3e是当前正在执行的任务\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3efinished\x3c\/code\x3e是output buffer，它的目的不是为了buffer输出，而是在没有其他输出办法的时候作一下buffer。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3efailed\x3c\/code\x3e是失败的任务\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e\x3ccode\x3eTransform\x3c\/code\x3e可以组合成DAG(Directed Acyclic Graph)使用，\x3ccode\x3eins\x3c\/code\x3e和\x3ccode\x3eouts\x3c\/code\x3e用来存储前置和后置\x3ccode\x3eTransform\x3c\/code\x3e的引用，\x3ccode\x3epipe\x3c\/code\x3e方法负责设置这种双向链接；最常见的情况是双向链表，即\x3ccode\x3eins\x3c\/code\x3e和\x3ccode\x3eouts\x3c\/code\x3e都只有一个对象。但把他们设计成数组就可以允许fan-in, fan-out的结构。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3epush\x3c\/code\x3e和\x3ccode\x3epull\x3c\/code\x3e是write和read的等价物。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eschedule\x3c\/code\x3e是核心函数，它的任务是填充\x3ccode\x3eworking\x3c\/code\x3e队列。在构造函数的参数里应该提供一个名字为\x3ccode\x3etransform\x3c\/code\x3e的异步函数，\x3ccode\x3eschedule\x3c\/code\x3e使用这个函数运行任务，在运行结束后，根据结果把任务推到\x3ccode\x3efailed\x3c\/code\x3e队列、推到下一个\x3ccode\x3eTransformer\x3c\/code\x3e、用root节点的emit输出、或者推到自己的\x3ccode\x3efinished\x3c\/code\x3e队列里。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eTransform\x3c\/code\x3e设计的核心思想，就是把并发任务的状态，不使用对象属性来编码，只使用队列位置来编码；任何一个子任务，在任何时刻，仅存在于一个\x3ccode\x3eTransform\x3c\/code\x3e对象的某个队列中。换句话说，它等于把并发任务用资源来建模。如果你熟悉restful api对过程或状态的建模方式就很容易理解这一点。\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e在\x3ccode\x3eTransform\x3c\/code\x3e中，任何\x3ccode\x3etransform\x3c\/code\x3e异步函数的返回，都是一个\x3ccode\x3estep\x3c\/code\x3e；\x3ccode\x3estep\x3c\/code\x3e是用\x3ccode\x3eTransform\x3c\/code\x3e实现并发组合的最重要概念；\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e每一次\x3ccode\x3etransform\x3c\/code\x3e函数返回，都会发生改变自己的队列或向后续的\x3ccode\x3eTransform\x3c\/code\x3e对象\x3ccode\x3epush\x3c\/code\x3e任务的动作，这个\x3ccode\x3epush\x3c\/code\x3e动作会触发后续\x3ccode\x3eTransform\x3c\/code\x3e的\x3ccode\x3eschedule\x3c\/code\x3e方法；\x3ccode\x3estep\x3c\/code\x3e结束时自己的\x3ccode\x3eschedule\x3c\/code\x3e方法也会被调用，它会重新填充任务。在这些动作结束后，所有\x3ccode\x3eTransform\x3c\/code\x3e的队列变化，就是整个组合任务状态机的下一个状态。\x3c\/p\x3e\n\x3cp\x3e这个状态是显式的，可以打印出来看，对debug非常有帮助；虽然异步i\/o会让这种状态具有不确定性，但至少这里坚持了组合状态机模型在处理并发问题时的同步原则，每个\x3ccode\x3estep\x3c\/code\x3e结束时整体做一次状态迁移，这个状态迁移可以良好定义和观察，这是Event模型下并发编程和Thread模型的重要区别。后者遇到并发逻辑引起的微妙错误时，很难捕捉现场分析，因为每一个Thread是黑盒。\x3c\/p\x3e\n\x3cp\x3e从\x3ccode\x3etransform\x3c\/code\x3e返回开始到\x3ccode\x3eemit(step)\x3c\/code\x3e之间的一连串连锁动作都是中间过程，最终实现一次完整的状态迁移，\x3cstrong\x3e这个过程必须是同步的\x3c\/strong\x3e。不应在这里出现异步、setImmediate或者process.nextTick等调用，这会带来额外的不确定因素和极难发现和修复的bug。\x3c\/p\x3e\n\x3cp\x3e在前面很长一段时间的并发编程实践中，我指出过Promise的race\/settle和错误处理逻辑在一些场景下的困难。Promise的过程逻辑不完备。我也花了很多力气试图在Process代数层面上把error, success, finish, race, settle, abort, pause, resume, 和他们的组合逻辑定义出来，但最终发现这很困难，因为实际编程中各种处理情况太多了。\x3c\/p\x3e\n\x3cp\x3e所以在\x3ccode\x3eTransform\x3c\/code\x3e的设计中，这些逻辑全部被抛弃了，因为事实上它们\x3cstrong\x3e都不是真正的基础并发逻辑\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eTransform\x3c\/code\x3e试图实现组合的基础并发逻辑只有一个：\x3ccode\x3estopped\x3c\/code\x3e。\x3ccode\x3estopped\x3c\/code\x3e的定义非常简单：在一次\x3ccode\x3estep\x3c\/code\x3e结束时，所有的\x3ccode\x3eTransform\x3c\/code\x3e的\x3ccode\x3eworking\x3c\/code\x3e队列为空，就是（整体的）\x3ccode\x3estopped\x3c\/code\x3e。这里要再次强调前述的\x3ccode\x3estep\x3c\/code\x3e结束时同步方法的必要性，如果你在\x3ccode\x3eschedule\x3c\/code\x3e里使用了异步方法调用，那么这个\x3ccode\x3estopped\x3c\/code\x3e的判断就可能是错的，因为\x3ccode\x3eschedule\x3c\/code\x3e可能会在event loop里放置了一个马上就会产生新的\x3ccode\x3eworking\x3c\/code\x3e任务的动作，而\x3ccode\x3eisStopped()\x3c\/code\x3e的判断就错了。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3estopped\x3c\/code\x3e时，整体组合状态可能是success, error, paused, 等等，都不难判断，但目前代码尚未稳定，我不打算加入语法糖。\x3c\/p\x3e\n\x3cp\x3e在blocking i\/o和同步的编程模式下，因果链和代码书写形式是一致的，但是在异步编程下，因果是异步和并发的，你只能去改变因，然后去观察果，这是很多程序员不适应异步编程的根本原因，因为它要改变思维的习惯。\x3c\/p\x3e\n\x3cp\x3e使用\x3ccode\x3eTransform\x3c\/code\x3e来处理并发编程，仍然是在试图重建这个因果链，即使他们是并发的，但是我们要有一个办法把他们串起来；\x3c\/p\x3e\n\x3cp\x3e前面说到的\x3ccode\x3eisStopped()\x3c\/code\x3e是观察到的果，能够影响它的因，是\x3ccode\x3eisBlocked()\x3c\/code\x3e函数，这个函数在\x3ccode\x3eschedule\x3c\/code\x3e中被调用，如果估值为\x3ccode\x3etrue\x3c\/code\x3e，就会阻止\x3ccode\x3eschedule\x3c\/code\x3e继续向\x3ccode\x3eworking\x3c\/code\x3e队列调度任务。\x3c\/p\x3e\n\x3cp\x3e这里写的\x3ccode\x3eisBlocked()\x3c\/code\x3e的代码实现只是一个例子；可以阻止\x3ccode\x3eschedule\x3c\/code\x3e的原因可能有很多，比如出现错误，或者输出buffer满了，这些可以由实现者自己去定义。他们是policy，\x3ccode\x3eisBlocked()\x3c\/code\x3e本身是mechanism。这个策略的粒度是每个\x3ccode\x3eTransform\x3c\/code\x3e对象都可以有自己的策略。比如一个删除临时文件的操作，结果是无关痛痒的，那么它不该因为error就block。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eisBlocked()\x3c\/code\x3e逻辑可以象示例代码里那样向下chain起来，即只要有后续任务block了，前置任务就该停下来；这在绝大多数情况下都是合理的逻辑。因为虽然我们写的是流式处理办法，但是我们不是在处理octet-stream，追求性能的buffering和flow control都没什么意义，如果前面任务在copy文件后面的任务要移动到目标文件夹，如果目标文件夹出了问题前面快速移动了大量文件最终也无法成功。\x3c\/p\x3e\n\x3cp\x3e如果组合状态机停止了，向其中的任何一个\x3ccode\x3eTransform\x3c\/code\x3e对象执行push或者pull操作都可以让整个状态机继续动起来。从root节点\x3ccode\x3epush\x3c\/code\x3e是常见情况，从leaf节点\x3ccode\x3epull\x3c\/code\x3e也是，向中间节点\x3ccode\x3epush\x3c\/code\x3e也是可能的；\x3c\/p\x3e\n\x3cp\x3e资源建模的一个好处是你可以把状态呈现给用户，如果一个复制文件的任务因为文件名冲突而fail，你还可以让用户选择处理策略，例如覆盖或者重命名，在用户选择了操作之后，代码会从某个\x3ccode\x3eTransform\x3c\/code\x3e对象的\x3ccode\x3efailed\x3c\/code\x3e队列中取走一个对象，修改策略参数后重新push进去，那么这个状态机可以继续执行下去；这种可处理的错误不该成为block整个状态机工作（复制其他文件和文件夹）的原因，除非他们积累到可观的数量，在\x3ccode\x3eTransform\x3c\/code\x3e模式下这些都非常容易实现，开发者可以很简单的编写\x3ccode\x3eisBlocked()\x3c\/code\x3e的策略；\x3c\/p\x3e\n\x3cp\x3e和node的stream一样，\x3ccode\x3eTransform\x3c\/code\x3e是lazy的，纯粹的push machine可能会在中间节点buffer大量的任务，这对把任务作为流处理来说是不合适的；同时，Lazy对于停下来的组合状态机能继续run起来很重要，\x3ccode\x3epull\x3c\/code\x3e方法就是这个设计目的，它的\x3ccode\x3eschedule\x3c\/code\x3e逻辑和\x3ccode\x3epush\x3c\/code\x3e一样，只是方向相反；如果设置了Leaf节点会因为输出缓冲而block，它就可以block整个状态机（或者其中的一部分），这在某些情况下也是有用的功能，如果整个状态机的输出因为某种原因暂时无法被立刻消费掉。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eabort\x3c\/code\x3e逻辑没有在代码中实现，但它很容易，可以遍历所有的\x3ccode\x3eTransform\x3c\/code\x3e，如果\x3ccode\x3eworking\x3c\/code\x3e队列中的对象有\x3ccode\x3eabort\x3c\/code\x3e方法，就调用它；这不是个立即的中止，该对象仍然要通过callback返回才能stop。如果要全局的block，可以把所有的Leaf Node都pipe到一个sink节点去，把这个sink节点强制设置成isBlocked，可以block全部。\x3ccode\x3epause\x3c\/code\x3e和\x3ccode\x3eresume\x3c\/code\x3e也是非常类似的逻辑。\x3c\/p\x3e\n\x3cp\x3e当然你可能会遇到类似finally的逻辑是必须去执行的，即使在发生错误的时候，它意味着这个\x3ccode\x3eTransform\x3c\/code\x3e要向前传递\x3ccode\x3eisBlocked\x3c\/code\x3e信息，但是它的Schedule方法不必停止工作。它可以一直运行到把所有队列任务都处理完为止。\x3c\/p\x3e\n\x3cp\x3e重载\x3ccode\x3eschedule\x3c\/code\x3e方法也是可能的；例如你的任务之间有前后依赖的逻辑，你就可以重载\x3ccode\x3eschedule\x3c\/code\x3e方法实现自己的调度方式。另外这里的\x3ccode\x3eschedule\x3c\/code\x3e代码只基于transform函数，很显然如果transform本身是一个\x3ccode\x3eTransform\x3c\/code\x3e对象它也应该工作，实现组合过程，包括Sequencer，Parallel等等，这些都是需要实现的。\x3c\/p\x3e\n\x3cp\x3e总而言之，\x3ccode\x3eisBlocked\x3c\/code\x3e和\x3ccode\x3eschedule\x3c\/code\x3e是分开的逻辑，它们有各自不同的设计目的和使命，你可以重载它们获得自己想要的结果。所以写在这里的代码，重要的不是他们的实现，而是其机制设计和界面设计，以及接口承诺；所有逻辑都是足够原子化的，每个函数只做一件事，\x3ccode\x3eisBlocked\x3c\/code\x3e是因，可以根据需要选择策略，\x3ccode\x3eisStopped\x3c\/code\x3e是果，通过step观察和实现后续逻辑。应该避免通过向基类添加新方法来扩展能力，因为\x3ccode\x3eTransform\x3c\/code\x3e使用队列和任务描述状态，这个描述是完备的，机制也是完善的。\x3c\/p\x3e\n\x3cp\x3e就像我在另一篇介绍JavaScript语言的文章里写的一样，如果针对问题的模型具有完备性，即使抽象，也可以通过组合基本操作和概念获得更多的特性，而不是在模型上增加概念，除非你认为模型不够完备。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e软件工程中不是什么地方都要上状态机（automaton）这么严格的模型工具，项目软件里写到bug数量足够低就可以了，但是如果你要写系统软件或者对正确性有苛刻要求的东西，如果你没有用状态机建模，那么实际上你没有完备设计。\x3c\/p\x3e\n\x3cp\x3e当然有了完备设计也不意味着软件没bug了，但一个好的设计可以让你对问题的理解、遇到问题时找到原因，有极大的帮助。\x3c\/p\x3e\n\x3cp\x3e在复杂系统中，上述的同步方法状态机组合，和Hierarchical的状态机组合，是我们目前已知的两种具有完备性的模型方法。但是两者不同。虽然\x3ccode\x3eTransform\x3c\/code\x3e的组合看起来是一个Hierarchy，但是它就像你在纸上画一棵树，它仍然是二维的，每个\x3ccode\x3estep\x3c\/code\x3e的整体状态联动的迁移只是在populate一次状态迁移的范围，并不是几何级数的增加状态组合；所以我们仍然可以构筑一个线性的因果链，每个\x3ccode\x3estep\x3c\/code\x3e因果因果这样的继续下去，和没有并发的状态机是一样。\x3c\/p\x3e\n\x3cp\x3e本质上这是数学归纳法：如果我们能证明如果n正确，那么n\x2b1是正确的，这就可以证明chain下去的状态组合即使是无穷也是正确的。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3e第二段代码是使用的一个示例，这个class没有必要，是为了保证和老代码接口兼容，因为有一些项目内其他代码的依赖性就不解释了，很容易看明白大概逻辑；列在这里只是展示一下\x3ccode\x3eTransform\x3c\/code\x3e使用时pipe过程的代码样子。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const Promise = require(\x27bluebird\x27)\nconst path = require(\x27path\x27)\nconst fs = Promise.promisifyAll(require(\x27fs\x27))\nconst EventEmitter = require(\x27events\x27)\nconst debug = require(\x27debug\x27)(\x27dircopy\x27)\nconst rimraf = require(\x27rimraf\x27)\n\nconst Transform = require(\x27..\/lib\/transform\x27)\nconst { forceXstat } = require(\x27..\/lib\/xstat\x27)\nconst fileCopy = require(\x27.\/filecopy\x27)\n\nclass DirCopy extends EventEmitter {\n\n  constructor (src, tmp, files, getDirPath) {\n    super()\n\n    let dst = getDirPath()\n    let pipe = new Transform({\n      name: \x27copy\x27,\n      concurrency: 4,\n      transform: (x, callback) =\x3e\n        (x.abort = fileCopy(path.join(src, x.name), path.join(tmp, x.name),\n          (err, fingerprint) =\x3e {\n            delete x.abort\n            if (err) {\n              callback(err)\n            } else {\n              callback(null, (x.fingerprint = fingerprint, x))\n            }\n          }))\n    }).pipe(new Transform({\n      name: \x27stamp\x27,\n      transform: (x, callback) =\x3e\n        forceXstat(path.join(tmp, x.name), { hash: x.fingerprint },\n          (err, xstat) =\x3e err\n            ? callback(err)\n            : callback(null, (x.uuid = xstat.uuid, x)))\n    })).pipe(new Transform({\n      name: \x27move\x27,\n      transform: (x, callback) =\x3e\n        fs.link(path.join(tmp, x.name), path.join(dst, x.name), err =\x3e err\n          ? callback(err)\n          : callback(null, x))\n    })).pipe(new Transform({\n      name: \x27remove\x27,\n      transform: (x, callback) =\x3e rimraf(path.join(tmp, x.name), () =\x3e callback(null))\n    })).root()\n\n    let count = 0\n\n    \/\/ drain data\n    pipe.on(\x27data\x27, data =\x3e this.emit(\x27data\x27, data))\n    pipe.on(\x27step\x27, (tname, xname) =\x3e {\n      debug(\x27------------------------------------------\x27)\n      debug(`step ${count\x2b\x2b}`, tname, xname)\n      pipe.print()\n      if (pipe.isStopped()) this.emit(\x27stopped\x27)\n    })\n\n    files.forEach(name =\x3e pipe.push({ name }))\n    pipe.print()\n    this.pipe = pipe\n  }\n\n}\n\nmodule.exports = DirCopy\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27bluebird\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.promisifyAll(\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fs\x27\x3c\/span\x3e))\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e EventEmitter = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27events\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e debug = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27debug\x27\x3c\/span\x3e)(\x3cspan class=\x22hljs-string\x22\x3e\x27dircopy\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e rimraf = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27rimraf\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Transform = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/lib\/transform\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { forceXstat } = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/lib\/xstat\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fileCopy = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/filecopy\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDirCopy\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eEventEmitter\x3c\/span\x3e \x3c\/span\x3e{\n\n  \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e (src, tmp, files, getDirPath) {\n    \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e()\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e dst = getDirPath()\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e pipe = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Transform({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27copy\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3econcurrency\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, callback\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e\n        (x.abort = fileCopy(path.join(src, x.name), path.join(tmp, x.name),\n          (err, fingerprint) =\x26gt; {\n            \x3cspan class=\x22hljs-keyword\x22\x3edelete\x3c\/span\x3e x.abort\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n              callback(err)\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n              callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, (x.fingerprint = fingerprint, x))\n            }\n          }))\n    }).pipe(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Transform({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27stamp\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, callback\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e\n        forceXstat(path.join(tmp, x.name), { \x3cspan class=\x22hljs-attr\x22\x3ehash\x3c\/span\x3e: x.fingerprint },\n          (err, xstat) =\x26gt; err\n            ? callback(err)\n            : callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, (x.uuid = xstat.uuid, x)))\n    })).pipe(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Transform({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27move\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, callback\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e\n        fs.link(path.join(tmp, x.name), path.join(dst, x.name), err =\x26gt; err\n          ? callback(err)\n          : callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, x))\n    })).pipe(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Transform({\n      \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27remove\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, callback\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e rimraf(path.join(tmp, x.name), () =\x26gt; callback(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e))\n    })).root()\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e count = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ drain data\x3c\/span\x3e\n    pipe.on(\x3cspan class=\x22hljs-string\x22\x3e\x27data\x27\x3c\/span\x3e, data =\x26gt; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27data\x27\x3c\/span\x3e, data))\n    pipe.on(\x3cspan class=\x22hljs-string\x22\x3e\x27step\x27\x3c\/span\x3e, (tname, xname) =\x26gt; {\n      debug(\x3cspan class=\x22hljs-string\x22\x3e\x27------------------------------------------\x27\x3c\/span\x3e)\n      debug(\x3cspan class=\x22hljs-string\x22\x3e`step \x3cspan class=\x22hljs-subst\x22\x3e${count\x2b\x2b}\x3c\/span\x3e`\x3c\/span\x3e, tname, xname)\n      pipe.print()\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (pipe.isStopped()) \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.emit(\x3cspan class=\x22hljs-string\x22\x3e\x27stopped\x27\x3c\/span\x3e)\n    })\n\n    files.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ename\x3c\/span\x3e =\x26gt;\x3c\/span\x3e pipe.push({ name }))\n    pipe.print()\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.pipe = pipe\n  }\n\n}\n\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = DirCopy\x3c\/code\x3e\x3c\/pre\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>白洁血战Node并发编程 - 预览</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010582383">https://segmentfault.com/a/1190000010582383</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/58mqj1mncjg/" target="_blank">https://alili.tech/archive/58mqj1mncjg/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>