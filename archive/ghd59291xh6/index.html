<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="基于CPS变换的尾递归转换算法"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>基于CPS变换的尾递归转换算法 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/ghd59291xh6/",
				"appid": "1613049289050283", 
				"title": "基于CPS变换的尾递归转换算法 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-26T02:30:18"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/sofracrcof/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/oj62g3qlkcm/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&text=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&text=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&title=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&is_video=false&description=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&title=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&title=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&title=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fghd59291xh6%2f&title=%e5%9f%ba%e4%ba%8eCPS%e5%8f%98%e6%8d%a2%e7%9a%84%e5%b0%be%e9%80%92%e5%bd%92%e8%bd%ac%e6%8d%a2%e7%ae%97%e6%b3%95"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">基于CPS变换的尾递归转换算法</h1><div class="meta"><div class="postdate"><time datetime="2019-01-26" itemprop="datePublished">2019-01-26</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch1 id=\x22articleHeader0\x22\x3e前言\x3c\/h1\x3e\n\x3cp\x3e众所周知，\x3cstrong\x3e递归函数容易爆栈\x3c\/strong\x3e，究其原因，便是函数调用前需要先将参数、运行状态压栈，而\x3cstrong\x3e递归则会导致函数的多次无返回调用，参数、状态积压在栈上，最终耗尽栈空间\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e一个解决的办法是从算法上解决，把递归算法改良成只依赖于少数状态的迭代算法，然而此事知易行难，线性递归还容易，树状递归就难以转化了，而且并不是所有递归算法都有非递归实现。\x3c\/p\x3e\n\x3cp\x3e在这里，我介绍一种方法，\x3cstrong\x3e利用\x3ccode\x3eCPS变换\x3c\/code\x3e，把任意递归函数改写成尾调用形式，以\x3ccode\x3econtinuation\x3c\/code\x3e链的形式，将递归占用的栈空间转移到堆上，避免爆栈的悲剧\x3c\/strong\x3e。\x3cbr\x3e\x3cem\x3e需要注意的是，这种方法并不能降低算法的时间复杂度，若是指望此法缩短运行时间无异于白日做梦\x3c\/em\x3e\x3c\/p\x3e\n\x3cp\x3e下文先引入\x3cstrong\x3e尾调用、尾递归、\x3ccode\x3eCPS\x3c\/code\x3e等概念\x3c\/strong\x3e，然后介绍\x3cstrong\x3e\x3ccode\x3eTrampoline\x3c\/code\x3e技法\x3c\/strong\x3e，将尾递归转化为循环形式（无尾调用优化语言的必需品），再\x3cstrong\x3e以\x3ccode\x3esum\x3c\/code\x3e、\x3ccode\x3eFibonacci\x3c\/code\x3e为例子讲解\x3ccode\x3eCPS变换\x3c\/code\x3e过程\x3c\/strong\x3e（虽然这两个例子可以轻易写成迭代算法，没必要搞这么复杂，但是最为常见好懂，因此拿来做例子，免得说题目都得说半天），最后讲\x3cstrong\x3e通用的\x3ccode\x3eCPS变换\x3c\/code\x3e法则\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e看完这篇文章，大家可以去看看\x3ccode\x3eEssentials of Programming Languages\x3c\/code\x3e相关章节，可以有更深的认识\x3c\/p\x3e\n\x3cp\x3e文中代码皆用\x3ccode\x3eJavaScript\x3c\/code\x3e实现\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader1\x22\x3e尾调用 \x26amp;\x26amp; 尾递归\x3c\/h1\x3e\n\x3cp\x3e先来探讨下在什么情况下函数调用才需要保存状态\x3c\/p\x3e\n\x3cp\x3e像\x3ccode\x3eAdd(1, 2)\x3c\/code\x3e、\x3ccode\x3eMUL(1, 2)\x3c\/code\x3e这种明显不需要保存状态，\x3c\/p\x3e\n\x3cp\x3e像\x3ccode\x3eAdd(1, MUL(1, 2))\x3c\/code\x3e这种呢？计算完\x3ccode\x3eMUL(1, 2)\x3c\/code\x3e后需要返回结果接着计算\x3ccode\x3eAdd\x3c\/code\x3e，因此计算\x3ccode\x3eMUL\x3c\/code\x3e前需要保存状态\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e由此，可以得到一个结论，只有函数调用处于参数位置上，调用后需要返回的函数调用才需要保存状态\x3c\/strong\x3e，上面的例子中，\x3ccode\x3eAdd\x3c\/code\x3e是不需要保存状态，\x3ccode\x3eMUL\x3c\/code\x3e需要保存\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e尾调用指的就是，无需返回的函数调用，即函数调用不处于参数位置上\x3c\/strong\x3e，上面的例子中，\x3ccode\x3eAdd\x3c\/code\x3e是尾调用，\x3ccode\x3eMUL\x3c\/code\x3e则不是\x3cbr\x3e\x3cstrong\x3e写成尾调用形式有助于编译器对函数调用进行优化\x3c\/strong\x3e，对于有尾调用优化的语言，只要编译器判断为尾调用，就不会保存状态\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e尾递归则是指，写成尾调用形式的递归函数\x3c\/strong\x3e，下面是一例\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fact_iter = (x, r) =\x3e x == 1 ? 1 : fact_iter(x-1, x*r)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3efact_iter = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, r\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : fact_iter(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e, x*r)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而下面的例子则不是尾递归，因为\x3ccode\x3efact_rec(x-1)\x3c\/code\x3e处于\x3ccode\x3e*\x3c\/code\x3e的第二个参数位置上\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fact_rec = x =\x3e x == 1 ? 1 : x * fact_rec(x-1)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3efact_rec = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : x * fact_rec(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e因为尾递归无需返回，结果只跟传入参数有关，因此只需用少量变量记录其参数变化，便能轻易改写成循环形式，因此\x3cstrong\x3e尾递归和循环是等价\x3c\/strong\x3e的，下面把fact_iter改写成循环：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function fact_loop(x)\n{\n    var r = 1\n    \n    while(x \x3e= 1)\n    {\n        r *= x\n        x--;\n    }\n    \n    return r;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efact_loop\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e r = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(x \x26gt;= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n    {\n        r *= x\n        x--;\n    }\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e r;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1 id=\x22articleHeader2\x22\x3eCPS ( Continuation Passing Style )\x3c\/h1\x3e\n\x3cp\x3e要解释\x3ccode\x3eCPS\x3c\/code\x3e，便先要解释\x3ccode\x3econtinuation\x3c\/code\x3e，\x3cbr\x3e\x3cstrong\x3e\x3ccode\x3econtinuation\x3c\/code\x3e是程序控制流的抽象，表示后面将要进行的计算步骤\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e比如下面这段阶乘函数\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fact_rec = x =\x3e x == 1 ? 1 : x * fact_rec(x-1)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3efact_rec = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : x * fact_rec(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e显然，计算fact_rec(4)之前要先计算fact_rec(3)，计算fact_rec(3)之前要先计算fact_rec(2)，...\x3cbr\x3e于是，可以得到下面的计算链：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x221 ---\x3e fact_rec(1) ---\x3e fact_rec(2) ---\x3e fact_rec(3) ---\x3e fact_rec(4) ---\x3e print\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ---\x26gt; fact_rec(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) ---\x26gt; fact_rec(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) ---\x26gt; fact_rec(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ---\x26gt; fact_rec(\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e) ---\x26gt; print\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e展开计算链后，再从前往后执行，就可以得到最终结果。\x3c\/p\x3e\n\x3cp\x3e对于链上的任意一个步骤，在其之前的是历史步骤，之后的是将要进行的计算，因此之后的都是\x3ccode\x3econtinuation\x3c\/code\x3e\x3cbr\x3e比如，对于\x3ccode\x3efact_rec(3)\x3c\/code\x3e，其\x3ccode\x3econtinuation\x3c\/code\x3e是\x3ccode\x3efact_rec(4) ---\x26gt; print\x3c\/code\x3e\x3cbr\x3e对于\x3ccode\x3efact(1)\x3c\/code\x3e，其\x3ccode\x3econtinuation\x3c\/code\x3e是\x3ccode\x3efact_rec(2) ---\x26gt; fact_rec(3) ---\x26gt; fact_rec(4) ---\x26gt; print\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e当然，上面的计算链不需要我们手工展开和运行，\x3cstrong\x3e程序的控制流已经由语法规定好，我们只需要按语法写好程序，解释器自动会帮我们分解计算步骤并按部就班地计算\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e然而，当现有语法无法满足我们的控制流需求怎么办？比如我们想从一个函数跳转至另一个函数的某处执行，\x3cstrong\x3e语言并没有提供这样的跳转机制，那便需要手工传递控制流\x3c\/strong\x3e了。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3ccode\x3eCPS\x3c\/code\x3e是一种显式地把\x3ccode\x3econtinuation\x3c\/code\x3e作为对象传递的\x3ccode\x3ecoding\x3c\/code\x3e风格，以便能更自由地操控程序的控制流\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e既然是一种风格，自然需要有约定，\x3cstrong\x3e\x3ccode\x3eCPS\x3c\/code\x3e约定：每个函数都需要有一个参数\x3ccode\x3ekont\x3c\/code\x3e，\x3ccode\x3ekont\x3c\/code\x3e是\x3ccode\x3econtinuation\x3c\/code\x3e的简写，表示对计算结果的后续处理\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e比如上面的\x3ccode\x3efact_rec(x)\x3c\/code\x3e就需要改写为\x3ccode\x3efact_rec(x, kont)\x3c\/code\x3e，读作 “计算出\x3ccode\x3ex\x3c\/code\x3e阶乘后，用\x3ccode\x3ekont\x3c\/code\x3e对阶乘结果做处理”\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3ekont\x3c\/code\x3e同样需要有约定，因为\x3ccode\x3econtinuation\x3c\/code\x3e是对某计算阶段结果做处理的，因此\x3cstrong\x3e规定\x3ccode\x3ekont\x3c\/code\x3e为一个单参数输入，单参数输出的函数\x3c\/strong\x3e，即\x3ccode\x3ekont\x3c\/code\x3e的类型是\x3ccode\x3ea-\x26gt;b\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e因此，按\x3ccode\x3eCPS\x3c\/code\x3e约定改写后的\x3ccode\x3efact_rec\x3c\/code\x3e如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fact_rec = (x, kont) =\x3e x == 1 ? kont(1) : fact_rec(x-1, res =\x3e kont(x*res))\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3efact_rec = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? kont(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) : fact_rec(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e, res =\x26gt; kont(x*res))\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当我们运行\x3ccode\x3efact_rec(4, r=\x26gt;r)\x3c\/code\x3e，就可以得到结果\x3ccode\x3e24\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e模拟一下\x3ccode\x3efact_rec(3, r=\x26gt;r)\x3c\/code\x3e的执行过程，就会发现，\x3cstrong\x3e解释器会先将计算链分解展开\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fact_rec(3, r=\x3er)\nfact_rec(2, res =\x3e (r=\x3er)(3*res))\nfact_rec(1, res =\x3e (res =\x3e (r=\x3er)(3*res))(2*res))\n(res =\x3e (res =\x3e (r=\x3er)(3*res))(2*res))(1)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3efact_rec(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e, r=\x26gt;r)\nfact_rec(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, res =\x26gt; (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e=\x26gt;\x3c\/span\x3er)(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e*res))\nfact_rec(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e=\x26gt;\x3c\/span\x3er)(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e*res))(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e*res))\n(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e=\x26gt;\x3c\/span\x3er)(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e*res))(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e*res))(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当然，这种风格非常\x3cstrong\x3e反人类\x3c\/strong\x3e，因为\x3cstrong\x3e内层函数被外层函数的参数分在两端包裹住，不符合人类的线性思维\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e我们写成下面这种符合直觉的形式\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x221 ---\x3e res =\x3e 2*res ---\x3e res =\x3e 3*res ---\x3e res =\x3e res\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ---\x26gt; \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e*res ---\x26gt; \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e*res ---\x26gt; \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e链上每一个步骤的输出作为下一步骤的输入\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当解释器展开成上面的计算链后，便开始从左往右的计算，直到运行完所有的计算步骤\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e需要注意到的是，\x3cstrong\x3e因为\x3ccode\x3ekont\x3c\/code\x3e承担了函数后续所有的计算流程，因此不需要返回，所以对\x3ccode\x3ekont\x3c\/code\x3e的调用便是尾调用\x3c\/strong\x3e\x3cbr\x3e\x3cstrong\x3e当我们把程序中所有的函数都按\x3ccode\x3eCPS\x3c\/code\x3e约定改写以后，程序中所有的函数调用就都变成了尾调用了\x3c\/strong\x3e，而这正是本文的目的\x3cbr\x3e这个改写的过程就称为\x3cstrong\x3eCPS变换\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e需要警惕的是，\x3cstrong\x3e\x3ccode\x3eCPS变换\x3c\/code\x3e并非没有状态保存这个过程，它只是把状态保存到continuation对象中\x3c\/strong\x3e，然后一级一级地往下传，因此\x3cstrong\x3e空间复杂度并没有降低，只是不需要由函数栈帧来承受保存状态的负担而已\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e\x3ccode\x3eCPS\x3c\/code\x3e约定简约，却可显式地控制程序的执行，程序里各种形式的控制流都可以用它来表达（比如协程、循环、选择等）\x3c\/strong\x3e，\x3cbr\x3e所以很多函数式语言的实现都采用了\x3ccode\x3eCPS\x3c\/code\x3e形式，将语句的执行分解成一个小步骤一次执行，\x3cbr\x3e当然，\x3cstrong\x3e也因为\x3ccode\x3eCPS\x3c\/code\x3e形式过于简洁，表达起来过于繁琐，可以看成一种高级的汇编语言\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader3\x22\x3eTrampoline技法\x3c\/h1\x3e\n\x3cp\x3e经过\x3ccode\x3eCPS变换\x3c\/code\x3e后，递归函数已经转化成一条长长的\x3ccode\x3econtinuation\x3c\/code\x3e链\x3c\/p\x3e\n\x3cp\x3e尾调用函数层层嵌套，永不返回，然而\x3cstrong\x3e在缺乏尾调用优化的语言中，并不知晓函数不会返回，状态、参数压栈依旧会发生，因此需要手动强制弹出下一层调用的函数，禁止解释器的压栈行为，这就是所谓的\x3ccode\x3eTrampoline\x3c\/code\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e因为\x3ccode\x3econtinuation\x3c\/code\x3e只接受一个结果参数，然后调用另一个\x3ccode\x3econtinuation\x3c\/code\x3e处理结果，因此我们\x3cstrong\x3e需要显式地用变量\x3ccode\x3ev\x3c\/code\x3e、\x3ccode\x3ekont\x3c\/code\x3e分别表示上一次的结果\x3c\/strong\x3e、下一个\x3ccode\x3econtinuation\x3c\/code\x3e，然后在一个循环里不断地计算\x3ccode\x3econtinuation\x3c\/code\x3e，直到处理完整条\x3ccode\x3econtinuation\x3c\/code\x3e链，然后返回结果\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont_v)  \/\/ kont_v = { kont: ..., v: ... }\n{\n    while(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    return kont_v.v;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont_v\x3c\/span\x3e)  \/\/ \x3cspan class=\x22hljs-title\x22\x3ekont_v\x3c\/span\x3e = \x3c\/span\x3e{ kont: ..., \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: ... }\n{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont_v.v;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e\x3ccode\x3ekont_v.kont\x3c\/code\x3e是一个\x3ccode\x3ebounce\x3c\/code\x3e，每次执行\x3ccode\x3ekont_v.kont(kont_v.v)\x3c\/code\x3e时，都会根据上次结果计算出本次结果，然后弹出下一级\x3ccode\x3econtinuation\x3c\/code\x3e，然后保存在对象\x3ccode\x3e{v: ..., kont: ...}\x3c\/code\x3e里\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当然，在\x3ccode\x3ebounce\x3c\/code\x3e中用\x3ccode\x3ebind\x3c\/code\x3e的话，就不需要构造对象显式保存\x3ccode\x3ev\x3c\/code\x3e了，因为\x3ccode\x3ebind\x3c\/code\x3e会将\x3ccode\x3ev\x3c\/code\x3e保存到闭包中，此时，\x3ccode\x3etrampoline\x3c\/code\x3e变成：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont)\n{\n    while(typeof kont == \x26quot;function\x26quot;)\n        kont = kont();\n    return kont.val;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e kont == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e)\n        kont = kont();\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont.val;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e用\x3ccode\x3ebind\x3c\/code\x3e改写会更简洁，\x3cstrong\x3e然而，因为想要求的值有可能是个\x3ccode\x3efunction\x3c\/code\x3e，我们需要在\x3ccode\x3ebounce\x3c\/code\x3e里用对象\x3ccode\x3e{val: ...}\x3c\/code\x3e把结果包装起来\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e具体应用可看下面的例子\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader4\x22\x3e线性递归的CPS变换：求和\x3c\/h1\x3e\n\x3cp\x3e\x3cstrong\x3e求和的递归实现：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum = x =\x3e { if(x == 0) return 0; else return x \x2b sum(x-1) }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esum = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e x \x2b sum(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e) }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当参数过大，比如\x3ccode\x3esum(4000000)\x3c\/code\x3e，提示\x3ccode\x3eUncaught RangeError: Maximum call stack size exceeded\x3c\/code\x3e，爆栈了！\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e现在，我们通过\x3ccode\x3eCPS变换\x3c\/code\x3e，将上面的函数改写成尾递归形式：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e首先，\x3cstrong\x3e为\x3ccode\x3esum\x3c\/code\x3e多添加一个参数表示\x3ccode\x3econtinuation\x3c\/code\x3e，表示对计算结果进行的后续处理，\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum = (x, kont) =\x3e ...\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esum = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e ...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中，\x3ccode\x3ekont\x3c\/code\x3e是一个单参数函数，形如 \x3ccode\x3eres =\x26gt; ...\x3c\/code\x3e，表示对结果\x3ccode\x3eres\x3c\/code\x3e的后续处理\x3c\/p\x3e\n\x3cp\x3e然后\x3cstrong\x3e逐情况考虑\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cp\x3e当\x3ccode\x3ex == 0\x3c\/code\x3e时，计算结果直接为\x3ccode\x3e0\x3c\/code\x3e，并将\x3ccode\x3ekont\x3c\/code\x3e应用到结果上,\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum = (x, kont) =\x3e { if(x == 0) return kont(0); else ... }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esum = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e ... }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当\x3ccode\x3ex != 0\x3c\/code\x3e时，需要先计算\x3ccode\x3ex-1\x3c\/code\x3e的求和，然后将计算结果与\x3ccode\x3ex\x3c\/code\x3e相加，然后把相加结果输入\x3ccode\x3ekont\x3c\/code\x3e中，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum = (x, kont) =\x3e { \n       if(x == 0) return kont(0); \n       else return sum( x - 1, res =\x3e kont(res \x2b x) ) };\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3esum = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e { \n       \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e); \n       \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e sum( x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; kont(res \x2b x) ) };\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e好了，现在我们已经完成了\x3ccode\x3esum\x3c\/code\x3e的\x3ccode\x3eCPS变换\x3c\/code\x3e，大家仔细看看，上面的函数已经是尾递归形式啦。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e现在还有最后的问题，\x3cstrong\x3e怎么去调用？\x3c\/strong\x3e比如要算\x3ccode\x3e4的求和\x3c\/code\x3e，\x3ccode\x3esum(4, kont)\x3c\/code\x3e，这里的\x3ccode\x3ekont\x3c\/code\x3e应该是什么呢？\x3c\/p\x3e\n\x3cp\x3e可以这样想，当我们计算出结果，后续的处理就是把结果简单地输出，因此\x3cstrong\x3e\x3ccode\x3ekont\x3c\/code\x3e应为\x3ccode\x3eres =\x26gt; res\x3c\/code\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum(4, res =\x3e res)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esum(\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e, res =\x26gt; res)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e把上面的代码复制到\x3ccode\x3eConsole\x3c\/code\x3e，运行就能得到结果\x3ccode\x3e10\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e下面我们模拟一下sum(3, res =\x26gt; res)的运作，以对其有个直观的认识\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sum( 3, res =\x3e res )\nsum( 2, res =\x3e ( (res =\x3e res)(res\x2b3) ) )\nsum( 1, res =\x3e ( res =\x3e ( (res =\x3e res)(res\x2b3) ) )(res\x2b2) ) )\nsum( 0, res =\x3e ( res =\x3e ( res =\x3e ( (res =\x3e res)(res\x2b3) ) )(res\x2b2) ) )(res\x2b1) )\n\n\/\/ 展开continuation链\n( res =\x3e ( res =\x3e ( res =\x3e ( (res =\x3e res)(res\x2b3) ) )(res\x2b2) ) )(res\x2b1) )(0)\n\n\/\/ 收缩continuation链\n( res =\x3e ( res =\x3e ( (res =\x3e res)(res\x2b3) ) )(res\x2b2) )(0\x2b1)\n( res =\x3e ( (res =\x3e res)(res\x2b3) ) )(0\x2b1\x2b2)\n(res =\x3e res)(0\x2b1\x2b2\x2b3)\n6\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3esum( \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e, res =\x26gt; res )\nsum( \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, res =\x26gt; ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )\nsum( \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) ) )\nsum( \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, res =\x26gt; ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) )\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 展开continuation链\x3c\/span\x3e\n( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) )(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 收缩continuation链\x3c\/span\x3e\n( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )(res\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) )(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e ( (\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(res\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) ) )(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e)\n(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res)(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e)\n\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e从上面的展开过程可以看到，\x3cstrong\x3e\x3ccode\x3esum(x, kont)\x3c\/code\x3e分为两个步骤\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3cstrong\x3e展开\x3ccode\x3econtinuation\x3c\/code\x3e链\x3c\/strong\x3e，尾调用函数层层嵌套，先做的\x3ccode\x3econtinuation\x3c\/code\x3e在外层，后做的\x3ccode\x3econtinuation\x3c\/code\x3e放内层，这也是\x3cstrong\x3e\x3ccode\x3eCPS\x3c\/code\x3e反人类的原因\x3c\/strong\x3e，\x3cstrong\x3e人类思考阅读都是线性\x3c\/strong\x3e的（从上往下，从左往右），而\x3cstrong\x3e\x3ccode\x3eCPS\x3c\/code\x3e则是从外到内，而且外层函数和参数包裹着内层\x3c\/strong\x3e，阅读时还需要眼睛在左右两端不断游离\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3cstrong\x3e收缩\x3ccode\x3econtinuation\x3c\/code\x3e链\x3c\/strong\x3e，不断将外层\x3ccode\x3econtinuation\x3c\/code\x3e计算的结果往内层传\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e当然，现在运行\x3ccode\x3esum(4000000， res =\x26gt; res)\x3c\/code\x3e，依然会爆栈，因为\x3ccode\x3ejs\x3c\/code\x3e默认并没有对尾调用做优化，\x3cstrong\x3e我们需要利用上面的\x3ccode\x3eTrampoline\x3c\/code\x3e技法将其改成循环形式\x3c\/strong\x3e（上文已经提过，尾递归和循环等价）\x3c\/p\x3e\n\x3cp\x3e可是等等，上面说的\x3ccode\x3eTrampoline\x3c\/code\x3e技法只针对于收缩\x3ccode\x3econtinuation\x3c\/code\x3e链过程，可是\x3ccode\x3esum(x, kont)\x3c\/code\x3e还包括展开过程啊？别担心，\x3cstrong\x3e可以看到展开过程也是尾递归形式，我们只需稍作修改，就可以将其改成\x3ccode\x3econtinuation\x3c\/code\x3e的形式\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22( r =\x3e sum( x - 1, res =\x3e kont(res \x2b x) )(null)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e( \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e =\x26gt;\x3c\/span\x3e sum( x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; kont(res \x2b x) )(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e如此便可把\x3ccode\x3econtinuation\x3c\/code\x3e链的展开和收缩过程统一起来，写成以下的循环形式\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont_v)\n{\n    while(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    return kont_v.v;\n}\n\nfunction sum_bounce(x, kont)\n{    \n    if(x == 0) return {kont: kont, v: 0};\n    else return { kont: r =\x3e sum_bounce(x - 1, res =\x3e {\n                                                 return { kont: kont, \n                                                          v: res \x2b x }\n                                               } ),\n                  v: null };\n}\n\nvar sum = x =\x3e trampoline( sum_bounce(x, res =\x3e \n                                            {return { kont: null, \n                                                      v: res } }) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont_v\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont_v.v;\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esum_bounce\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e)\n\x3c\/span\x3e{    \n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: kont, \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e};\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e =\x26gt;\x3c\/span\x3e sum_bounce(x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; {\n                                                 \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: kont, \n                                                          \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: res \x2b x }\n                                               } ),\n                  \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e };\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e trampoline( sum_bounce(x, res =\x26gt; \n                                            {\x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \n                                                      \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: res } }) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eOK，\x3cstrong\x3e以上便是改成循环形式的尾递归写法\x3c\/strong\x3e，\x3cbr\x3e把\x3ccode\x3esum(4000000)\x3c\/code\x3e输入\x3ccode\x3eConsole\x3c\/code\x3e，稍等片刻，便能得到答案\x3ccode\x3e8000002000000\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当然，用\x3ccode\x3ebind\x3c\/code\x3e的话可以改写成更简约的形式：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont)\n{\n    while(typeof kont == \x26quot;function\x26quot;)\n        kont = kont();\n    return kont.val;\n}\n\nfunction sum_bounce(x, kont)\n{    \n    if(x == 0) return kont.bind(null, {val: 0});\n    else return sum_bounce.bind( null, x - 1, res =\x3e kont.bind(null, {val: res.val \x2b x}) );\n}\n\nvar sum = x =\x3e trampoline( sum_bounce(x, res =\x3e res) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e kont == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e)\n        kont = kont();\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont.val;\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esum_bounce\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e)\n\x3c\/span\x3e{    \n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3eval\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e});\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e sum_bounce.bind( \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res =\x26gt; kont.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3eval\x3c\/span\x3e: res.val \x2b x}) );\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sum = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e trampoline( sum_bounce(x, res =\x26gt; res) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e也能起到同样的效果\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader5\x22\x3e树状递归的CPS变换：Fibonacci\x3c\/h1\x3e\n\x3cp\x3e因为\x3ccode\x3eFibonacci\x3c\/code\x3e是\x3ccode\x3e树状递归\x3c\/code\x3e，转换起来要比线性递归的\x3ccode\x3esum\x3c\/code\x3e麻烦一些，先\x3cstrong\x3e写出普通的递归算法\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fib = x =\x3e x == 0 ? 1 : ( x == 1 ? 1 : fib(x-1) \x2b fib(x-2) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3efib = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : ( x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e : fib(x\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e) \x2b fib(x\x3cspan class=\x22hljs-number\x22\x3e-2\x3c\/span\x3e) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e同样，当参数过大，比如\x3ccode\x3efib(40000)\x3c\/code\x3e，就会爆栈\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e开始做\x3ccode\x3eCPS变换\x3c\/code\x3e\x3c\/strong\x3e，有前面例子铺垫，下面只讲关键点\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e添加\x3ccode\x3ekont\x3c\/code\x3e参数\x3c\/strong\x3e，则\x3ccode\x3efib = (x, kont) =\x26gt; ...\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e分情况考虑\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当\x3ccode\x3ex == 0 or 1\x3c\/code\x3e\x3c\/strong\x3e，\x3ccode\x3efib = (x, kont) =\x26gt; x == 0 ? kont(1) : ( x == 1 ? kont(1) ...\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当\x3ccode\x3ex != 1 or 1\x3c\/code\x3e\x3c\/strong\x3e，需要先计算\x3ccode\x3ex-1\x3c\/code\x3e的\x3ccode\x3efib\x3c\/code\x3e，再计算出\x3ccode\x3ex-2\x3c\/code\x3e的\x3ccode\x3efib\x3c\/code\x3e，然后将两个结果相加，然后将kont应用到相加结果上\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fib = (x, kont) =\x3e \n      x == 0 ? kont(1) : \n      x == 1 ? kont(1) : \n               fib( x - 1, res1 =\x3e fib(x - 2, res2 =\x3e kont(res1 \x2b res2) ) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3efib = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e \n      x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ? kont(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) : \n      x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? kont(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) : \n               fib( x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, res1 =\x26gt; fib(x - \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, res2 =\x26gt; kont(res1 \x2b res2) ) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e以上便是\x3ccode\x3efib\x3c\/code\x3e经\x3ccode\x3eCPS变换\x3c\/code\x3e后的尾递归形式\x3c\/strong\x3e，可见\x3cstrong\x3e难点在于\x3ccode\x3ekont\x3c\/code\x3e的转化\x3c\/strong\x3e，这里需要好好揣摩\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e最后利用\x3ccode\x3eTrampoline\x3c\/code\x3e技法将尾递归转换成循环形式\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont_v)\n{\n    while(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    return kont_v.v;\n}\n\nfunction fib_bounce(x, kont)\n{    \n    if(x == 0 || x == 1) return {kont: kont, v: 1};\n    else return { \n                  kont: r =\x3e fib_bounce( x - 1, \n                                         res1 =\x3e \n                                         {\n                                            return { \n                                             kont: r =\x3e fib_bounce(x - 2,\n                                                                   res2 =\x3e\n                                                                   { \n                                                                     return  { \n                                                                       kont: kont,\n                                                                       v: res1 \x2b res2\n                                                                     }\n                                                                   }), \n                                             v: null \n                                           }\n                                         } ),\n                  v: null \n                };\n}\n\nvar fib = x =\x3e trampoline( fib_bounce(x, res =\x3e \n                                            {return { kont: null, \n                                                      v: res } }) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont_v\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(kont_v.kont)\n        kont_v = kont_v.kont(kont_v.v);\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont_v.v;\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efib_bounce\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e)\n\x3c\/span\x3e{    \n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e || x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: kont, \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e};\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \n                  \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e =\x26gt;\x3c\/span\x3e fib_bounce( x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \n                                         res1 =\x26gt; \n                                         {\n                                            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \n                                             \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3er\x3c\/span\x3e =\x26gt;\x3c\/span\x3e fib_bounce(x - \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\n                                                                   res2 =\x26gt;\n                                                                   { \n                                                                     \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e  { \n                                                                       \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: kont,\n                                                                       \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: res1 \x2b res2\n                                                                     }\n                                                                   }), \n                                             \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \n                                           }\n                                         } ),\n                  \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \n                };\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fib = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e trampoline( fib_bounce(x, res =\x26gt; \n                                            {\x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e { \x3cspan class=\x22hljs-attr\x22\x3ekont\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, \n                                                      \x3cspan class=\x22hljs-attr\x22\x3ev\x3c\/span\x3e: res } }) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eOK，\x3cstrong\x3e以上便是改成循环形式的尾递归写法\x3c\/strong\x3e，\x3cbr\x3e在\x3ccode\x3econsole\x3c\/code\x3e中输入\x3ccode\x3efib(5)\x3c\/code\x3e、\x3ccode\x3efib(6)\x3c\/code\x3e、\x3ccode\x3efib(7)\x3c\/code\x3e可以验证其正确性，\x3c\/p\x3e\n\x3cp\x3e当然，\x3cstrong\x3e当你运行\x3ccode\x3efib(40000)\x3c\/code\x3e时，发现的确没有提示爆栈了，但是程序却卡死了，何也？\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e正如我在前言说过，这种方法并不会降低树状递归算法的时间复杂度，只是将占用的栈空间以闭包链的形式转移至堆上，免去爆栈的可能，但是\x3cstrong\x3e当参数过大时，运行复杂度过高，\x3ccode\x3econtinuation\x3c\/code\x3e链过长也导致大量内存被占用\x3c\/strong\x3e，因此，优化算法才是王道\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e当然，用\x3ccode\x3ebind\x3c\/code\x3e的话可以改写成更简约的形式：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function trampoline(kont)\n{\n    while(typeof kont == \x26quot;function\x26quot;)\n        kont = kont();\n    return kont.val;\n}\n\nfib_bounce = (x, kont) =\x3e\n x == 0 ? kont.bind(null, {val: 1}) : \n x == 1 ? kont.bind(null, {val: 1}) : \n          fib_bounce.bind( null, x - 1, \n                           res1 =\x3e fib_bounce.bind(null, x - 2,\n                                                   res2 =\x3e kont.bind(null, {val: res1.val \x2b res2.val}) ) )\n\nvar fib = x =\x3e trampoline( fib_bounce(x, res =\x3e res) )\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3etrampoline\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekont\x3c\/span\x3e)\n\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e kont == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e)\n        kont = kont();\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e kont.val;\n}\n\nfib_bounce = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ex, kont\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e\n x == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ? kont.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3eval\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e}) : \n x == \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ? kont.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3eval\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e}) : \n          fib_bounce.bind( \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, x - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \n                           res1 =\x26gt; fib_bounce.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, x - \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,\n                                                   res2 =\x26gt; kont.bind(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, {\x3cspan class=\x22hljs-attr\x22\x3eval\x3c\/span\x3e: res1.val \x2b res2.val}) ) )\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fib = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ex\x3c\/span\x3e =\x26gt;\x3c\/span\x3e trampoline( fib_bounce(x, res =\x26gt; res) )\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e也能起到同样的效果\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader6\x22\x3eCPS变换法则\x3c\/h1\x3e\n\x3cp\x3e对于基本表达式如数字、变量、函数对象、参数是基本表达式的内建函数(如四则运算等)等，不需要进行变换，\x3c\/p\x3e\n\x3cp\x3e若是函数定义，则需要添加一个参数\x3ccode\x3ekont\x3c\/code\x3e，然后对函数体做\x3ccode\x3eCPS变换\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e若是参数位置有函数调用的函数调用，\x3ccode\x3efn(simpleExp1, exp2, ..., expn)\x3c\/code\x3e，如\x3ccode\x3eexp2\x3c\/code\x3e就是第一个是函数调用的参数\x3cbr\x3e则过程比较复杂，用伪代码表述如下：(\x3ccode\x3e\x26lt;\x26lt;...\x26gt;\x26gt;\x3c\/code\x3e内表示表达式， \x3ccode\x3e\x26lt;\x26lt;...@exp...\x26gt;\x3c\/code\x3e表示对exp求值后再代回\x3ccode\x3e\x26lt;\x26lt;...\x26gt;\x26gt;\x3c\/code\x3e中)：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22cpsOfExp(\x3c\x3c fn(simpleExp1, exp2, ..., expn) \x3e\x3e, kont)\n= cpsOfExp(exp2, \x3c\x3c r2 =\x3e @cpsOfExp(\x3c\x3c fn(simpleExp1, r2, ..., expn) \x3e\x3e, kont) \x3e\x3e)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3ecpsOfExp(\x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x26lt; \x3cspan class=\x22hljs-attr\x22\x3efn\x3c\/span\x3e(\x3cspan class=\x22hljs-attr\x22\x3esimpleExp1\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eexp2\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3e...\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eexpn\x3c\/span\x3e) \x26gt;\x3c\/span\x3e\x26gt;, kont)\n= cpsOfExp(exp2, \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x26lt; \x3cspan class=\x22hljs-attr\x22\x3er2\x3c\/span\x3e =\x26gt;\x3c\/span\x3e @cpsOfExp(\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x26lt; \x3cspan class=\x22hljs-attr\x22\x3efn\x3c\/span\x3e(\x3cspan class=\x22hljs-attr\x22\x3esimpleExp1\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3er2\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3e...\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eexpn\x3c\/span\x3e) \x26gt;\x3c\/span\x3e\x26gt;, kont) \x26gt;\x26gt;)\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e顺序表达式的变换亦与上类似\x3c\/p\x3e\n\x3cp\x3e当然这个问题不是这么容易讲清楚，首先你需要对你想要变换的语言了如指掌，知道其表达式类型、求值策略等，\x3cbr\x3e\x3ccode\x3eJavaScript\x3c\/code\x3e语法较为繁杂，解释起来不太方便，\x3cbr\x3e之前我用\x3ccode\x3eC\x2b\x2b\x3c\/code\x3e模板写过一个\x3ccode\x3eCPS\x3c\/code\x3e风格的\x3ccode\x3eLisp\x3c\/code\x3e解释器，日后有时间以此为例详细讲讲\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>基于CPS变换的尾递归转换算法</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000008489245">https://segmentfault.com/a/1190000008489245</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/ghd59291xh6/" target="_blank">https://alili.tech/archive/ghd59291xh6/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>