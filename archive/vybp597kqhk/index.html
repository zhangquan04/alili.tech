<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="React系列---Redux异步流"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>React系列---Redux异步流 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/vybp597kqhk/",
				"appid": "1613049289050283", 
				"title": "React系列---Redux异步流 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-09T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/un4txo9ks/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/splxyfl3yyn/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&text=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&text=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&title=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&is_video=false&description=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&title=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&title=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&title=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fvybp597kqhk%2f&title=React%e7%b3%bb%e5%88%97---Redux%e5%bc%82%e6%ad%a5%e6%b5%81"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">React系列---Redux异步流</h1><div class="meta"><div class="postdate"><time datetime="2019-01-09" itemprop="datePublished">2019-01-09</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e使用Redux访问服务器，同样要要解决异步问题。\x3c\/p\x3e\n\x3cp\x3eRedux单向数据流，由action对象开始驱动，每个action对象被派发到Store之后，被分配给reducer函数，reducer完成数据操作后立刻返回，reducer返回的结果又被拿去更新Store上的状态数据，更新状态数据的操作立刻会被同步给监听Store状态改变的函数，从而引发React视图组件的更新过程。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVQA9v?w=800\x26amp;h=242\x22 src=\x22https:\/\/static.alili.tech\/img\/bVQA9v?w=800\x26amp;h=242\x22 alt=\x22Redux单向数据流\x22 title=\x22Redux单向数据流\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e整个过程都是马不停蹄一路同步执行，根本没有异步操作的机会，那应该在 哪里插入访问服务器的异步操作呢？\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3eredux-thunk中间件\x3c\/h1\x3e\n\x3cp\x3eredux-thunk中间件就是解决redux异步操作的标准方式。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22npm install redux-thunk --save\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs sql\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3enpm \x3cspan class=\x22hljs-keyword\x22\x3einstall\x3c\/span\x3e redux-thunk \x3cspan class=\x22hljs-comment\x22\x3e--save\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e异步actoin对象\x3c\/h2\x3e\n\x3cp\x3eRedux单向数据流的驱动起点是action对象，Redux异步操作也避免不了从派发一个action对象开始。但是这个action对象比较特殊，我们叫它“异步action对象”。\x3c\/p\x3e\n\x3cp\x3e与普通action对象（包含若干字段，其中type必不可少）不同的是，“异步action对象”不是一个普通的JavaScript对象，而是一个函数。\x3c\/p\x3e\n\x3cp\x3e这样一个函数类型的action对象派发出去，由于没有type字段，就没有下一步的reducer什么事了。但reducer又不得不按redux数据流的步骤自动介入进来。所以中间件在此时机站出来，认定这件事非他管不可的话，reducer就得一边凉快去。\x3c\/p\x3e\n\x3cp\x3e所以，redux-thunk的工作就是检查action对象是不是函数，如果不是就撤退。而如果是的话，就执行这个函数，并把Store的dispatch函数和getState函数作为参数传递进去。\x3c\/p\x3e\n\x3cp\x3e寥寥几行的redux-thunk源代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function createThunkMiddleware(extraArgument) {\n    return ({ dispatch, getState }) =\x3e next =\x3e action =\x3e {\n        if(typeof action == \x27function\x27) {\n            return action(dispatch, getState, extraArgument);\n        }\n    };\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateThunkMiddleware\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eextraArgument\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3e{ dispatch, getState }\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e next =\x26gt; \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eaction\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e action == \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e action(dispatch, getState, extraArgument);\n        }\n    };\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以很清楚地看到，当actoin为函数时，并没有调用next或dispatch方法，而是返回action函数的调用。\x3c\/p\x3e\n\x3cp\x3e了解到redux-thunk的原理后，我们模拟一个天气的异步请求。action creator通常可以这么写：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function getWeather(url, params) {\n    return (dispatch, getState) =\x3e { \/\/ 由中间件负责调用，dispatch和getState也由中间件负责传入\n        fetch(url, params)\n            .then(result =\x3e {\n                dispatch({\n                    type: \x27GET_WEATHER_SUCCESS\x27,\n                    payload: result\n                });\n            })\n            .catch(err =\x3e {\n                dispatch({\n                    type: \x27GET_WEATHER_ERROR\x27,\n                    error: err\n                });\n            });\n    };\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs typescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetWeather\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eurl, params\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3edispatch, getState\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e { \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 由中间件负责调用，dispatch和getState也由中间件负责传入\x3c\/span\x3e\n        fetch(url, params)\n            .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                dispatch({\n                    \x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET_WEATHER_SUCCESS\x27\x3c\/span\x3e,\n                    payload: result\n                });\n            })\n            .catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                dispatch({\n                    \x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET_WEATHER_ERROR\x27\x3c\/span\x3e,\n                    error: err\n                });\n            });\n    };\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e异步action函数的代码基本都是这样的套路：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export const sampleAsyncAction = () =\x3e {\n    return (dispatch, getState) =\x3e {\n        \/\/ 在这个函数里可以调用异步函数, 自行决定再合适的时机通过dispatch参数派发新的action对象\n    }\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e sampleAsyncAction = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3edispatch, getState\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在这个函数里可以调用异步函数, 自行决定再合适的时机通过dispatch参数派发新的action对象\x3c\/span\x3e\n    }\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这就是异步action的工作机理，异步action最终还是要产生同步actoin的派发，才能触达视图的响应。redux-thunk要做的工作也就不过如此，但因为引入了一次函数执行，而这个函数还能访问到dispatch和getState，就给异步操作带来了可能。\x3c\/p\x3e\n\x3cp\x3e异步action函数中，可以通过ajax发起对服务器的异步请求，当得到结果之后，通过参数dispatch，把成功或失败的结果当做actoin对象再派发出去。这一次派发的是普通action对象，就不会被redux-thunk截获，直接到达reducer，最终驱动Store上状态的改变。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader2\x22\x3eredux-promise中间件\x3c\/h1\x3e\n\x3cp\x3e我们发现，异步请求其实都是利用promise来完成的，那么为什么不直接通过抽象promise来解决异步流问题呢？\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22npm install redux-promise --save\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs sql\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3enpm \x3cspan class=\x22hljs-keyword\x22\x3einstall\x3c\/span\x3e redux-promise \x3cspan class=\x22hljs-comment\x22\x3e--save\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e通过源码分析一下它是怎么做的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import { isFSA } from \x27flux-standard-action\x27;\n\nfunction isPromise(val) {\n    return val \x26amp;\x26amp; typeof val.then === \x27function\x27;\n}\n\nexport default function promiseMiddleware({ dispatch }) {\n    return next =\x3e action =\x3e {\n        if(!isFSA(action)) {\n            return isPromise(action) ? action.then(dispatch) : next(action);\n        }\n        \n        return isPromise(action.payload) \n            ? action.payload.then(\n                result =\x3e dispatch({ ...action, payload: result }),\n                error =\x3e {\n                    dispatch({ ...action, payload: error, error: true });\n                    return Promise.reject(error);\n                }\n              )\n            : next(action);\n    };\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { isFSA } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27flux-standard-action\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eisPromise\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e val \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e val.then === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e;\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epromiseMiddleware\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e{ dispatch }\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e =\x26gt;\x3c\/span\x3e action =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!isFSA(action)) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e isPromise(action) ? action.then(dispatch) : next(action);\n        }\n        \n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e isPromise(action.payload) \n            ? action.payload.then(\n                \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e dispatch({ ...action, \x3cspan class=\x22hljs-attr\x22\x3epayload\x3c\/span\x3e: result }),\n                error =\x26gt; {\n                    dispatch({ ...action, \x3cspan class=\x22hljs-attr\x22\x3epayload\x3c\/span\x3e: error, \x3cspan class=\x22hljs-attr\x22\x3eerror\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e });\n                    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(error);\n                }\n              )\n            : next(action);\n    };\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eredux-promise兼容了\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000010113847\x22\x3eFSA标准\x3c\/a\x3e，也就是说将返回的结果保存在payload中。实现过程非常容易理解，即判断action或action.payload是否为promise，如果是，就执行then，返回的结果再发送一次dispatch。\x3c\/p\x3e\n\x3cp\x3e我们利用ES7的async和await语法，可以简化上述获取天气的异步过程：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const fetchData = (url, params) =\x3e fetch(url, params);\n\nasync function getWeather(url, params) {\n    const result = await fetchData(url, params);\n    \n    if(result.error) {\n        return {\n            type: \x27GET_WEATHER_ERROR\x27,\n            error: result.error\n        };\n    }\n    \n    return {\n        type: \x27GET_WEATHER_SUCCESS\x27,\n        payload: result\n    };\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs qml\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fetchData = (\x3cspan class=\x22hljs-built_in\x22\x3eurl\x3c\/span\x3e, params) =\x26gt; fetch(\x3cspan class=\x22hljs-built_in\x22\x3eurl\x3c\/span\x3e, params);\n\n\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetWeather\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eurl, params\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e result = \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e fetchData(\x3cspan class=\x22hljs-built_in\x22\x3eurl\x3c\/span\x3e, params);\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(result.error) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-attribute\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET_WEATHER_ERROR\x27\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-attribute\x22\x3eerror\x3c\/span\x3e: result.error\n        };\n    }\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-attribute\x22\x3etype\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET_WEATHER_SUCCESS\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attribute\x22\x3epayload\x3c\/span\x3e: result\n    };\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1 id=\x22articleHeader3\x22\x3eredux-composable-fetch\x3c\/h1\x3e\n\x3cp\x3e在实际中，我们还需要加上loading状态。结合上述讨论的两个开源middleware，我们完全可以自己实现一个贴合工程需要的middleware，这里将其命名为redux-composable-fetch。\x3c\/p\x3e\n\x3cp\x3e在理想的情况下，我们不希望通过复杂的方法去请求数据，而希望通过如下形式一并完成在异步请求过程中的不同状态：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22{\n    url: \x27\/api\/weather.json\x27,\n    params: {\n        city: encodeURI(city)\n    },\n    types: [\x27GET_WEATHER\x27, \x27GET_WEATHER_SUCCESS\x27, \x27GET_WEATHER_ERROR\x27]\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs css\x22\x3e\x3ccode\x3e{\n    \x3cspan class=\x22hljs-attribute\x22\x3eurl\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/api\/weather.json\x27\x3c\/span\x3e,\n    params: {\n        city: \x3cspan class=\x22hljs-built_in\x22\x3eencodeURI\x3c\/span\x3e(city)\n    },\n    \x3cspan class=\x22hljs-selector-tag\x22\x3etypes\x3c\/span\x3e: \x3cspan class=\x22hljs-selector-attr\x22\x3e[\x27GET_WEATHER\x27, \x27GET_WEATHER_SUCCESS\x27, \x27GET_WEATHER_ERROR\x27]\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以看到，异步请求的action格式有别于FSA。它并没有使用type属性，而使用了types属性。types其实是三个普通action type的集合，分别代表请求中、请求成功和请求失败。\x3c\/p\x3e\n\x3cp\x3e在请求middleware中，会对action进行格式检查，若存在url和types属性，则说明这个action是一个用于发送异步请求的action。此外，并不是所有请求都能携带参数，因此params是可选的。\x3c\/p\x3e\n\x3cp\x3e当请求middleware识别到这是一个用于发送请求的action后，首先会分发一个新的action，这个action的type就是原action里types数组中的第一个元素，即请求中。分发这个新action的目的在于让store能够同步当前请求的状态，如将loading状态置为true，这样在对应的界面上可以展示一个友好的加载中动画。\x3c\/p\x3e\n\x3cp\x3e然后请求middleware会根据action中的url、params、method等参数发送一个异步请求，并在请求响应后根据结果的成功或失败分别分发请求成功和请求失败的新action。\x3c\/p\x3e\n\x3cp\x3e请求middleware的简化实现如下，我们可以根据具体的场景对此进行改造：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const fetchMiddleware = store =\x3e next =\x3e action =\x3e {\n    if(!action.url || !Array.isArray(action.types)) {\n        return next(action);\n    }\n    \n    const [LOADING, SUCCESS, ERROR] = action.types;\n    \n    next({\n        type: LOADING,\n        loading: true,\n        ...action\n    });\n    \n    fetch(action.url, { params: action.params })\n        .then(result =\x3e {\n            next({\n                type: SUCCESS,\n                loading: false,\n                payload: result\n            });\n        })\n        .catch(err =\x3e {\n            next({\n                type: ERROR,\n                loading: false,\n                error: err\n            });\n        });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs sqf\x22\x3e\x3ccode\x3econst fetchMiddleware = store =\x26gt; next =\x26gt; \x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!\x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e.url || !Array.\x3cspan class=\x22hljs-built_in\x22\x3eisArray\x3c\/span\x3e(\x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e.types)) {\n        return next(\x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e);\n    }\n    \n    const [LOADING, SUCCESS, ERROR] = \x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e.types;\n    \n    next({\n        \x3cspan class=\x22hljs-built_in\x22\x3etype\x3c\/span\x3e: LOADING,\n        loading: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n        ...\x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e\n    });\n    \n    fetch(\x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e.url, { \x3cspan class=\x22hljs-built_in\x22\x3eparams\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eaction\x3c\/span\x3e.\x3cspan class=\x22hljs-built_in\x22\x3eparams\x3c\/span\x3e })\n        .\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(result =\x26gt; {\n            next({\n                \x3cspan class=\x22hljs-built_in\x22\x3etype\x3c\/span\x3e: SUCCESS,\n                loading: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n                payload: result\n            });\n        })\n        .\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(err =\x26gt; {\n            next({\n                \x3cspan class=\x22hljs-built_in\x22\x3etype\x3c\/span\x3e: ERROR,\n                loading: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n                error: err\n            });\n        });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样我们一步就完成了异步请求的action。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader4\x22\x3eredux-observable\x3c\/h1\x3e\n\x3cp\x3e在Redux中，处理异步action的方法非常多，最标准的做法是使用redux-thunk中间件，经过thunk中间件的处理，一个action被dispatch后可以返回一个函数，这个函数可以用来做其他的事：发起异步请求和dispatch另外更多的action。使用redux-promise比redux-thunk更加易用，复杂度也不高，创建的异步action对象符合FSA标准。\x3c\/p\x3e\n\x3cp\x3e在Redux社区中，负有盛名的还有redux-sage、redux-observable等。\x3c\/p\x3e\n\x3cp\x3eredux-observable，是通过创建epics中间件，为每一个dispatch添加相应的附加效果。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>React系列&mdash;Redux异步流</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010112836">https://segmentfault.com/a/1190000010112836</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/vybp597kqhk/" target="_blank">https://alili.tech/archive/vybp597kqhk/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>