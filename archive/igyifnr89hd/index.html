<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="gdb 如何调用函数？"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>gdb 如何调用函数？ | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/igyifnr89hd/",
				"appid": "1613049289050283", 
				"title": "gdb 如何调用函数？ | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-19T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/85i52s10w5d/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/27ybxk2s5ip/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&text=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&text=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&title=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&is_video=false&description=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&title=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&title=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&title=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2figyifnr89hd%2f&title=gdb%20%e5%a6%82%e4%bd%95%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0%ef%bc%9f"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">gdb 如何调用函数？</h1><div class="meta"><div class="postdate"><time datetime="2019-01-19" itemprop="datePublished">2019-01-19</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#gdb-如何调用函数\x22\x3e\x3c\/a\x3egdb 如何调用函数？\x3c\/h1\x3e\n\x3cp\x3e（之前的 gdb 系列文章：\x3ca href=\x22https:\/\/linux.cn\/article-9491-1.html\x22\x3egdb 如何工作（2016）\x3c\/a\x3e 和\x3ca href=\x22https:\/\/linux.cn\/article-9276-1.html\x22\x3e三步上手 gdb（2014）\x3c\/a\x3e）\x3c\/p\x3e\n\x3cp\x3e在这周，我发现我可以从 gdb 上调用 C 函数。这看起来很酷，因为在过去我认为 gdb 最多只是一个只读调试工具。\x3c\/p\x3e\n\x3cp\x3e我对 gdb 能够调用函数感到很吃惊。正如往常所做的那样，我在 \x3ca href=\x22https:\/\/twitter.com\/b0rk\/status\/948060808243765248\x22\x3eTwitter\x3c\/a\x3e 上询问这是如何工作的。我得到了大量的有用答案。我最喜欢的答案是 \x3ca href=\x22https:\/\/github.com\/eklitzke\/ptrace-call-userspace\/blob\/master\/call_fprintf.c\x22\x3eEvan Klitzke 的示例 C 代码\x3c\/a\x3e，它展示了 gdb 如何调用函数。代码能够运行，这很令人激动！\x3c\/p\x3e\n\x3cp\x3e我（通过一些跟踪和实验）认为那个示例 C 代码和 gdb 实际上如何调用函数不同。因此，在这篇文章中，我将会阐述 gdb 是如何调用函数的，以及我是如何知道的。\x3c\/p\x3e\n\x3cp\x3e关于 gdb 如何调用函数，还有许多我不知道的事情，并且，在这儿我写的内容有可能是错误的。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#从-gdb-中调用-c-函数意味着什么\x22\x3e\x3c\/a\x3e从 gdb 中调用 C 函数意味着什么？\x3c\/h3\x3e\n\x3cp\x3e在开始讲解这是如何工作之前，我先快速的谈论一下我是如何发现这件令人惊讶的事情的。\x3c\/p\x3e\n\x3cp\x3e假如，你已经在运行一个 C 程序（目标程序）。你可以运行程序中的一个函数，只需要像下面这样做：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e暂停程序（因为它已经在运行中）\x3c\/li\x3e\n\x3cli\x3e找到你想调用的函数的地址（使用符号表）\x3c\/li\x3e\n\x3cli\x3e使程序（目标程序）跳转到那个地址\x3c\/li\x3e\n\x3cli\x3e当函数返回时，恢复之前的指令指针和寄存器\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e通过符号表来找到想要调用的函数的地址非常容易。下面是一段非常简单但能够工作的代码，我在 Linux 上使用这段代码作为例子来讲解如何找到地址。这段代码使用 \x3ca href=\x22https:\/\/cole14.github.io\/rust-elf\x22\x3eelf crate\x3c\/a\x3e。如果我想找到 PID 为 2345 的进程中的 \x3ccode\x3efoo\x3c\/code\x3e 函数的地址，那么我可以运行 \x3ccode\x3eelf_symbol_value(\x22\/proc\/2345\/exe\x22, \x22foo\x22)\x3c\/code\x3e。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs rust\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efn\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eelf_symbol_value\x3c\/span\x3e\x3c\/span\x3e(file_name: \x26amp;\x3cspan class=\x22hljs-built_in\x22\x3estr\x3c\/span\x3e, symbol_name: \x26amp;\x3cspan class=\x22hljs-built_in\x22\x3estr\x3c\/span\x3e) -\x26gt; \x3cspan class=\x22hljs-built_in\x22\x3eResult\x3c\/span\x3e\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3eu64\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eBox\x3c\/span\x3e\x26lt;std::error::Error\x26gt;\x26gt; {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 打开 ELF 文件 \x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e file = elf::File::open_path(file_name).ok().ok_or(\x3cspan class=\x22hljs-string\x22\x3e\x22parse error\x22\x3c\/span\x3e)?;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在所有的段 \x26amp; 符号中循环，直到找到正确的那个\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e sections = \x26amp;file.sections;\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e s \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e sections {\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e sym \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e file.get_symbols(\x26amp;s).ok().ok_or(\x3cspan class=\x22hljs-string\x22\x3e\x22parse error\x22\x3c\/span\x3e)? {\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e sym.name == symbol_name {\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3eOk\x3c\/span\x3e(sym.value);\n            }\n        }\n    }\n    \x3cspan class=\x22hljs-literal\x22\x3eNone\x3c\/span\x3e.ok_or(\x3cspan class=\x22hljs-string\x22\x3e\x22No symbol found\x22\x3c\/span\x3e)?\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这并不能够真的发挥作用，你还需要找到文件的内存映射，并将符号偏移量加到文件映射的起始位置。找到内存映射并不困难，它位于 \x3ccode\x3e\/proc\/PID\/maps\x3c\/code\x3e 中。\x3c\/p\x3e\n\x3cp\x3e总之，找到想要调用的函数地址对我来说很直接，但是其余部分（改变指令指针，恢复寄存器等）看起来就不这么明显了。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#你不能仅仅进行跳转\x22\x3e\x3c\/a\x3e你不能仅仅进行跳转\x3c\/h3\x3e\n\x3cp\x3e我已经说过，你不能够仅仅找到你想要运行的那个函数地址，然后跳转到那儿。我在 gdb 中尝试过那样做（\x3ccode\x3ejump foo\x3c\/code\x3e），然后程序出现了段错误。毫无意义。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#如何从-gdb-中调用-c-函数\x22\x3e\x3c\/a\x3e如何从 gdb 中调用 C 函数\x3c\/h3\x3e\n\x3cp\x3e首先，这是可能的。我写了一个非常简洁的 C 程序，它所做的事只有 \x3ccode\x3esleep\x3c\/code\x3e 1000 秒，把这个文件命名为 \x3ccode\x3etest.c\x3c\/code\x3e ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e#\x3cspan class=\x22hljs-meta-keyword\x22\x3einclude\x3c\/span\x3e \x3cspan class=\x22hljs-meta-string\x22\x3e\x26lt;unistd.h\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efoo\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e;\n}\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3emain\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    sleep(\x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e接下来，编译并运行它：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs shell\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e$\x3c\/span\x3e\x3cspan class=\x22bash\x22\x3e gcc -o \x3cspan class=\x22hljs-built_in\x22\x3etest\x3c\/span\x3e  test.c\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e$\x3c\/span\x3e\x3cspan class=\x22bash\x22\x3e .\/\x3cspan class=\x22hljs-built_in\x22\x3etest\x3c\/span\x3e\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e最后，我们使用 gdb 来跟踪 \x3ccode\x3etest\x3c\/code\x3e 这一程序：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs shell\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e$\x3c\/span\x3e\x3cspan class=\x22bash\x22\x3e sudo gdb -p $(pgrep -f \x3cspan class=\x22hljs-built_in\x22\x3etest\x3c\/span\x3e)\x3c\/span\x3e\n(gdb) p foo()\n\x3cspan class=\x22hljs-meta\x22\x3e$\x3c\/span\x3e\x3cspan class=\x22bash\x22\x3e1 = 3\x3c\/span\x3e\n(gdb) quit\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e我运行 \x3ccode\x3ep foo()\x3c\/code\x3e 然后它运行了这个函数！这非常有趣。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#这有什么用\x22\x3e\x3c\/a\x3e这有什么用？\x3c\/h3\x3e\n\x3cp\x3e下面是一些可能的用途：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e它使得你可以把 gdb 当成一个 C 应答式程序（REPL），这很有趣，我想对开发也会有用\x3c\/li\x3e\n\x3cli\x3e在 gdb 中进行调试的时候展示\/浏览复杂数据结构的功能函数（感谢 \x3ca href=\x22https:\/\/twitter.com\/invalidop\/status\/949161146526781440\x22\x3e@invalidop\x3c\/a\x3e）\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/baloo\/setns\/blob\/master\/setns.c\x22\x3e在进程运行时设置一个任意的名字空间\x3c\/a\x3e（我的同事 \x3ca href=\x22https:\/\/github.com\/nelhage\x22\x3enelhage\x3c\/a\x3e 对此非常惊讶）\x3c\/li\x3e\n\x3cli\x3e可能还有许多我所不知道的用途\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3\x3e\x3ca href=\x22#它是如何工作的\x22\x3e\x3c\/a\x3e它是如何工作的\x3c\/h3\x3e\n\x3cp\x3e当我在 Twitter 上询问从 gdb 中调用函数是如何工作的时，我得到了大量有用的回答。许多答案是“你从符号表中得到了函数的地址”，但这并不是完整的答案。\x3c\/p\x3e\n\x3cp\x3e有个人告诉了我两篇关于 gdb 如何工作的系列文章：\x3ca href=\x22https:\/\/www.cl.cam.ac.uk\/%7Esrk31\/blog\/2016\/02\/25\/#native-debugging-part-1\x22\x3e原生调试：第一部分\x3c\/a\x3e，\x3ca href=\x22https:\/\/www.cl.cam.ac.uk\/%7Esrk31\/blog\/2017\/01\/30\/#native-debugging-part-2\x22\x3e原生调试：第二部分\x3c\/a\x3e。第一部分讲述了 gdb 是如何调用函数的（指出了 gdb 实际上完成这件事并不简单，但是我将会尽力）。\x3c\/p\x3e\n\x3cp\x3e步骤列举如下：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e停止进程\x3c\/li\x3e\n\x3cli\x3e创建一个新的栈框（远离真实栈）\x3c\/li\x3e\n\x3cli\x3e保存所有寄存器\x3c\/li\x3e\n\x3cli\x3e设置你想要调用的函数的寄存器参数\x3c\/li\x3e\n\x3cli\x3e设置栈指针指向新的栈框stack frame\x3c\/li\x3e\n\x3cli\x3e在内存中某个位置放置一条陷阱指令\x3c\/li\x3e\n\x3cli\x3e为陷阱指令设置返回地址\x3c\/li\x3e\n\x3cli\x3e设置指令寄存器的值为你想要调用的函数地址\x3c\/li\x3e\n\x3cli\x3e再次运行进程！\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e（LCTT 译注：如果将这个调用的函数看成一个单独的线程，gdb 实际上所做的事情就是一个简单的线程上下文切换）\x3c\/p\x3e\n\x3cp\x3e我不知道 gdb 是如何完成这些所有事情的，但是今天晚上，我学到了这些所有事情中的其中几件。\x3c\/p\x3e\n\x3ch4\x3e\x3ca href=\x22#创建一个栈框\x22\x3e\x3c\/a\x3e创建一个栈框\x3c\/h4\x3e\n\x3cp\x3e如果你想要运行一个 C 函数，那么你需要一个栈来存储变量。你肯定不想继续使用当前的栈。准确来说，在 gdb 调用函数之前（通过设置函数指针并跳转），它需要设置栈指针到某个地方。\x3c\/p\x3e\n\x3cp\x3e这儿是 Twitter 上一些关于它如何工作的猜测：\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e我认为它在当前栈的栈顶上构造了一个新的栈框来进行调用！\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e以及\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3e你确定是这样吗？它应该是分配一个伪栈，然后临时将 sp （栈指针寄存器）的值改为那个栈的地址。你可以试一试，你可以在那儿设置一个断点，然后看一看栈指针寄存器的值，它是否和当前程序寄存器的值相近？\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e我通过 gdb 做了一个试验：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs stylus\x22\x3e(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e \x3cspan class=\x22hljs-variable\x22\x3e$rsp\x3c\/span\x3e\n$\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e = (void *) \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7ffea3d0bca8\n(gdb) break foo\nBreakpoint \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e at \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex40052a\n(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e foo()\nBreakpoint \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex000000000040052a \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e foo ()\n(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e \x3cspan class=\x22hljs-variable\x22\x3e$rsp\x3c\/span\x3e\n$\x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3e = (void *) \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7ffea3d0bc00\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这看起来符合“gdb 在当前栈的栈顶构造了一个新的栈框”这一理论。因为栈指针（\x3ccode\x3e$rsp\x3c\/code\x3e）从 \x3ccode\x3e0x7ffea3d0bca8\x3c\/code\x3e 变成了 \x3ccode\x3e0x7ffea3d0bc00\x3c\/code\x3e —— 栈指针从高地址往低地址长。所以 \x3ccode\x3e0x7ffea3d0bca8\x3c\/code\x3e 在 \x3ccode\x3e0x7ffea3d0bc00\x3c\/code\x3e 的后面。真是有趣！\x3c\/p\x3e\n\x3cp\x3e所以，看起来 gdb 只是在当前栈所在位置创建了一个新的栈框。这令我很惊讶！\x3c\/p\x3e\n\x3ch4\x3e\x3ca href=\x22#改变指令指针\x22\x3e\x3c\/a\x3e改变指令指针\x3c\/h4\x3e\n\x3cp\x3e让我们来看一看 gdb 是如何改变指令指针的！\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs stylus\x22\x3e(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e \x3cspan class=\x22hljs-variable\x22\x3e$rip\x3c\/span\x3e\n$\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e = (void (*)()) \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7fae7d29a2f0 \x26lt;__nanosleep_nocancel\x2b\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e\x26gt;\n(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3eb\x3c\/span\x3e foo\nBreakpoint \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e at \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex40052a\n(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e foo()\nBreakpoint \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex000000000040052a \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e foo ()\n(gdb) \x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e \x3cspan class=\x22hljs-variable\x22\x3e$rip\x3c\/span\x3e\n$\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e = (void (*)()) \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex40052a \x26lt;foo\x2b\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e\x26gt;\n\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e的确是！指令指针从 \x3ccode\x3e0x7fae7d29a2f0\x3c\/code\x3e 变为了 \x3ccode\x3e0x40052a\x3c\/code\x3e（\x3ccode\x3efoo\x3c\/code\x3e 函数的地址）。\x3c\/p\x3e\n\x3cp\x3e我盯着输出看了很久，但仍然不理解它是如何改变指令指针的，但这并不影响什么。\x3c\/p\x3e\n\x3ch4\x3e\x3ca href=\x22#如何设置断点\x22\x3e\x3c\/a\x3e如何设置断点\x3c\/h4\x3e\n\x3cp\x3e上面我写到 \x3ccode\x3ebreak foo\x3c\/code\x3e 。我跟踪 gdb 运行程序的过程，但是没有任何发现。\x3c\/p\x3e\n\x3cp\x3e下面是 gdb 用来设置断点的一些系统调用。它们非常简单。它把一条指令用 \x3ccode\x3ecc\x3c\/code\x3e 代替了（这告诉我们 \x3ccode\x3eint3\x3c\/code\x3e 意味着 \x3ccode\x3esend SIGTRAP\x3c\/code\x3e \x3ca href=\x22https:\/\/defuse.ca\/online-x86-assembler.htm\x22\x3ehttps:\/\/defuse.ca\/online-x86-assembler.html\x3c\/a\x3e），并且一旦程序被打断了，它就把指令恢复为原先的样子。\x3c\/p\x3e\n\x3cp\x3e我在函数 \x3ccode\x3efoo\x3c\/code\x3e 那儿设置了一个断点，地址为 \x3ccode\x3e0x400528\x3c\/code\x3e 。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3ePTRACE_POKEDATA\x3c\/code\x3e 展示了 gdb 如何改变正在运行的程序。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs lsl\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 改变 0x400528 处的指令\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_PEEKTEXT, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x400528\x3c\/span\x3e, [\x3cspan class=\x22hljs-number\x22\x3e0x5d00000003b8e589\x3c\/span\x3e]) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_POKEDATA, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x400528\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x5d00000003cce589\x3c\/span\x3e) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 开始运行程序\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_CONT, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x1\x3c\/span\x3e, SIG_0) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 当到达断点时获取一个信号\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_GETSIGINFO, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, NULL, {si_signo=SIGTRAP, si_code=SI_KERNEL, si_value={int=\x3cspan class=\x22hljs-number\x22\x3e-1447215360\x3c\/span\x3e, ptr=\x3cspan class=\x22hljs-number\x22\x3e0x7ffda9bd3f00\x3c\/span\x3e\x22}}\x22) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将 0x400528 处的指令更改为之前的样子\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_PEEKTEXT, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x400528\x3c\/span\x3e, [\x3cspan class=\x22hljs-number\x22\x3e0x5d00000003cce589\x3c\/span\x3e]) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e25622\x3c\/span\x3e ptrace(PTRACE_POKEDATA, \x3cspan class=\x22hljs-number\x22\x3e25618\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x400528\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0x5d00000003b8e589\x3c\/span\x3e) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3ch4\x3e\x3ca href=\x22#在某处放置一条陷阱指令\x22\x3e\x3c\/a\x3e在某处放置一条陷阱指令\x3c\/h4\x3e\n\x3cp\x3e当 gdb 运行一个函数的时候，它也会在某个地方放置一条陷阱指令。这是其中一条。它基本上是用 \x3ccode\x3ecc\x3c\/code\x3e 来替换一条指令（\x3ccode\x3eint3\x3c\/code\x3e）。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs basic\x22\x3e\x3cspan class=\x22hljs-symbol\x22\x3e5908 \x3c\/span\x3e ptrace(PTRACE_PEEKTEXT, \x3cspan class=\x22hljs-number\x22\x3e5810\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7f6fa7c0b260, [\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex48f389fd89485355]) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e5908 \x3c\/span\x3e ptrace(PTRACE_PEEKTEXT, \x3cspan class=\x22hljs-number\x22\x3e5810\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7f6fa7c0b260, [\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex48f389fd89485355]) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e5908 \x3c\/span\x3eptrace(PTRACE_POKEDATA, \x3cspan class=\x22hljs-number\x22\x3e5810\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex7f6fa7c0b260, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3ex48f389fd894853cc) = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3e0x7f6fa7c0b260\x3c\/code\x3e 是什么？我查看了进程的内存映射，发现它位于 \x3ccode\x3e\/lib\/x86_64-linux-gnu\/libc-2.23.so\x3c\/code\x3e 中的某个位置。这很奇怪，为什么 gdb 将陷阱指令放在 libc 中？\x3c\/p\x3e\n\x3cp\x3e让我们看一看里面的函数是什么，它是 \x3ccode\x3e__libc_siglongjmp\x3c\/code\x3e 。其他 gdb 放置陷阱指令的地方的函数是 \x3ccode\x3e__longjmp\x3c\/code\x3e 、\x3ccode\x3e___longjmp_chk\x3c\/code\x3e 、\x3ccode\x3edl_main\x3c\/code\x3e 和 \x3ccode\x3e_dl_close_worker\x3c\/code\x3e 。\x3c\/p\x3e\n\x3cp\x3e为什么？我不知道！也许出于某种原因，当函数 \x3ccode\x3efoo()\x3c\/code\x3e 返回时，它调用 \x3ccode\x3elongjmp\x3c\/code\x3e ，从而 gdb 能够进行返回控制。我不确定。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#gdb-如何调用函数是很复杂的\x22\x3e\x3c\/a\x3egdb 如何调用函数是很复杂的！\x3c\/h3\x3e\n\x3cp\x3e我将要在这儿停止了（现在已经凌晨 1 点），但是我知道的多一些了！\x3c\/p\x3e\n\x3cp\x3e看起来“gdb 如何调用函数”这一问题的答案并不简单。我发现这很有趣并且努力找出其中一些答案，希望你也能够找到。\x3c\/p\x3e\n\x3cp\x3e我依旧有很多未回答的问题，关于 gdb 是如何完成这些所有事的，但是可以了。我不需要真的知道关于 gdb 是如何工作的所有细节，但是我很开心，我有了一些进一步的理解。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22https:\/\/jvns.ca\/blog\/2018\/01\/04\/how-does-gdb-call-functions\/\x22\x3ehttps:\/\/jvns.ca\/blog\/2018\/01\/04\/how-does-gdb-call-functions\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22https:\/\/jvns.ca\/\x22\x3eJulia Evans\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/ucasFL\x22\x3eucasFL\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/wxy\x22\x3ewxy\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>gdb 如何调用函数？</p><h2 id="原文链接">原文链接</h2><p><a href="https://www.zcfy.cc/article/how-does-gdb-call-functions">https://www.zcfy.cc/article/how-does-gdb-call-functions</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/igyifnr89hd/" target="_blank">https://alili.tech/archive/igyifnr89hd/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>