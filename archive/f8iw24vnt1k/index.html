<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="【新手向】Node.js事件循环中的：Macrotask 与 Microtask"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>【新手向】Node.js事件循环中的：Macrotask 与 Microtask | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/f8iw24vnt1k/",
				"appid": "1613049289050283", 
				"title": "【新手向】Node.js事件循环中的：Macrotask 与 Microtask | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-30T02:30:23"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/am2vl03nt5/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/n0ipwrblbx/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&text=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&text=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&title=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&is_video=false&description=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&title=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&title=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&title=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2ff8iw24vnt1k%2f&title=%e3%80%90%e6%96%b0%e6%89%8b%e5%90%91%e3%80%91Node.js%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%e4%b8%ad%e7%9a%84%ef%bc%9aMacrotask%20%e4%b8%8e%20Microtask"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">【新手向】Node.js事件循环中的：Macrotask 与 Microtask</h1><div class="meta"><div class="postdate"><time datetime="2019-01-30" itemprop="datePublished">2019-01-30</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e在Node学习过程中，不可避免的需要对事件循环机制做深入理解，其中Macrotask（大型任务）和Microtask（小型任务）比较令人困惑，在一番google之后，我发现了几篇资料能比较好地解释他们的原理。因此在这里汇总\x2b搬运一下。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader0\x22\x3e一句话解释\x3c\/h3\x3e\n\x3cp\x3e在Nodejs事件循环机制中，有任务两个队列：Macrotask队列和Microtask队列。\x3cstrong\x3e在一个事件循环里，这两个队列会分两步执行，第一步会固定地执行一个（且仅一个）Macrotask任务，第二步会执行整个Microtask队列中的所有任务。\x3c\/strong\x3e并且，在执行Microtask队列任务的时候，也允许加入新的Microtask任务，直到所有Microtask任务全部执行完毕，才会结束循环。\x3c\/p\x3e\n\x3cp\x3eMacrotasks一般包括: \x3ccode\x3esetTimeout\x3c\/code\x3e, \x3ccode\x3esetInterval\x3c\/code\x3e, \x3ccode\x3esetImmediate\x3c\/code\x3e, I\/O, UI rendering；\x3cbr\x3eMicrotasks一般包括: \x3ccode\x3eprocess.nextTick\x3c\/code\x3e, \x3ccode\x3ePromises\x3c\/code\x3e, \x3ccode\x3eObject.observe\x3c\/code\x3e, \x3ccode\x3eMutationObserver\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e事件循环机制详解\x3c\/h3\x3e\n\x3cp\x3e从一个事件循环开始，到结束会经历以下步骤：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e检查Macrotask队列，选择其中最早加入（即最老的）的任务X，设置为“目前运行的任务”。如果任务X不存在，那么直接跳到步骤4。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e运行任务X，即运行对应的回调函数。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e设置“目前运行的任务”为null，从Macrotask队列中移除任务X。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e检查Microtask队列：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x221）选择其中最老的任务a，如果任务a不存在，直接结束Microtask队列。\n2）设置任务a为“目前运行的任务”，并执行。\n3）设置“目前运行的任务”为null，从Microtask队列中移除任务a。\n4）选择下一个最老的任务b，跳到步骤2）。\n5）直到队列里没有剩余的任务，结束队列。\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e）选择其中最老的任务a，如果任务a不存在，直接结束Microtask队列。\n\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e）设置任务a为“目前运行的任务”，并执行。\n\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e）设置“目前运行的任务”为null，从Microtask队列中移除任务a。\n\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e）选择下一个最老的任务b，跳到步骤\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e）。\n\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e）直到队列里没有剩余的任务，结束队列。\x3c\/code\x3e\x3c\/pre\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e跳回步骤1，检查下一个Macrotask任务。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e关于事件循环步骤，参考文档中的《理解 Node.js 事件循环》这篇文章讲的非常好也非常详细，强烈推荐想了解的同学一定要看。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e如何选用Macrotask或Microtask呢？\x3c\/h3\x3e\n\x3cp\x3e可以这样简单理解：\x3cstrong\x3e如果你想让一个任务立即执行，那么就把它设置为Microtask，除此之外都用Macrotask比较好。\x3c\/strong\x3e因为可以看出，虽然Node是异步非阻塞的，但在一个事件循环中，Microtask的执行方式基本上就是用同步的。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e可能存在的问题\x3c\/h3\x3e\n\x3cp\x3e相信读到这里你已经意识到，如果一个Microtask队列太长，或者执行过程中不断加入新的Microtask任务，会导致下一个Macrotask任务很久都执行不了。结果就是，你可能会遇到UI一直刷新不了，或者I\/O任务一直完成不了。\x3c\/p\x3e\n\x3cp\x3e应该是考虑到了这一点，至少Microtask任务中的\x3ccode\x3eprocess.nextTick\x3c\/code\x3e任务，是被设置了（在一个事件循环中的）最大调用次数的，叫\x3ccode\x3eprocess.maxTickDepth\x3c\/code\x3e。默认是1000。一定程度上避免了上述情况。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e参考材料\x3c\/h3\x3e\n\x3cp\x3e\x3ca href=\x22http:\/\/www.zcfy.cc\/article\/node-js-at-scale-understanding-the-node-js-event-loop-risingstack-1652.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e理解 Node.js 事件循环\x3c\/a\x3e\x3cbr\x3e\x3ca href=\x22http:\/\/stackoverflow.com\/questions\/25915634\/difference-between-microtask-and-macrotask-within-an-event-loop-context\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eDifference between microtask and macrotask within an event loop context\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>【新手向】Node.js事件循环中的：Macrotask 与 Microtask</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000007710772">https://segmentfault.com/a/1190000007710772</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/f8iw24vnt1k/" target="_blank">https://alili.tech/archive/f8iw24vnt1k/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>