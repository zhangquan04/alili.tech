<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Node.js &#43; React Native 毕设：农业物联网监测系统的开发手记"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Node.js &#43; React Native 毕设：农业物联网监测系统的开发手记 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/7njdijhy2um/",
				"appid": "1613049289050283", 
				"title": "Node.js &#43; React Native 毕设：农业物联网监测系统的开发手记 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-02T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/f8zzbybr4tl/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/rnj4z8l02t/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&text=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&text=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&title=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&is_video=false&description=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&title=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&title=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&title=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7njdijhy2um%2f&title=Node.js%20%2b%20React%20Native%20%e6%af%95%e8%ae%be%ef%bc%9a%e5%86%9c%e4%b8%9a%e7%89%a9%e8%81%94%e7%bd%91%e7%9b%91%e6%b5%8b%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%80%e5%8f%91%e6%89%8b%e8%ae%b0"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Node.js &#43; React Native 毕设：农业物联网监测系统的开发手记</h1><div class="meta"><div class="postdate"><time datetime="2019-02-02" itemprop="datePublished">2019-02-02</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e毕设大概是大学四年里最坑爹之一的事情了，毕竟一旦选题不好，就很容易浪费一年的时间做一个并没有什么卵用，又不能学到什么东西的鸡肋项目。所幸，鄙人所在的硬件专业，指导老师并不懂软件，他只是想要一个农业物联网的监测系统，能提供给我的就是一个Oracle 11d数据库，带着一个物联网系统运行一年所保存的传感器数据...That\x27s all。然后，因为他不懂软件，所以他显然以结果为导向，只要我交出一个移动客户端和一个服务端，并不会关心我在其中用了多少坑爹的新技术。\x3c\/p\x3e\n\x3cp\x3e那还说什么？上！我以强烈的恶搞精神，决定采用业界最新最坑爹最有可能烂尾的技术，组成一个 Geek 大杂烩，幻想未来那个接手我工作的师兄的一脸懵逼，我露出了邪恶的笑容，一切只为了满足自己的上新欲。\x3c\/p\x3e\n\x3cp\x3e全部代码在 GPL 许可证下开源：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e服务端代码：\x3ca href=\x22https:\/\/github.com\/CauT\/the-wall\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/CauT\/the-wall\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e客户端代码：\x3ca href=\x22https:\/\/github.com\/CauT\/NightWatch\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/CauT\/Night...\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e由于数据库是学校实验室所有，所以不能放出数据以供运行，万分抱歉~。理论上应该有一份文档，但事实上太懒，不知道什么时候会填坑~。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e总体架构\x3c\/h2\x3e\n\x3cp\x3eOK，上图说明技术框架。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083094?w=1062\x26amp;h=924\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083094?w=1062\x26amp;h=924\x22 alt=\x22总体结构\x22 title=\x22总体结构\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e￼\x3cbr\x3e该物联网监测系统整体上可分为三层：数据库层，服务器层和客户端层。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e数据库和代码层\x3c\/h3\x3e\n\x3cp\x3e数据库层除了原有的Oracle 11d数据库以外，还额外增加了一个Redis数据库。之所以增加第二个数据库，原因为：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eNode.js 的 Oracle 官方依赖 node-oracledb 没有ORM，也就是说，所有的对数据库的操作，都是直接执行SQL语句，简单粗暴，我担心自己孱弱的数据库功底（本行是 Android 开发）会引发锁表问题，所以通过限制只读来避开这个问题。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e由于该系统服务于农业企业的内部管理人员，因此其账号数量和总体数据量必然有限，因此使用 redis 这种内存型数据库，可以不必考虑非关系型数据库在容量占用上的劣势。读取速度反而较传统的 SQL 数据库有一定的优势。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e使用非关系型数据库比关系型数据库好玩多了（雾\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e之所以写了右边的Git部分，是因为原本打算利用docker技术搞一个持续集成和部署的程序，实现提交代码=\x26gt;自动测试=\x26gt;更新服务器部署更新=\x26gt;客户端自动更新 这样一整套持续交付的流程，然而最后并没有时间写。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e服务器层\x3c\/h3\x3e\n\x3cp\x3e服务器层，采用 Node.js 的 Express 框架作为客户端的 API 后台。因为 Node.js 的单线程异步并发结构使之可以轻松实现较高的 QPS，所以非常适合 API 后端这一特点。其框架设计和主要功能如下图所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083095?w=1014\x26amp;h=730\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083095?w=1014\x26amp;h=730\x22 alt=\x22服务端结构\x22 title=\x22服务端结构\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e像网关层：鉴权模块这么装逼的说法，本质也就是\x3ccode\x3eapp.use(jwt({secret: config.jwt_secret}).unless({path: [\x27\/signin\x27]}));\x3c\/code\x3e一行而已。因为是直接从毕业论文里拿下来的图，毕业论文都这尿性你们懂的，所以一些故弄玄虚敬请谅解。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e客户端层\x3c\/h3\x3e\n\x3cp\x3e￼客户端层绝大部分是 React Native 代码，但是监控数据的图表生成这一块功能（如下图），由于 React Native 目前没有开源的成熟实现；试图通过 Native 代码来画图表，需要实现一个 Native 和 React Native 互相嵌套的架构，又面临一些可能的困难；故而最终选择了内嵌一个 html 页面，前端代码采用百度的 Echarts 框架来绘制图表。最终的结构就是大部分 React Native \x2b 少部分 Html5 的客户端结构。\x3c\/p\x3e\n\x3cp\x3e另外就是采用了 Redux 来统一应用的事件分发和 UI 数据管理了。可以说，React Native 若能留名青史，Redux 必定是不可或缺的一大原因。这一点我们后文再述。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e细节详述\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e服务端层\x3c\/h3\x3e\n\x3cp\x3e服务端接口表：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083096?w=938\x26amp;h=1398\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083096?w=938\x26amp;h=1398\x22 alt=\x22服务端接口表\x22 title=\x22服务端接口表\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e服务端程序的编写过程中，往往涉及到了大量的异步操作，如数据库读取，网络请求，JSON解析等等。而这些异步操作，又往往会因为具体的业务场景的要求，而需要保持一定的执行顺序。此外，还需要保证代码的可读性，显然此时一味嵌套回调函数，只会使我们陷入代码几乎不可读的回调地狱（Callback Hell）中。最后，由于JavaScript单线程的执行环境的特性，我们还需要避免指定不必要的执行顺序，以免降低了程序的运行性能。因此，我在项目中使用Promise模式来处理多异步的逻辑过程。如下代码所示：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function renderGraph(req, res, filtereds) {\n  var x = [];    \n  var ys = [];\n  var titles = [];\n\n  filtereds[0].forEach(function(row) {\n    x.push(getLocalTime(row.RECTIME));\n  });\n\n  filtereds.forEach(function(filtered){\n    if (filtered[0] == undefined)\n      \/\/ even if at least one of multi query was succeed\n      \/\/ fast-fail is essential for secure\n      throw new Error(\x27数据库返回结果为空\x27);\n    var y = [];\n    filtered.forEach(function(row) {\n      y.push(row.ANALOGYVALUE);\n    });\n    ys.push(y);\n    titles.push(filtered[0].DEVICENAME \x2b \x27: \x27 \x2b filtered[0].DEVICECODE);\n  });\n\n  res.render(\x27graph\x27, {\n    titles: titles,\n    dataX: x,\n    dataY: ys,\n    height: req.query.height == undefined ? 200 : req.query.height,\n    width: req.query.width == undefined ? 300 : req.query.width,\n  });\n}\n\nfunction resFilter(resolve, reject, connection, resultSet, numRows, filtered) {\n  resultSet.getRows(\n    numRows,\n    function (err, rows)\n    {\n      if (err) {\n        console.log(err.message);\n        reject(err);\n      } else if (rows.length == 0) {\n        resolve(filtered);\n        process.nextTick(function() {\n          oracle.releaseConnection(connection);\n        });\n      } else if (rows.length \x3e 0) {\n        filtered.push(rows[0]);\n        resFilter(resolve, reject, connection, resultSet, numRows, filtered);\n      }\n    }\n  );\n}\n\nfunction createQuerySingleDeviceDataPromise(req, res, device_id, start_time, end_time) {\n  return oracle.getConnection()\n  .then(function(connection) {\n    return oracle.execute(\n      \x26quot;SELECT\\\n        DEVICE.DEVICEID,\\\n        DEVICECODE,\\\n        DEVICENAME,\\\n        UNIT,\\\n        ANALOGYVALUE,\\\n        DEVICEHISTROY.RECTIME\\\n      FROM\\\n        DEVICE INNER JOIN DEVICEHISTROY\\\n      ON\\\n        DEVICE.DEVICEID = DEVICEHISTROY.DEVICEID\\\n      WHERE\\\n        DEVICE.DEVICEID = :device_id\\\n        AND DEVICEHISTROY.RECTIME\\\n        BETWEEN :start_time AND :end_time\\\n      ORDER\\\n        BY RECTIME\x26quot;,\n      [\n        device_id,\n        start_time,\n        end_time\n      ],\n      {\n        outFormat: oracle.OBJECT,\n        resultSet: true\n      },\n      connection\n    )\n    .then(function(results) {\n      var filtered = [];\n      var filterGap = Math.floor(\n        (end_time - start_time) \/ (120 * 100)\n      );\n      return new Promise(function(resolve, reject) {\n        resFilter(resolve, reject,\n          connection, results.resultSet, filterGap, filtered);\n      });\n    })\n    .catch(function(err) {\n      res.status(500).json({\n        status: \x27error\x27,\n        message: err.message\n      });\n      process.nextTick(function() {\n        oracle.releaseConnection(connection);\n      });\n    });\n  });\n}\n\nfunction secureCheck(req, res) {\n  let qry = req.query;\n\n  if (\n    qry.device_ids == undefined\n    || qry.start_time == undefined\n    || qry.end_time == undefined\n  ) {\n    throw new Error(\x27device_ids或start_time或end_time参数为undefined\x27);\n  }\n\n  if (req.query.end_time \x3c req.query.start_time) {\n    throw new Error(\x27终止时间小于起始时间\x27);\n  }\n};\n\nrouter.get(\x27\/\x27, function(req, res, next) {\n  try {\n    var device_ids;\n    var queryPromises = [];\n\n    secureCheck(req, res);\n\n    device_ids = req.query.device_ids.toString().split(\x27;\x27);\n\n    for(let i=0; i\x3cdevice_ids.length; i\x2b\x2b) {\n      queryPromises.push(createQuerySingleDeviceDataPromise(\n        req, res, device_ids[i], req.query.start_time, req.query.end_time));\n    };\n\n    Promise.all(queryPromises)\n    .then(function(filtereds) {\n      renderGraph(req, res, filtereds);\n    }).catch(function(err) {\n      res.status(500).json({\n        status: \x27error\x27,\n        message: err.message\n      });\n    })\n  } catch(err) {\n    res.status(500).json({\n      status: \x27error\x27,\n      message: err.message\n    });\n  }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3erenderGraph\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res, filtereds\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e x = [];    \n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e ys = [];\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e titles = [];\n\n  filtereds[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3erow\x3c\/span\x3e) \x3c\/span\x3e{\n    x.push(getLocalTime(row.RECTIME));\n  });\n\n  filtereds.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efiltered\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (filtered[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e] == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e)\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ even if at least one of multi query was succeed\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fast-fail is essential for secure\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27数据库返回结果为空\x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e y = [];\n    filtered.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3erow\x3c\/span\x3e) \x3c\/span\x3e{\n      y.push(row.ANALOGYVALUE);\n    });\n    ys.push(y);\n    titles.push(filtered[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].DEVICENAME \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27: \x27\x3c\/span\x3e \x2b filtered[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].DEVICECODE);\n  });\n\n  res.render(\x3cspan class=\x22hljs-string\x22\x3e\x27graph\x27\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3etitles\x3c\/span\x3e: titles,\n    \x3cspan class=\x22hljs-attr\x22\x3edataX\x3c\/span\x3e: x,\n    \x3cspan class=\x22hljs-attr\x22\x3edataY\x3c\/span\x3e: ys,\n    \x3cspan class=\x22hljs-attr\x22\x3eheight\x3c\/span\x3e: req.query.height == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e : req.query.height,\n    \x3cspan class=\x22hljs-attr\x22\x3ewidth\x3c\/span\x3e: req.query.width == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e300\x3c\/span\x3e : req.query.width,\n  });\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresFilter\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject, connection, resultSet, numRows, filtered\x3c\/span\x3e) \x3c\/span\x3e{\n  resultSet.getRows(\n    numRows,\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr, rows\x3c\/span\x3e)\n    \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err.message);\n        reject(err);\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (rows.length == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n        resolve(filtered);\n        process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          oracle.releaseConnection(connection);\n        });\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (rows.length \x26gt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n        filtered.push(rows[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e]);\n        resFilter(resolve, reject, connection, resultSet, numRows, filtered);\n      }\n    }\n  );\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateQuerySingleDeviceDataPromise\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res, device_id, start_time, end_time\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e oracle.getConnection()\n  .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3econnection\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e oracle.execute(\n      \x3cspan class=\x22hljs-string\x22\x3e\x22SELECT\\\n        DEVICE.DEVICEID,\\\n        DEVICECODE,\\\n        DEVICENAME,\\\n        UNIT,\\\n        ANALOGYVALUE,\\\n        DEVICEHISTROY.RECTIME\\\n      FROM\\\n        DEVICE INNER JOIN DEVICEHISTROY\\\n      ON\\\n        DEVICE.DEVICEID = DEVICEHISTROY.DEVICEID\\\n      WHERE\\\n        DEVICE.DEVICEID = :device_id\\\n        AND DEVICEHISTROY.RECTIME\\\n        BETWEEN :start_time AND :end_time\\\n      ORDER\\\n        BY RECTIME\x22\x3c\/span\x3e,\n      [\n        device_id,\n        start_time,\n        end_time\n      ],\n      {\n        \x3cspan class=\x22hljs-attr\x22\x3eoutFormat\x3c\/span\x3e: oracle.OBJECT,\n        \x3cspan class=\x22hljs-attr\x22\x3eresultSet\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n      },\n      connection\n    )\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresults\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e filtered = [];\n      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e filterGap = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.floor(\n        (end_time - start_time) \/ (\x3cspan class=\x22hljs-number\x22\x3e120\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e)\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) \x3c\/span\x3e{\n        resFilter(resolve, reject,\n          connection, results.resultSet, filterGap, filtered);\n      });\n    })\n    .catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e) \x3c\/span\x3e{\n      res.status(\x3cspan class=\x22hljs-number\x22\x3e500\x3c\/span\x3e).json({\n        \x3cspan class=\x22hljs-attr\x22\x3estatus\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: err.message\n      });\n      process.nextTick(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        oracle.releaseConnection(connection);\n      });\n    });\n  });\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esecureCheck\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e qry = req.query;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\n    qry.device_ids == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e\n    || qry.start_time == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e\n    || qry.end_time == \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e\n  ) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27device_ids或start_time或end_time参数为undefined\x27\x3c\/span\x3e);\n  }\n\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (req.query.end_time \x26lt; req.query.start_time) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27终止时间小于起始时间\x27\x3c\/span\x3e);\n  }\n};\n\nrouter.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res, next\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e device_ids;\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e queryPromises = [];\n\n    secureCheck(req, res);\n\n    device_ids = req.query.device_ids.toString().split(\x3cspan class=\x22hljs-string\x22\x3e\x27;\x27\x3c\/span\x3e);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i=\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i\x26lt;device_ids.length; i\x2b\x2b) {\n      queryPromises.push(createQuerySingleDeviceDataPromise(\n        req, res, device_ids[i], req.query.start_time, req.query.end_time));\n    };\n\n    \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.all(queryPromises)\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efiltereds\x3c\/span\x3e) \x3c\/span\x3e{\n      renderGraph(req, res, filtereds);\n    }).catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e) \x3c\/span\x3e{\n      res.status(\x3cspan class=\x22hljs-number\x22\x3e500\x3c\/span\x3e).json({\n        \x3cspan class=\x22hljs-attr\x22\x3estatus\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: err.message\n      });\n    })\n  } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(err) {\n    res.status(\x3cspan class=\x22hljs-number\x22\x3e500\x3c\/span\x3e).json({\n      \x3cspan class=\x22hljs-attr\x22\x3estatus\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27error\x27\x3c\/span\x3e,\n      \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: err.message\n    });\n  }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这是生成指定N个传感器在一段时间内的折线图的逻辑。显然，剖析业务可知，我们需要在数据库中查询N次传感器，获得N个值对象数组，然后才能去用N组数据渲染出图表的HTML页面。 可以看到，外部核心的Promise控制的流程只集中于下面的几行之中：\x3ccode\x3ePromise.all(queryPromises()).then(renderGraph()).catch()\x3c\/code\x3e。即，只有获取完N个传感器的数值之后，才会去渲染图表的HTML页面，但是这N个传感器的获取过程却又是并发进行的，由Promise.all()来实现的，合理地利用了有限的机器性能资源。\x3c\/p\x3e\n\x3cp\x3e然而，推入queryPromises数组中的每个Promise对象，又构成了自己的一条Promise逻辑链，只有这些子Promise逻辑链被处理完了，才可以说整个all()函数都被执行完了。子Promise逻辑链大致地可以总结为以下形式：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function() {    \n    return new Promise().then().catch();\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{    \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e().then().catch();\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中的难点在于：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e合理地切分整套业务逻辑到不同的then()函数中，且一个then()中只能有一个异步过程。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e函数体内的异步过程所产生的新的Promise逻辑链必须被通过return的方式挂载到父函数的Promise逻辑链中，否则即可能形成一个有先有后的控制流程。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ecatch()函数必须要做好捕捉和输出错误的处理，否则代码编写过程中的错误即不可能被发现，异步编程的整个过程也就无从继续下去了。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e值得一提的是Promise模式的引入。Node.js 自身不带有Promise，可以引入标准的ECMAScript的Promise实现，然而其功能较为简陋，对于各种API的实现过于匮乏，因此最后选择了bluebird库来引入Promise模式的语言支持。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e由此我们可以看到，没有无缘无故的高性能。Node.js 的高并发的优良表现，是用异步编程的高复杂度换来的。当然，你也可以选择不要编程复杂度，即不采用 Promise，Asnyc 等等异步编程模式，任由代码沦入回调地狱之中，那么这时候的代价就是维护复杂度了。其中取舍，见仁见智。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e客户端层\x3c\/h3\x3e\n\x3cp\x3e客户端主要功能如下表所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083097?w=1144\x26amp;h=1404\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083097?w=1144\x26amp;h=1404\x22 alt=\x22功能设计表\x22 title=\x22功能设计表\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e接下来简单介绍下几个主要页面。可以发现 iOS 明显比 Android 要来的漂亮，因为只对 iOS 做了视觉上的细调，直接迁移到 Android 上，就会由于屏幕显示的色差问题，显得非常粗糙。所以，对于跨平台的 React Native App 来说，做两套色值配置文件，以供两个平台使用，还是很有必要的。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083098?w=854\x26amp;h=774\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083098?w=854\x26amp;h=774\x22 alt=\x22当前数据界面\x22 title=\x22当前数据界面\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e上图即是土壤墒情底栏的当前数据页面，分别在Android和iOS上的显示效果，默认展示所有当前的传感器的数值，可以通过选择传感器种类或监测站编号进行筛选，两个条件可以分别设置，选定后再点击查找，即向服务器发起请求，得到数据后刷新页面。由于React Native 的组件化设计，刷新将只刷新下侧的DashBoard部分，且，若有上次已经渲染过的MonitorView，则会复用他们，不再重复渲染，从而实现了降低CPU占用的性能优化。MonitorView，即每一个传感器的展示小方块，自上至下依次展示了传感器种类，传感器编号，当前的传感器数值以及该传感器显示数值的单位。MonitorView和Dashboard均被抽象为一个一般化，可复用的组件，使之能够被利用在气象信息、病虫害监测之中，提升了开发效率，降低了代码的重复率。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083099?w=904\x26amp;h=816\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083099?w=904\x26amp;h=816\x22 alt=\x22查询历史界面\x22 title=\x22查询历史界面\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e上图是土壤墒情界面的历史数据界面，分别在Android和iOS上的展示效果，默认不会显示数据，直到输入了传感器种类和监测站编号，选择了年月日时间后，再点击查找，才会得到结果并显示出来。该界面并非如同当前数据界面一样，Android和iOS代码完全共用。原因在于选择月日和选择时间的控件，Android和iOS系统有各自的控件，它们也被封装为React Native中不同的控件，因此，两条绿色的选择时间的按钮，被封装为HistoricalDateSelectPad，分别放在componentIOS和componentAndroid文件夹中。界面下侧的数据监测板，即代码中的Dashboard，是复用当前数据中的Dashboard。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083100?w=922\x26amp;h=840\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083100?w=922\x26amp;h=840\x22 alt=\x22图表界面\x22 title=\x22图表界面\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e上图是土壤墒情界面的图表生成界面，分别在Android和iOS上的展示效果。时间选择界面，查找按钮，选择框，均可复用前两个界面的代码，因此无需多提。值得说的是，生成的折线图，事实上是通过内嵌的WebView来显示一个网页的。图表网页的生成，则依靠的百度Echarts 第三方库，然后服务端提供了一个预先写好的前端模板，Express框架填入需要的数据，最后下发到移动客户端上，渲染生成图表。图表支持了多曲线的删减，手指选取查看具体数据点，放大缩小等功能。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007083101?w=442\x26amp;h=730\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007083101?w=442\x26amp;h=730\x22 alt=\x22Screen Shot 2016-10-06 at 8.54.14 P\x22 title=\x22Screen Shot 2016-10-06 at 8.54.14 P\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3cp\x3e上图则是实际项目应用中的Redux相关文件的结构。stores中存放全局数据store相关的实现。\x3c\/p\x3e\n\x3cp\x3eactions中则存放根据模块切割开的各类action生成函数集合。在 Redux 中，改变 State 只能通过 action。并且，每一个 action 都必须是 Javascript Plain Object。事实上，创建 action 对象很少用这种每次直接声明对象的方式，更多地是通过一个创建函数。这个函数被称为Action Creator。\x3c\/p\x3e\n\x3cp\x3ereducers中存放许多reducer的实现，其中RootReducer是根文件，它负责把其他reducer拼接为一整个reducer，而reducer就是根据 action 的语义来完成 State 变更的函数。Reducer 的执行是同步的。在给定 initState 以及一系列的 actions，无论在什么时间，重复执行多少次 Reducer，都应该得到相同的 newState。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e性能测试\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e服务端\x3c\/h3\x3e\n\x3cp\x3e测试工具：OS X Activity Monitor（http_load）\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007082972?w=936\x26amp;h=202\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007082972?w=936\x26amp;h=202\x22 alt=\x22serve\x22 title=\x22serve\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e客户端\x3c\/h3\x3e\n\x3ch5\x3eiOS\x3c\/h5\x3e\n\x3cp\x3e测试工具：Xcode 7.3\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007082973?w=936\x26amp;h=206\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007082973?w=936\x26amp;h=206\x22 alt=\x22iOS\x22 title=\x22iOS\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3ch5\x3eAndroid\x3c\/h5\x3e\n\x3cp\x3e测试工具：Android Studio 1.2.0\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007082974?w=936\x26amp;h=206\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007082974?w=936\x26amp;h=206\x22 alt=\x22Android\x22 title=\x22Android\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e代码量相关\x3c\/h3\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000007082975?w=936\x26amp;h=304\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000007082975?w=936\x26amp;h=304\x22 alt=\x22code\x22 title=\x22code\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e￼\x3c\/p\x3e\n\x3ch4\x3e简单总结\x3c\/h4\x3e\n\x3cp\x3eReact Native 尽管在开发上具有这样那样的坑，但是因其天生的跨平台，和优于 Html5的移动性能表现，使得他在写一些不太复杂的 App 的时候，开发速度非常快，自带两倍 buff。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Node.js + React Native 毕设：农业物联网监测系统的开发手记</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000007082825">https://segmentfault.com/a/1190000007082825</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/7njdijhy2um/" target="_blank">https://alili.tech/archive/7njdijhy2um/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>