<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="cors跨域之简单请求与预检请求（发送请求头带令牌token）"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>cors跨域之简单请求与预检请求（发送请求头带令牌token） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/a8gzczukyqo/",
				"appid": "1613049289050283", 
				"title": "cors跨域之简单请求与预检请求（发送请求头带令牌token） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-10T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/smx2p0i8ycm/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/3nc5lecdaly/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&text=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&text=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&title=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&is_video=false&description=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&title=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&title=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&title=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa8gzczukyqo%2f&title=cors%e8%b7%a8%e5%9f%9f%e4%b9%8b%e7%ae%80%e5%8d%95%e8%af%b7%e6%b1%82%e4%b8%8e%e9%a2%84%e6%a3%80%e8%af%b7%e6%b1%82%ef%bc%88%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82%e5%a4%b4%e5%b8%a6%e4%bb%a4%e7%89%8ctoken%ef%bc%89"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">cors跨域之简单请求与预检请求（发送请求头带令牌token）</h1><div class="meta"><div class="postdate"><time datetime="2019-01-10" itemprop="datePublished">2019-01-10</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch3 id=\x22articleHeader0\x22\x3e引子\x3c\/h3\x3e\n\x3cp\x3e自从从JAVA伪全栈转前端以来，学习的路上就充满了荆棘（奇葩问题），而涉及前后端分离这个问题，对cors的应用不断增多，暴露出的问题也接踵而至。\x3cbr\x3e这两天动手实践基于Token的WEB后台认证机制，看过诸多理论（\x3ca href=\x22http:\/\/www.cnblogs.com\/xiekeli\/p\/5607107.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e较好一篇\x3c\/a\x3e推荐），正所谓虑一千次，不如去做一次。 犹豫一万次，不如实践一次，所以就有了下文，关于token的生成，另外一篇文章会细讲，本篇主要讨论在发送ajax请求，头部带上自定义token验证验证，暴露出的跨域问题。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e先说说定义\x3c\/h3\x3e\n\x3cp\x3eCORS：跨来源资源共享（CORS）是一份浏览器技术的规范，提供了 Web 服务从不同网域传来沙盒脚本的方法，以避开浏览器的同源策略，是 JSONP 模式的现代版。与 JSONP 不同，CORS 除了 GET 要求方法以外也支持其他的 HTTP 要求。用 CORS 可以让网页设计师用一般的 XMLHttpRequest，这种方式的错误处理比JSONP要来的好，JSONP对于 RESTful 的 API 来说，发送 POST\/PUT\/DELET 请求将成为问题，不利于接口的统一。但另一方面，JSONP 可以在不支持 CORS 的老旧浏览器上运作。不过现代的浏览器（IE10以上）基本都支持 CORS。\x3cbr\x3e预检请求（option）:在 CORS 中，可以使用 OPTIONS 方法发起一个预检请求(一般都是浏览检测到请求跨域时，会自动发起)，以检测实际请求是否可以被服务器所接受。预检请求报文中的 Access-Control-Request-Method 首部字段告知服务器实际请求所使用的 HTTP 方法；Access-Control-Request-Headers 首部字段告知服务器实际请求所携带的自定义首部字段。服务器基于从预检请求获得的信息来判断，是否接受接下来的实际请求。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22OPTIONS \/resources\/post-here\/ HTTP\/1.1 \nHost: bar.other \nAccept: text\/html,application\/xhtml\x2bxml,application\/xml;q=0.9,*\/*;q=0.8 \nAccept-Language: en-us,en;q=0.5 \nAccept-Encoding: gzip,deflate \nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7 \nConnection: keep-alive \nOrigin: http:\/\/foo.example \nAccess-Control-Request-Method: POST \nAccess-Control-Request-Headers: X-PINGOTHER, Content-Type\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs groovy\x22\x3e\x3ccode\x3eOPTIONS \x3cspan class=\x22hljs-regexp\x22\x3e\/resources\/\x3c\/span\x3epost-here\x3cspan class=\x22hljs-regexp\x22\x3e\/ HTTP\/\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e1.1\x3c\/span\x3e \n\x3cspan class=\x22hljs-string\x22\x3eHost:\x3c\/span\x3e bar.other \n\x3cspan class=\x22hljs-string\x22\x3eAccept:\x3c\/span\x3e text\x3cspan class=\x22hljs-regexp\x22\x3e\/html,application\/\x3c\/span\x3exhtml\x2bxml,application\x3cspan class=\x22hljs-regexp\x22\x3e\/xml;q=0.9,*\/\x3c\/span\x3e*;q=\x3cspan class=\x22hljs-number\x22\x3e0.8\x3c\/span\x3e \nAccept-\x3cspan class=\x22hljs-string\x22\x3eLanguage:\x3c\/span\x3e en-us,en;q=\x3cspan class=\x22hljs-number\x22\x3e0.5\x3c\/span\x3e \nAccept-\x3cspan class=\x22hljs-string\x22\x3eEncoding:\x3c\/span\x3e gzip,deflate \nAccept-\x3cspan class=\x22hljs-string\x22\x3eCharset:\x3c\/span\x3e ISO\x3cspan class=\x22hljs-number\x22\x3e-8859\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e,utf\x3cspan class=\x22hljs-number\x22\x3e-8\x3c\/span\x3e;q=\x3cspan class=\x22hljs-number\x22\x3e0.7\x3c\/span\x3e,*;q=\x3cspan class=\x22hljs-number\x22\x3e0.7\x3c\/span\x3e \n\x3cspan class=\x22hljs-string\x22\x3eConnection:\x3c\/span\x3e keep-alive \n\x3cspan class=\x22hljs-string\x22\x3eOrigin:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3ehttp:\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/foo.example \x3c\/span\x3e\nAccess-Control-Request-\x3cspan class=\x22hljs-string\x22\x3eMethod:\x3c\/span\x3e POST \nAccess-Control-Request-\x3cspan class=\x22hljs-string\x22\x3eHeaders:\x3c\/span\x3e X-PINGOTHER, Content-Type\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e服务器所返回的 Access-Control-Allow-Methods 首部字段将所有允许的请求方法告知客户端。该首部字段与 Allow 类似，但只能用于涉及到 CORS 的场景中。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e问题描述\x3c\/h3\x3e\n\x3cp\x3e话不多说，先上代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22前端（ajax库：vue-resource）\n        userLogin:function(){\n            this.$http({\n                method:\x27post\x27,\n                url:\x27http:\/\/localhost:8089\/StockAnalyse\/LoginServlet\x27,\n                params:{\x26quot;flag\x26quot;:\x26quot;ajaxlogin\x26quot;,\x26quot;loginName\x26quot;:this.userInfo.id,\x26quot;loginPwd\x26quot;:this.userInfo.psd}, \n                headers: {\x27Content-Type\x27: \x27application\/x-www-form-urlencoded\x27}, \n                credientials:false, \n                emulateJSON: true                    \n            }).then(function(response){\n                sessionStorage.setItem(\x26quot;token\x26quot;,response.data);\n                this.isActive =false;\n                document.querySelector(\x26quot;#showInfo\x26quot;).classList.toggle(\x26quot;isLogin\x26quot;);\n            })                 \n        }\n后端相关配置：\n        response.setHeader(\x26quot;Access-Control-Allow-Origin\x26quot;, \x26quot;http:\/\/localhost\x26quot;); \/\/允许来之域名为http:\/\/localhost的请求        \n    response.setHeader(\x26quot;Access-Control-Allow-Headers\x26quot;, \x26quot;Origin,No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With, userId, token\x26quot;);\n    response.setHeader(\x26quot;Access-Control-Allow-Methods\x26quot;, \x26quot;POST, GET, OPTIONS, DELETE\x26quot;); \/\/请求允许的方法\n    response.setHeader(\x26quot;Access-Control-Max-Age\x26quot;, \x26quot;3600\x26quot;);    \/\/身份认证(预检)后，xxS以内发送请求不在需要预检，既可以直接跳过预检，进行请求(前面只是照猫画虎，后面才理解)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e前端（ajax库：vue-resource）\n        userLogin:\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$http({\n                \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x27post\x27\x3c\/span\x3e,\n                \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/localhost:8089\/StockAnalyse\/LoginServlet\x27\x3c\/span\x3e,\n                \x3cspan class=\x22hljs-attr\x22\x3eparams\x3c\/span\x3e:{\x3cspan class=\x22hljs-string\x22\x3e\x22flag\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22ajaxlogin\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22loginName\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.userInfo.id,\x3cspan class=\x22hljs-string\x22\x3e\x22loginPwd\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.userInfo.psd}, \n                \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: {\x3cspan class=\x22hljs-string\x22\x3e\x27Content-Type\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27application\/x-www-form-urlencoded\x27\x3c\/span\x3e}, \n                \x3cspan class=\x22hljs-attr\x22\x3ecredientials\x3c\/span\x3e:\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \n                \x3cspan class=\x22hljs-attr\x22\x3eemulateJSON\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e                    \n            }).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e)\x3c\/span\x3e{\n                sessionStorage.setItem(\x3cspan class=\x22hljs-string\x22\x3e\x22token\x22\x3c\/span\x3e,response.data);\n                \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isActive =\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n                \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x22#showInfo\x22\x3c\/span\x3e).classList.toggle(\x3cspan class=\x22hljs-string\x22\x3e\x22isLogin\x22\x3c\/span\x3e);\n            })                 \n        }\n后端相关配置：\n        response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Origin\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/localhost\x22\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/允许来之域名为http:\/\/localhost的请求        \x3c\/span\x3e\n    response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Headers\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22Origin,No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With, userId, token\x22\x3c\/span\x3e);\n    response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Methods\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22POST, GET, OPTIONS, DELETE\x22\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/请求允许的方法\x3c\/span\x3e\n    response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Max-Age\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x223600\x22\x3c\/span\x3e);    \x3cspan class=\x22hljs-comment\x22\x3e\/\/身份认证(预检)后，xxS以内发送请求不在需要预检，既可以直接跳过预检，进行请求(前面只是照猫画虎，后面才理解)\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e关于上面一段代码，是我的用户首次登录认证，生成token令牌，保存在sessionStorage中，供后面调用；需要说明的是，前端服务器地址是：localhost:80,后端服务器地址：localhost:8089，所以前后端涉及到跨域，自己在后端做了相应的跨域设置：response.setHeader(\x22Access-Control-Allow-Origin\x22, \x22http:\/\/localhost\x22); 所以登录认证,安全的实现了跨域信息认证，后端相应发送回来了相应的token信息。\x3cbr\x3e但获取到token后，想在需要的时候，在请求的头部携带上这个令牌，来做相应的身份认证，所以自己在请求中做了这些改动（有标注），后端没改动，源码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22        checkIdentity:function(){\n            let token =sessionStorage.getItem(\x27token\x27);\n            this.$http({\n                method:\x27post\x27,\n                url:\x27http:\/\/localhost:8089\/StockAnalyse\/LoginServlet\x27,\n                params:{\x26quot;flag\x26quot;:\x26quot;checklogin\x26quot;,\x26quot;isLogin\x26quot;:true,\x26quot;token\x26quot;:token}, \n                headers: {\x27Content-Type\x27: \x27application\/x-www-form-urlencoded\x27}, \n                headers:{\x27token\x27:token},        \/\/header中携带令牌信息            \n                credientials:false, \n                emulateJSON: true                    \n            }).then(function(response){\n                console.log(response.data);\n            })                 \n        }   \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e        checkIdentity:\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e token =sessionStorage.getItem(\x3cspan class=\x22hljs-string\x22\x3e\x27token\x27\x3c\/span\x3e);\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$http({\n                \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x27post\x27\x3c\/span\x3e,\n                \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/localhost:8089\/StockAnalyse\/LoginServlet\x27\x3c\/span\x3e,\n                \x3cspan class=\x22hljs-attr\x22\x3eparams\x3c\/span\x3e:{\x3cspan class=\x22hljs-string\x22\x3e\x22flag\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-string\x22\x3e\x22checklogin\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22isLogin\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22token\x22\x3c\/span\x3e:token}, \n                \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: {\x3cspan class=\x22hljs-string\x22\x3e\x27Content-Type\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27application\/x-www-form-urlencoded\x27\x3c\/span\x3e}, \n                \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e:{\x3cspan class=\x22hljs-string\x22\x3e\x27token\x27\x3c\/span\x3e:token},        \x3cspan class=\x22hljs-comment\x22\x3e\/\/header中携带令牌信息            \x3c\/span\x3e\n                credientials:\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \n                \x3cspan class=\x22hljs-attr\x22\x3eemulateJSON\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e                    \n            }).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e)\x3c\/span\x3e{\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(response.data);\n            })                 \n        }   \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e但实际上在devtools打印了如下错误信息：Response to preflight request doesn\x27t pass access control check: No \x27Access-Control-Allow-Origin\x27 header is present on the requested resource. Origin \x27\x3ca href=\x22http:\/\/localhost\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/localhost\x3c\/a\x3e\x27 is therefore not allowed access.仔细想一想，好像，似乎这个问题遇到过，还提过问，确实提过，\x3ca href=\x22https:\/\/segmentfault.com\/q\/1010000009255088\x22\x3e链接在这里\x3c\/a\x3e。但这次的设置和上次一样，就在header里多加了一个自定义token，但却报了和上次没有设置headers: {\x27Content-Type\x27: \x27application\/x-www-form-urlencoded\x27}一样的错误信息，于是，不知所措，算了，重头再来，好好百度，研究一下cors跨域。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e理论学习\x3c\/h3\x3e\n\x3cp\x3e运气不错，找到了\x3ca href=\x22https:\/\/developer.mozilla.org\/zh-CN\/docs\/Web\/HTTP\/Access_control_CORS\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e一篇好文\x3c\/a\x3e，文章讲的很细，也找到自己问题的所在：触发 CORS 预检请求。引用原文的话加以自己总结：跨域资源共享标准新增了一组 HTTP 首部字段，允许服务器声明哪些源站有权限访问哪些资源。另外，规范要求，对那些可能对服务器数据产生副作用的 HTTP 请求方法（特别是 GET 以外的 HTTP 请求，或者搭配某些 MIME 类型的 POST 请求），浏览器必须首先使用 OPTIONS 方法发起一个预检请求（preflight request：似曾相识有没有？诶，对，上面那个错误信息中，就有一个这样陌生的词汇），从而获知服务端是否允许该跨域请求。服务器确认允许之后，才发起实际的 HTTP 请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（包括 Cookies 和 HTTP 认证相关数据）。所以跨域请求分两种：简单请求和预检请求。一次完整的请求不需要服务端预检，直接响应的，归为简单请求；而响应前需要预检的，称为预检请求，只有预检请求通过，才有接下来的简单请求。对于那些是简单请求，那些会触发预检请求，文章做了详细的总结，这里列出触发预检请求的条件（不知道脑子为啥会想到那些会触发BFC的条件），不要跑题，原文是这样总结的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22当请求满足下述任一条件时，即应首先发送预检请求：\n使用了下面任一 HTTP 方法：\nPUT\nDELETE\nCONNECT\nOPTIONS\nTRACE\nPATCH\n人为设置了对 CORS 安全的首部字段集合之外的其他首部字段。该集合为：\nAccept\nAccept-Language\nContent-Language\nContent-Type (but note the additional requirements below)\nDPR\nDownlink\nSave-Data\nViewport-Width\nWidth\n Content-Type 的值不属于下列之一:\napplication\/x-www-form-urlencoded\nmultipart\/form-data\ntext\/plain\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs sql\x22\x3e\x3ccode\x3e当请求满足下述任一条件时，即应首先发送预检请求：\n使用了下面任一 HTTP 方法：\nPUT\n\x3cspan class=\x22hljs-keyword\x22\x3eDELETE\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eCONNECT\x3c\/span\x3e\nOPTIONS\n\x3cspan class=\x22hljs-keyword\x22\x3eTRACE\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3ePATCH\x3c\/span\x3e\n人为设置了对 CORS 安全的首部字段集合之外的其他首部字段。该集合为：\n\x3cspan class=\x22hljs-keyword\x22\x3eAccept\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eAccept\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eLanguage\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eContent\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eLanguage\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eContent\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eType\x3c\/span\x3e (but note the additional requirements below)\nDPR\nDownlink\n\x3cspan class=\x22hljs-keyword\x22\x3eSave\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eData\x3c\/span\x3e\nViewport-Width\nWidth\n \x3cspan class=\x22hljs-keyword\x22\x3eContent\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3eType\x3c\/span\x3e 的值不属于下列之一:\napplication\/x-www-\x3cspan class=\x22hljs-keyword\x22\x3eform\x3c\/span\x3e-urlencoded\nmultipart\/\x3cspan class=\x22hljs-keyword\x22\x3eform\x3c\/span\x3e-\x3cspan class=\x22hljs-keyword\x22\x3edata\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3etext\x3c\/span\x3e\/plain\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e问题分析\x3c\/h3\x3e\n\x3cp\x3e所以，再来看自己两次犯错（第一次是没有设置：headers: {\x27Content-Type\x27: \x27application\/x-www-form-urlencoded\x27}, 第二次是设置自定义header，headers:{\x27token\x27:token}。很巧，有没有，一次少，一次多，都点燃了导火索），其实都是触发了预检请求。对于第一次的错误，很好解决，增加headers: {\x27Content-Type\x27: \x27application\/x-www-form-urlencoded\x27}，就解决了，\x3ca href=\x22http:\/\/zccst.iteye.com\/blog\/2180127\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e关于Conten-Type的几种取值，你需要知道的\x3c\/a\x3e。但对于第二个错误，好像没法向第一种那样，将预检请求转变为简单请求，所以，只有寻找方法怎么在后端实现相应的预检请求，来返回一个状态码2xx，告诉浏览器此次跨域请求可以继续。所以注意力转向后端。\x3cbr\x3e关于JAVA实现预检请求，基本都是采用过滤器，不要问我为什么不是监听器或者拦截器（我就是个伪全栈，就不要相互为难了，自己百度之），自定义（copy）了一个filter,并在web.xml中进行了设置。源码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Filter接口实现部分：\npackage stock.model;\nimport java.io.IOException;   \nimport javax.servlet.Filter;\nimport javax.servlet.FilterChain;\nimport javax.servlet.FilterConfig;\nimport javax.servlet.ServletException;\nimport javax.servlet.ServletRequest;\nimport javax.servlet.ServletResponse;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;    \nimport org.apache.commons.httpclient.HttpStatus;   \/\/这里需要添加commons-httpclient-3.1.jar\npublic class CorsFilter implements Filter {     \/\/filter 接口的自定义实现\n    public void init(FilterConfig filterConfig) throws ServletException {\n    }\n    @Override\n    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {\n        HttpServletResponse response = (HttpServletResponse) servletResponse;\n        HttpServletRequest request = (HttpServletRequest) servletRequest;\n        response.setHeader(\x26quot;Access-Control-Allow-Origin\x26quot;, \x26quot;*\x26quot;);           \n        String token = request.getHeader(\x26quot;token\x26quot;);\n        System.out.println(\x26quot;filter origin:\x26quot;\x2btoken);\/\/通过打印，可以看到一次非简单请求，会被过滤两次，即请求两次，第一次请求确认是否符合跨域要求（预检），这一次是不带headers的自定义信息，第二次请求会携带自定义信息。\n        if (\x26quot;OPTIONS\x26quot;.equals(request.getMethod())){\/\/这里通过判断请求的方法，判断此次是否是预检请求，如果是，立即返回一个204状态吗，标示，允许跨域；预检后，正式请求，这个方法参数就是我们设置的post了\n          response.setStatus(HttpStatus.SC_NO_CONTENT); \/\/HttpStatus.SC_NO_CONTENT = 204\n          response.setHeader(\x26quot;Access-Control-Allow-Methods\x26quot;, \x26quot;POST, GET, DELETE, OPTIONS, DELETE\x26quot;);\/\/当判定为预检请求后，设定允许请求的方法\n          response.setHeader(\x26quot;Access-Control-Allow-Headers\x26quot;, \x26quot;Content-Type, x-requested-with, Token\x26quot;); \/\/当判定为预检请求后，设定允许请求的头部类型\n          response.addHeader(\x26quot;Access-Control-Max-Age\x26quot;, \x26quot;1\x26quot;);                           \n        }\n        filterChain.doFilter(servletRequest, servletResponse);\n    }\n    @Override\n    public void destroy() {     \n    }\n}\nweb.xml配置部分\n\x3cfilter\x3e\n\x3cfilter-name\x3ecors\x3c\/filter-name\x3e\n\x3cfilter-class\x3estock.model.CorsFilter\x3c\/filter-class\x3e\n\x3c\/filter\x3e\n\x3cfilter-mapping\x3e\n\x3cfilter-name\x3ecors\x3c\/filter-name\x3e\n\x3curl-pattern\x3e\/*\x3c\/url-pattern\x3e\n\x3c\/filter-mapping\x3e \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs swift\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-type\x22\x3eFilter\x3c\/span\x3e接口实现部分：\npackage stock.model;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e java.io.IOException;   \n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.Filter;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.FilterChain;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.FilterConfig;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.ServletException;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.ServletRequest;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.ServletResponse;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.http.HttpServletRequest;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e javax.servlet.http.HttpServletResponse;    \n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e org.apache.commons.httpclient.HttpStatus;   \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里需要添加commons-httpclient-3.1.jar\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eCorsFilter\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eimplements\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eFilter\x3c\/span\x3e \x3c\/span\x3e{     \x3cspan class=\x22hljs-comment\x22\x3e\/\/filter 接口的自定义实现\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e void \x3cspan class=\x22hljs-keyword\x22\x3einit\x3c\/span\x3e(\x3cspan class=\x22hljs-type\x22\x3eFilterConfig\x3c\/span\x3e filterConfig) \x3cspan class=\x22hljs-keyword\x22\x3ethrows\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eServletException\x3c\/span\x3e {\n    }\n    @\x3cspan class=\x22hljs-type\x22\x3eOverride\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e void doFilter(\x3cspan class=\x22hljs-type\x22\x3eServletRequest\x3c\/span\x3e servletRequest, \x3cspan class=\x22hljs-type\x22\x3eServletResponse\x3c\/span\x3e servletResponse, \x3cspan class=\x22hljs-type\x22\x3eFilterChain\x3c\/span\x3e filterChain) \x3cspan class=\x22hljs-keyword\x22\x3ethrows\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eIOException\x3c\/span\x3e, \x3cspan class=\x22hljs-type\x22\x3eServletException\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-type\x22\x3eHttpServletResponse\x3c\/span\x3e response = (\x3cspan class=\x22hljs-type\x22\x3eHttpServletResponse\x3c\/span\x3e) servletResponse;\n        \x3cspan class=\x22hljs-type\x22\x3eHttpServletRequest\x3c\/span\x3e request = (\x3cspan class=\x22hljs-type\x22\x3eHttpServletRequest\x3c\/span\x3e) servletRequest;\n        response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Origin\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22*\x22\x3c\/span\x3e);           \n        \x3cspan class=\x22hljs-type\x22\x3eString\x3c\/span\x3e token = request.getHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22token\x22\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-type\x22\x3eSystem\x3c\/span\x3e.out.\x3cspan class=\x22hljs-built_in\x22\x3eprintln\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22filter origin:\x22\x3c\/span\x3e\x2btoken);\x3cspan class=\x22hljs-comment\x22\x3e\/\/通过打印，可以看到一次非简单请求，会被过滤两次，即请求两次，第一次请求确认是否符合跨域要求（预检），这一次是不带headers的自定义信息，第二次请求会携带自定义信息。\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-string\x22\x3e\x22OPTIONS\x22\x3c\/span\x3e.equals(request.getMethod())){\x3cspan class=\x22hljs-comment\x22\x3e\/\/这里通过判断请求的方法，判断此次是否是预检请求，如果是，立即返回一个204状态吗，标示，允许跨域；预检后，正式请求，这个方法参数就是我们设置的post了\x3c\/span\x3e\n          response.setStatus(\x3cspan class=\x22hljs-type\x22\x3eHttpStatus\x3c\/span\x3e.\x3cspan class=\x22hljs-type\x22\x3eSC_NO_CONTENT\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/HttpStatus.SC_NO_CONTENT = 204\x3c\/span\x3e\n          response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Methods\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22POST, GET, DELETE, OPTIONS, DELETE\x22\x3c\/span\x3e);\x3cspan class=\x22hljs-comment\x22\x3e\/\/当判定为预检请求后，设定允许请求的方法\x3c\/span\x3e\n          response.setHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Allow-Headers\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22Content-Type, x-requested-with, Token\x22\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/当判定为预检请求后，设定允许请求的头部类型\x3c\/span\x3e\n          response.addHeader(\x3cspan class=\x22hljs-string\x22\x3e\x22Access-Control-Max-Age\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x221\x22\x3c\/span\x3e);                           \n        }\n        filterChain.doFilter(servletRequest, servletResponse);\n    }\n    @\x3cspan class=\x22hljs-type\x22\x3eOverride\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e void destroy() {     \n    }\n}\nweb.xml配置部分\n\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3efilter\x3c\/span\x3e\x26gt;\n\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3efilter\x3c\/span\x3e-name\x26gt;cors\x26lt;\/\x3cspan class=\x22hljs-built_in\x22\x3efilter\x3c\/span\x3e-name\x26gt;\n\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e\x26gt;\x3cspan class=\x22hljs-title\x22\x3estock\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3emodel\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eCorsFilter\x3c\/span\x3e\x26lt;\/\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3eclass\x3c\/span\x3e\x26gt;\n\x26lt;\/\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e\x26gt;\n\x26lt;\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3emapping\x3c\/span\x3e\x26gt;\n\x26lt;\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3ename\x3c\/span\x3e\x26gt;\x3cspan class=\x22hljs-title\x22\x3ecors\x3c\/span\x3e\x26lt;\/\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3ename\x3c\/span\x3e\x26gt;\n\x26lt;\x3cspan class=\x22hljs-title\x22\x3eurl\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3epattern\x3c\/span\x3e\x26gt;\/*\x26lt;\/\x3cspan class=\x22hljs-title\x22\x3eurl\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3epattern\x3c\/span\x3e\x26gt;\n\x26lt;\/\x3cspan class=\x22hljs-title\x22\x3efilter\x3c\/span\x3e-\x3cspan class=\x22hljs-title\x22\x3emapping\x3c\/span\x3e\x26gt; \x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e结论\x3c\/h3\x3e\n\x3cp\x3e当在后端实现添加上面的源码后，皆大欢喜，问题得以解决，补上失败和成功,自己截下的两张请求响应图。\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVPZ8K?w=1470\x26amp;h=1123\x22 src=\x22https:\/\/static.alili.tech\/img\/bVPZ8K?w=1470\x26amp;h=1123\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e仔细看请求响应失败发起响应那张图，在General的数据集中，可以看到方法是options，而非代码指定的post请求，所以这是一次浏览器发出的一次预检请求，让服务器确认此IP是否有访问的权限，如果有，服务器需要返回一个2xx的状态码给浏览器。紧接着再发起一次简单请求。如下面在devtools中的截取图片（为了对比清除，我把两次分别截取，做了拼接，因为不会做动态图）。可以看到同一个post请求，实际上产生了两次网络连接。\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVP7FU?w=1235\x26amp;h=742\x22 src=\x22https:\/\/static.alili.tech\/img\/bVP7FU?w=1235\x26amp;h=742\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e但关于cors,要去探索的，还有很多很多，所以遵循革命语录：实践（有时也可以是时间）是检验真理的唯一标准，是没有错的。后续有新的收获，再补充。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>cors跨域之简单请求与预检请求（发送请求头带令牌token）</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009971254">https://segmentfault.com/a/1190000009971254</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/a8gzczukyqo/" target="_blank">https://alili.tech/archive/a8gzczukyqo/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>